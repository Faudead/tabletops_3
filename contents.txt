ROOT: "D:\Projects\games\site-fondry\tabletops_3"
GENERATED: 2026-02-14 21:32:04

====== CODE CONTENTS ======
Included extensions: .bat .conf .css .env .htaccess .htm .html .ini .java .js .json .jsx .less .php .phtml .py .rb .sass .scss .sh .sql .ts .tsx .xml .yaml .yml
Max file size: 1048576 bytes

======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\admin_spell_edit.php
MODIFIED: 2026-02-14 20:28:38 | SIZE: 7142 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

$user = require_admin();
$pdo = db();

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;

$spell = [
  'slug' => '',
  'name' => '',
  'level' => 0,
  'school' => '',
  'casting_time' => '',
  'range_txt' => '',
  'duration' => '',
  'components' => '',
  'base_ref' => 'PHB',
  'base_summary' => '',
  'override_text' => '',
  'is_published' => 1,
];

if ($id > 0) {
  $st = $pdo->prepare("SELECT * FROM spells WHERE id=? LIMIT 1");
  $st->execute([$id]);
  $row = $st->fetch();
  if (!$row) { http_response_code(404); echo "Not found"; exit; }
  $spell = array_merge($spell, $row);
}

$err = '';

function slugify(string $s): string {
  $s = strtolower(trim($s));
  $s = preg_replace('/[^a-z0-9]+/', '-', $s) ?? '';
  $s = trim($s, '-');
  return $s;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $action = (string)($_POST['action'] ?? 'save');

  if ($action === 'delete' && $id > 0) {
    $st = $pdo->prepare("DELETE FROM spells WHERE id=?");
    $st->execute([$id]);
    header('Location: /admin_spells.php');
    exit;
  }

  $name = trim((string)($_POST['name'] ?? ''));
  $slug = trim((string)($_POST['slug'] ?? ''));
  $slug = $slug !== '' ? $slug : slugify($name);

  $level = (int)($_POST['level'] ?? 0);

  if ($slug === '' || !preg_match('/^[a-z0-9-]{2,190}$/', $slug)) {
    $err = 'Slug: —Ç—ñ–ª—å–∫–∏ a-z, 0-9, –¥–µ—Ñ—ñ—Å. (–º—ñ–Ω 2 —Å–∏–º–≤–æ–ª–∏)';
  } elseif ($name === '') {
    $err = 'Name –æ–±–æ–≤ º—è–∑–∫–æ–≤–µ.';
  } elseif ($level < 0 || $level > 9) {
    $err = 'Level –º–∞—î –±—É—Ç–∏ 0..9.';
  } else {
    $data = [
      'slug' => $slug,
      'name' => $name,
      'level' => $level,
      'school' => trim((string)($_POST['school'] ?? '')),
      'casting_time' => trim((string)($_POST['casting_time'] ?? '')),
      'range_txt' => trim((string)($_POST['range_txt'] ?? '')),
      'duration' => trim((string)($_POST['duration'] ?? '')),
      'components' => trim((string)($_POST['components'] ?? '')),
      'base_ref' => trim((string)($_POST['base_ref'] ?? '')),
      'base_summary' => (string)($_POST['base_summary'] ?? ''),
      'override_text' => (string)($_POST['override_text'] ?? ''),
      'is_published' => isset($_POST['is_published']) ? 1 : 0,
    ];

    try {
      if ($id > 0) {
        $st = $pdo->prepare("
          UPDATE spells SET
            slug=:slug, name=:name, level=:level, school=:school,
            casting_time=:casting_time, range_txt=:range_txt, duration=:duration, components=:components,
            base_ref=:base_ref, base_summary=:base_summary, override_text=:override_text,
            is_published=:is_published
          WHERE id=:id
        ");
        $data['id'] = $id;
        $st->execute($data);
      } else {
        $st = $pdo->prepare("
          INSERT INTO spells
            (slug,name,level,school,casting_time,range_txt,duration,components,base_ref,base_summary,override_text,is_published)
          VALUES
            (:slug,:name,:level,:school,:casting_time,:range_txt,:duration,:components,:base_ref,:base_summary,:override_text,:is_published)
        ");
        $st->execute($data);
        $id = (int)$pdo->lastInsertId();
      }

      header('Location: /admin_spells.php');
      exit;

    } catch (PDOException $e) {
      // –Ω–∞–π—á–∞—Å—Ç—ñ—à–µ: –¥—É–±–ª—å slug
      $err = 'DB error: ' . $e->getCode();
    }

    $spell = array_merge($spell, $data);
  }
}
?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>Admin Spell</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:1100px;margin:20px auto;padding:0 12px}
    input,textarea,select,button{padding:6px 8px;width:100%;box-sizing:border-box}
    textarea{font-family:ui-monospace,Consolas,monospace}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px}
    .row{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center;margin:8px 0}
    .err{color:#b00020}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .actions button{width:auto}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} .row{grid-template-columns:1fr} }
  </style>
</head>
<body>
<?php require_once __DIR__ . '/inc/nav.php'; ?>

<h1>Admin: Spell <?= $id>0 ? "#$id" : "NEW" ?></h1>
<?php if ($err): ?><p class="err"><?= htmlspecialchars($err) ?></p><?php endif; ?>

<form method="post">
  <div class="card">
    <div class="grid">
      <div>
        <div class="row"><label>Name</label><input name="name" value="<?= htmlspecialchars((string)$spell['name']) ?>" required></div>
        <div class="row"><label>Slug</label><input name="slug" value="<?= htmlspecialchars((string)$spell['slug']) ?>" placeholder="auto from name"></div>
        <div class="row"><label>Level</label><input name="level" type="number" min="0" max="9" value="<?= (int)$spell['level'] ?>"></div>
        <div class="row"><label>School</label><input name="school" value="<?= htmlspecialchars((string)$spell['school']) ?>"></div>
      </div>
      <div>
        <div class="row"><label>Casting</label><input name="casting_time" value="<?= htmlspecialchars((string)$spell['casting_time']) ?>"></div>
        <div class="row"><label>Range</label><input name="range_txt" value="<?= htmlspecialchars((string)$spell['range_txt']) ?>"></div>
        <div class="row"><label>Duration</label><input name="duration" value="<?= htmlspecialchars((string)$spell['duration']) ?>"></div>
        <div class="row"><label>Components</label><input name="components" value="<?= htmlspecialchars((string)$spell['components']) ?>"></div>
      </div>
    </div>

    <div class="row"><label>Base ref</label><input name="base_ref" value="<?= htmlspecialchars((string)$spell['base_ref']) ?>" placeholder="PHB p.241"></div>

    <div class="grid">
      <div class="card">
        <h2>Base summary (your words)</h2>
        <textarea name="base_summary" rows="10"><?= htmlspecialchars((string)$spell['base_summary']) ?></textarea>
      </div>
      <div class="card">
        <h2>Campaign changes</h2>
        <textarea name="override_text" rows="10"><?= htmlspecialchars((string)$spell['override_text']) ?></textarea>
      </div>
    </div>

    <div style="margin-top:10px">
      <label>
        <input type="checkbox" name="is_published" <?= ((int)$spell['is_published'] === 1 ? 'checked' : '') ?>>
        Published (visible for players)
      </label>
    </div>

    <div class="actions">
      <button type="submit" name="action" value="save">Save</button>
      <?php if ($id>0): ?>
        <button type="submit" name="action" value="delete" onclick="return confirm('Delete this spell?')">Delete</button>
      <?php endif; ?>
      <a href="/admin_spells.php">Back to list</a>
      <a href="/dashboard.php">Dashboard</a>
    </div>
  </div>
</form>
</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\admin_spell_import.php
MODIFIED: 2026-02-14 20:28:49 | SIZE: 7721 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

$user = require_admin();

function slugify(string $s): string {
  $s = mb_strtolower(trim($s), 'UTF-8');
  // —Ç—Ä–∞–Ω—Å–ª—ñ—Ç–µ—Ä–∞—Ü—ñ—è —É–∫—Ä ‚Üí –ª–∞—Ç (–ø—Ä–æ—Å—Ç–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç)
  $map = [
    '–∞'=>'a','–±'=>'b','–≤'=>'v','–≥'=>'h','“ë'=>'g','–¥'=>'d','–µ'=>'e','—î'=>'ie','–∂'=>'zh','–∑'=>'z','–∏'=>'y','—ñ'=>'i','—ó'=>'i','–π'=>'i',
    '–∫'=>'k','–ª'=>'l','–º'=>'m','–Ω'=>'n','–æ'=>'o','–ø'=>'p','—Ä'=>'r','—Å'=>'s','—Ç'=>'t','—É'=>'u','—Ñ'=>'f','—Ö'=>'kh','—Ü'=>'ts','—á'=>'ch',
    '—à'=>'sh','—â'=>'shch','—å'=>'','—é'=>'iu','—è'=>'ia','\''=>'','‚Äô'=>'','"'=>'',
  ];
  $out = '';
  $chars = preg_split('//u', $s, -1, PREG_SPLIT_NO_EMPTY);
  foreach ($chars as $ch) {
    $out .= $map[$ch] ?? $ch;
  }
  $out = preg_replace('~[^a-z0-9]+~', '-', $out) ?? '';
  $out = trim($out, '-');
  if ($out === '') $out = 'spell';
  return substr($out, 0, 190);
}

function h(string $s): string {
  return htmlspecialchars($s, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8');
}

$pdo = db();
$mode = (string)($_POST['mode'] ?? '');
$msg = '';
$err = '';
$preview = [];
$stats = ['total'=>0,'ok'=>0,'skipped'=>0];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  if (!isset($_FILES['json']) || $_FILES['json']['error'] !== UPLOAD_ERR_OK) {
    $err = '–§–∞–π–ª –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.';
  } else {
    $raw = file_get_contents($_FILES['json']['tmp_name']);
    $data = json_decode($raw ?: '', true);

    if (!is_array($data)) {
      $err = 'JSON –Ω–µ —Å—Ö–æ–∂–∏–π –Ω–∞ –º–∞—Å–∏–≤.';
    } else {
      // preview –±–µ—Ä–µ–º–æ –ø–µ—Ä—à—ñ 20
      $preview = array_slice($data, 0, 20);
      $stats['total'] = count($data);

      if ($mode === 'import') {
        $pdo->beginTransaction();
        try {
          $ins = $pdo->prepare("
            INSERT INTO spells
              (slug, name, level, school, casting_time, range_txt, duration, components, base_ref, base_summary, override_text, is_published)
            VALUES
              (:slug, :name, :level, :school, :casting_time, :range_txt, :duration, :components, :base_ref, :base_summary, :override_text, :is_published)
            ON DUPLICATE KEY UPDATE
              name=VALUES(name),
              level=VALUES(level),
              school=VALUES(school),
              casting_time=VALUES(casting_time),
              range_txt=VALUES(range_txt),
              duration=VALUES(duration),
              components=VALUES(components),
              base_ref=VALUES(base_ref),
              base_summary=VALUES(base_summary),
              is_published=VALUES(is_published)
          ");

          foreach ($data as $row) {
            if (!is_array($row)) { $stats['skipped']++; continue; }

            $name = trim((string)($row['name'] ?? ''));
            if ($name === '') { $stats['skipped']++; continue; }

            // slug: –∞–±–æ –∑ JSON, –∞–±–æ –≥–µ–Ω–µ—Ä—É—î–º–æ –∑ name
            $slug = trim((string)($row['slug'] ?? ''));
            if ($slug === '') $slug = slugify($name);

            $level = (int)($row['level'] ?? 0);
            $school = trim((string)($row['school'] ?? ''));
            $casting = trim((string)($row['casting_time'] ?? ''));
            $range = trim((string)($row['range'] ?? ''));
            $duration = trim((string)($row['duration'] ?? ''));
            $components = trim((string)($row['components'] ?? ''));

            // —Ç–≤–æ—î ‚Äúbase vs changes‚Äù:
            $base_ref = 'PHB';
            if (!empty($row['source'])) {
              $base_ref = 'PHB (' . trim((string)$row['source']) . ')';
            }
            // description –∫–ª–∞–¥–µ–º–æ –≤ base_summary (–ø–æ—Ç—ñ–º —Ç–∏ –º–æ–∂–µ—à —Å–∫–æ—Ä–æ—á—É–≤–∞—Ç–∏ –≤—Ä—É—á–Ω—É)
            $base_summary = (string)($row['description'] ?? '');
            $override_text = ''; // —Ä–µ–±–∞–ª–∞–Ω—Å –∑–∞–ø–æ–≤–Ω–∏—à –≤ –∞–¥–º—ñ–Ω—Ü—ñ
            $is_published = 1;

            $ins->execute([
              ':slug' => $slug,
              ':name' => $name,
              ':level' => max(0, min(9, $level)),
              ':school' => $school,
              ':casting_time' => $casting,
              ':range_txt' => $range,
              ':duration' => $duration,
              ':components' => $components,
              ':base_ref' => $base_ref,
              ':base_summary' => $base_summary,
              ':override_text' => $override_text,
              ':is_published' => $is_published,
            ]);

            $stats['ok']++;
          }

          $pdo->commit();
          $msg = "–Ü–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ: {$stats['ok']} / {$stats['total']} (skipped {$stats['skipped']}).";
        } catch (Throwable $e) {
          $pdo->rollBack();
          $err = "–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: " . $e->getMessage();
        }
      } else {
        $msg = "Preview: –ø–æ–∫–∞–∑–∞–Ω–æ –ø–µ—Ä—à—ñ " . count($preview) . " –∑ {$stats['total']}. –ù–∞—Ç–∏—Å–Ω–∏ Import, —â–æ–± –∑–∞–ª–∏—Ç–∏/–æ–Ω–æ–≤–∏—Ç–∏.";
      }
    }
  }
}
?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>–ê–¥–º—ñ–Ω: –Ü–º–ø–æ—Ä—Ç –∑–∞–∫–ª–∏–Ω–∞–Ω—å (JSON)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:1100px;margin:20px auto;padding:0 12px}
    input,button{padding:8px 10px}
    .ok{color:#0a7a0a}
    .err{color:#b00020}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    th,td{border:1px solid #ddd;padding:6px;vertical-align:top}
    th{background:#f6f6f6;text-align:left}
    .muted{opacity:.75}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
<?php require_once __DIR__ . '/inc/nav.php'; ?>

<h1>–ê–¥–º—ñ–Ω: –Ü–º–ø–æ—Ä—Ç –∑–∞–∫–ª–∏–Ω–∞–Ω—å (JSON)</h1>
<p class="muted">–î–æ—Å—Ç—É–ø —Ç—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—É. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ñ–∞–π–ª –ø—ñ—Å–ª—è —ñ–º–ø–æ—Ä—Ç—É.</p>

<?php if ($msg): ?><p class="ok"><?= h($msg) ?></p><?php endif; ?>
<?php if ($err): ?><p class="err"><?= h($err) ?></p><?php endif; ?>

<form method="post" enctype="multipart/form-data" class="row">
  <input type="file" name="json" accept=".json,application/json" required>
  <button type="submit" name="mode" value="preview">Preview</button>
  <button type="submit" name="mode" value="import" onclick="return confirm('–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏/–æ–Ω–æ–≤–∏—Ç–∏ –≤—Å—ñ –∑–∞–ø–∏—Å–∏ –∑ —Ü—å–æ–≥–æ JSON?')">Import/Update</button>
  <a href="/dashboard.php">Dashboard</a>
</form>

<?php if ($preview): ?>
  <h2>Preview (–ø–µ—Ä—à—ñ <?= (int)count($preview) ?>)</h2>
  <table>
    <tr>
      <th>Name</th><th>Level</th><th>School</th><th>Casting</th><th>Range</th><th>Duration</th><th>Components</th>
      <th class="muted">Desc (–ø–æ—á–∞—Ç–æ–∫)</th>
    </tr>
    <?php foreach ($preview as $r): ?>
      <?php
        $name = (string)($r['name'] ?? '');
        $desc = (string)($r['description'] ?? '');
      ?>
      <tr>
        <td><?= h($name) ?></td>
        <td><?= (int)($r['level'] ?? 0) ?></td>
        <td><?= h((string)($r['school'] ?? '')) ?></td>
        <td><?= h((string)($r['casting_time'] ?? '')) ?></td>
        <td><?= h((string)($r['range'] ?? '')) ?></td>
        <td><?= h((string)($r['duration'] ?? '')) ?></td>
        <td><?= h((string)($r['components'] ?? '')) ?></td>
        <td class="muted"><?= h(mb_substr($desc, 0, 120, 'UTF-8')) ?><?= mb_strlen($desc, 'UTF-8')>120 ? '‚Ä¶' : '' ?></td>
      </tr>
    <?php endforeach; ?>
  </table>
<?php endif; ?>

</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\admin_spells.php
MODIFIED: 2026-02-14 20:29:09 | SIZE: 5868 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

$user = require_admin();


$q      = trim((string)($_GET['q'] ?? ''));
$level  = trim((string)($_GET['level'] ?? ''));
$school = trim((string)($_GET['school'] ?? ''));
$pub    = trim((string)($_GET['pub'] ?? 'all')); // all|pub|hidden
$sort   = trim((string)($_GET['sort'] ?? 'name'));
$dir    = strtolower(trim((string)($_GET['dir'] ?? 'asc')));

$allowedSort = ['name', 'level', 'school', 'updated_at'];
if (!in_array($sort, $allowedSort, true)) $sort = 'name';
if (!in_array($dir, ['asc','desc'], true)) $dir = 'asc';
if (!in_array($pub, ['all','pub','hidden'], true)) $pub = 'all';

$where = "WHERE 1=1";
$params = [];

if ($q !== '') {
  $where .= " AND name LIKE ?";
  $params[] = "%{$q}%";
}
if ($level !== '' && ctype_digit($level)) {
  $where .= " AND level = ?";
  $params[] = (int)$level;
}
if ($school !== '') {
  $where .= " AND school = ?";
  $params[] = $school;
}
if ($pub === 'pub') {
  $where .= " AND is_published=1";
} elseif ($pub === 'hidden') {
  $where .= " AND is_published=0";
}

$collate = " COLLATE utf8mb4_unicode_ci ";

if ($sort === 'name') {
  $order = "ORDER BY name{$collate} {$dir}";
} elseif ($sort === 'school') {
  $order = "ORDER BY school{$collate} {$dir}, name{$collate} asc";
} elseif ($sort === 'level') {
  $order = "ORDER BY level {$dir}, name{$collate} asc";
} else { // updated_at
  $order = "ORDER BY updated_at {$dir}";
}

$sql = "SELECT id, slug, name, level, school, is_published, override_text, updated_at
        FROM spells {$where} {$order}";
$stmt = db()->prepare($sql);
$stmt->execute($params);
$rows = $stmt->fetchAll();

$schools = db()->query("SELECT DISTINCT school FROM spells WHERE school<>'' ORDER BY school COLLATE utf8mb4_unicode_ci")->fetchAll();
?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>–ê–¥–º—ñ–Ω: –ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:1100px;margin:20px auto;padding:0 12px}
    input,select,button{padding:6px 8px}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    th,td{border:1px solid #ddd;padding:6px;vertical-align:top}
    th{background:#f6f6f6;text-align:left}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .muted{opacity:.75}
    .badge{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:1px 7px;font-size:12px;opacity:.85}
    .warn{border-color:#f0c36d;background:#fff9e6}
  </style>
</head>
<body>
<?php require_once __DIR__ . '/inc/nav.php'; ?>

<h1>–ê–¥–º—ñ–Ω: –ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è</h1>

<p>
  <a href="/admin_spell_edit.php">+ –î–æ–¥–∞—Ç–∏</a> ¬∑
  <a href="/admin_spell_import.php">–Ü–º–ø–æ—Ä—Ç JSON</a> ¬∑
  <a href="/dashboard.php">–ö–∞–±—ñ–Ω–µ—Ç</a>
</p>

<form method="get" class="row">
  <input name="q" placeholder="–ø–æ—à—É–∫..." value="<?= htmlspecialchars($q) ?>">

  <select name="level">
    <option value="">–±—É–¥—å-—è–∫–∏–π —Ä—ñ–≤–µ–Ω—å</option>
    <?php for ($i=0; $i<=9; $i++): ?>
      <option value="<?= $i ?>" <?= ($level===(string)$i ? 'selected' : '') ?>><?= $i ?></option>
    <?php endfor; ?>
  </select>

  <select name="school">
    <option value="">–±—É–¥—å-—è–∫–∞ —à–∫–æ–ª–∞</option>
    <?php foreach ($schools as $s): ?>
      <option value="<?= htmlspecialchars((string)$s['school']) ?>" <?= ($school===(string)$s['school'] ? 'selected' : '') ?>>
        <?= htmlspecialchars((string)$s['school']) ?>
      </option>
    <?php endforeach; ?>
  </select>

  <select name="pub">
    <option value="all"    <?= ($pub==='all'?'selected':'') ?>>–≤—Å—ñ</option>
    <option value="pub"    <?= ($pub==='pub'?'selected':'') ?>>—Ç—ñ–ª—å–∫–∏ published</option>
    <option value="hidden" <?= ($pub==='hidden'?'selected':'') ?>>—Ç—ñ–ª—å–∫–∏ hidden</option>
  </select>

  <select name="sort">
    <option value="name"       <?= ($sort==='name'?'selected':'') ?>>—Å–æ—Ä—Ç—É–≤–∞—Ç–∏: –Ω–∞–∑–≤–∞</option>
    <option value="level"      <?= ($sort==='level'?'selected':'') ?>>—Å–æ—Ä—Ç—É–≤–∞—Ç–∏: —Ä—ñ–≤–µ–Ω—å</option>
    <option value="school"     <?= ($sort==='school'?'selected':'') ?>>—Å–æ—Ä—Ç—É–≤–∞—Ç–∏: —à–∫–æ–ª–∞</option>
    <option value="updated_at" <?= ($sort==='updated_at'?'selected':'') ?>>—Å–æ—Ä—Ç—É–≤–∞—Ç–∏: –æ–Ω–æ–≤–ª–µ–Ω–æ</option>
  </select>

  <select name="dir">
    <option value="asc"  <?= ($dir==='asc'?'selected':'') ?>>‚Üë</option>
    <option value="desc" <?= ($dir==='desc'?'selected':'') ?>>‚Üì</option>
  </select>

  <button type="submit">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>

  <?php if ($q!=='' || $level!=='' || $school!=='' || $pub!=='all' || $sort!=='name' || $dir!=='asc'): ?>
    <a class="muted" href="/admin_spells.php">—Å–∫–∏–Ω—É—Ç–∏</a>
  <?php endif; ?>
</form>

<p class="muted">–ó–Ω–∞–π–¥–µ–Ω–æ: <?= count($rows) ?></p>

<table>
  <tr>
    <th>Name</th><th>Lvl</th><th>School</th><th>Slug</th><th>Status</th><th>Updated</th><th>Actions</th>
  </tr>
  <?php foreach ($rows as $r): ?>
    <?php $modified = trim((string)$r['override_text']) !== ''; ?>
    <tr>
      <td>
        <?= htmlspecialchars((string)$r['name']) ?>
        <?php if ($modified): ?><span class="badge warn">modified</span><?php endif; ?>
      </td>
      <td><?= (int)$r['level'] ?></td>
      <td><?= htmlspecialchars((string)$r['school']) ?></td>
      <td><?= htmlspecialchars((string)$r['slug']) ?></td>
      <td><?= ((int)$r['is_published']===1) ? 'published' : 'hidden' ?></td>
      <td class="muted"><?= htmlspecialchars((string)$r['updated_at']) ?></td>
      <td><a href="/admin_spell_edit.php?id=<?= (int)$r['id'] ?>">edit</a></td>
    </tr>
  <?php endforeach; ?>
</table>

</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\character.php
MODIFIED: 2026-02-14 21:21:22 | SIZE: 41396 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

require_login();
$user = current_user();
$uid  = (int)($user['id'] ?? 0);
$role = (string)($user['role'] ?? 'user');

$charId = isset($_GET['id']) ? (int)$_GET['id'] : 0;
if ($charId <= 0) { http_response_code(400); echo "Missing id"; exit; }

$stmt = db()->prepare("SELECT * FROM characters WHERE id=?");
$stmt->execute([$charId]);
$ch = $stmt->fetch();
if (!$ch) { http_response_code(404); echo "Not found"; exit; }

// access: admin OR owner OR shared
$canEdit = false;

if ($role === 'admin' || (int)$ch['owner_user_id'] === $uid) {
  $canEdit = true;
} else {
  $accSt = db()->prepare("
    SELECT can_edit
    FROM character_access
    WHERE character_id=? AND user_id=?
    LIMIT 1
  ");
  $accSt->execute([$charId, $uid]);
  $acc = $accSt->fetch();

  if (!$acc) {
    http_response_code(403);
    echo "Forbidden";
    exit;
  }

  $canEdit = ((int)$acc['can_edit'] === 1);
}

$st = db()->prepare("SELECT * FROM character_stats WHERE character_id=?");
$st->execute([$charId]);
$stats = $st->fetch() ?: [];

$rs = db()->prepare("SELECT * FROM character_resources WHERE character_id=?");
$rs->execute([$charId]);
$res = $rs->fetch() ?: [];

$cc = db()->prepare("SELECT * FROM character_coins WHERE character_id=?");
$cc->execute([$charId]);
$coins = $cc->fetch() ?: [];

$inv = db()->prepare("SELECT * FROM character_inventory WHERE character_id=? ORDER BY sort_order,id");
$inv->execute([$charId]);
$inventory = $inv->fetchAll();

$wp = db()->prepare("SELECT * FROM character_weapons WHERE character_id=? ORDER BY sort_order,id");
$wp->execute([$charId]);
$weapons = $wp->fetchAll();

$sp = db()->prepare("SELECT * FROM character_spells WHERE character_id=? ORDER BY sort_order,id");
$sp->execute([$charId]);
$spells = $sp->fetchAll();

$ab = db()->prepare("SELECT * FROM character_abilities WHERE character_id=? ORDER BY sort_order,id");
$ab->execute([$charId]);
$abilities = $ab->fetchAll();

$shared = [];
if ($role === 'admin') {
  $st2 = db()->prepare("
    SELECT a.user_id, a.can_edit, u.username
    FROM character_access a
    JOIN users u ON u.id = a.user_id
    WHERE a.character_id=?
    ORDER BY u.username
  ");
  $st2->execute([$charId]);
  $shared = $st2->fetchAll();
}

function h($v): string { return htmlspecialchars((string)$v, ENT_QUOTES, 'UTF-8'); }
function stat_mod(int $score): int { return (int)floor(($score - 10) / 2); }
function fmt_mod(int $m): string { return ($m >= 0 ? '+' : '') . (string)$m; }

$pb = (int)($res['proficiency_bonus'] ?? 2);

// avatar src
$avatarSrc = '';
$avatarData = trim((string)($ch['avatar_data'] ?? ''));
$avatarUrl  = trim((string)($ch['avatar_url'] ?? ''));

if ($avatarData !== '') {
  // if already contains data:... keep it, else assume base64 png
  $avatarSrc = (str_starts_with($avatarData, 'data:'))
    ? $avatarData
    : ('data:image/png;base64,' . $avatarData);
} elseif ($avatarUrl !== '') {
  $avatarSrc = $avatarUrl;
}

// display strings like in reference
$displayName = (string)($ch['name'] ?? '‚Äî');
$displayClass = trim((string)($ch['class_name'] ?? ''));
$displayLevel = (int)($ch['level'] ?? 1);
$displayRace  = trim((string)($ch['race'] ?? ''));
$classLevelDisplay = trim(($displayClass !== '' ? $displayClass : '‚Äî') . ' ‚Ä¢ L' . $displayLevel . ($displayRace !== '' ? (' ‚Ä¢ ' . $displayRace) : ''));

?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/inc/char.css">
  <title><?= h($ch['name']) ?></title>
</head>
<body>
<?php require_once __DIR__ . '/inc/nav.php'; ?>

<!-- ===== TOPBAR (reference-like) ===== -->
<header class="topbar">
  <div class="brand">Char Sheet</div>
  <div class="actions">
    <input
      id="saveMessage"
      name="save_message"
      form="charForm"
      placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è (–Ω–∞–ø—Ä. Session 1 / Level up)"
      <?= $canEdit ? '' : 'disabled' ?>
    />

    <?php if ($canEdit): ?>
      <button type="submit" form="charForm">Save</button>
    <?php else: ?>
      <span class="badge">read-only</span>
    <?php endif; ?>

    <a href="/characters.php"><button type="button" class="secondary">‚Üê back</button></a>
  </div>
</header>

<?php if ($role === 'admin'): ?>
  <section class="card" style="margin:12px 24px 0 24px;">
    <h2>–î–æ—Å—Ç—É–ø –¥–æ —á–∞—Ä–Ω–∏–∫–∞</h2>

    <form method="post" action="/api/character_share.php" style="display:flex; gap:10px; flex-wrap:wrap; align-items:end;">
      <input type="hidden" name="character_id" value="<?= (int)$charId ?>">

      <label>
        Username –∫–æ–º—É –≤–∏–¥–∞—Ç–∏
        <input name="username" placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: nika" required>
      </label>

      <label style="display:flex; gap:6px; align-items:center; margin-bottom:6px;">
        <input type="checkbox" name="can_edit" value="1">
        –º–æ–∂–µ —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏
      </label>

      <button type="submit">–í–∏–¥–∞—Ç–∏/–æ–Ω–æ–≤–∏—Ç–∏ –¥–æ—Å—Ç—É–ø</button>
    </form>

    <?php if (!empty($shared)): ?>
      <h3 style="margin-top:12px;">–í–∂–µ –º–∞—é—Ç—å –¥–æ—Å—Ç—É–ø</h3>
      <ul>
        <?php foreach ($shared as $s): ?>
          <li style="margin:6px 0;">
            <b><?= h($s['username']) ?></b>
            ‚Äî <?= ((int)$s['can_edit']===1) ? 'edit' : 'view' ?>

            <form method="post" action="/api/character_unshare.php" style="display:inline;">
              <input type="hidden" name="character_id" value="<?= (int)$charId ?>">
              <input type="hidden" name="user_id" value="<?= (int)$s['user_id'] ?>">
              <button type="submit" onclick="return confirm('–ó–∞–±—Ä–∞—Ç–∏ –¥–æ—Å—Ç—É–ø —É <?= h($s['username']) ?>?')">–∑–∞–±—Ä–∞—Ç–∏</button>
            </form>
          </li>
        <?php endforeach; ?>
      </ul>
    <?php else: ?>
      <p style="opacity:.75; margin-top:10px;">–ü–æ–∫–∏ –Ω—ñ–∫–æ–º—É –Ω–µ –≤–∏–¥–∞–Ω–æ –¥–æ—Å—Ç—É–ø.</p>
    <?php endif; ?>
  </section>
<?php endif; ?>

<form id="charForm" method="post" action="/api/character_save.php?id=<?= (int)$charId ?>" <?= $canEdit ? '' : 'aria-disabled="true"' ?>>

  <main class="shell">

    <!-- LEFT (reference-like: avatar + notes + history) -->
    <aside class="sidebar-left">

      <section class="card">
        <div class="profile" style="display:flex; gap:12px; align-items:center;">
          <div class="avatarWrap" id="avatarDrop" title="–ö–ª—ñ–∫ ‚Äî –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏. Ctrl+V ‚Äî –≤—Å—Ç–∞–≤–∏—Ç–∏." style="width:86px; height:86px; border-radius:16px; border:1px dashed var(--border); position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center; background:var(--panel-soft); cursor:pointer;">
            <img
              alt="avatar"
              class="avatar"
              id="avatarImg"
              src="<?= h($avatarSrc) ?>"
              style="<?= $avatarSrc !== '' ? '' : 'display:none;' ?> width:100%; height:100%; object-fit:cover;"
            />
            <div class="avatarFallback" id="avatarFallback" style="<?= $avatarSrc === '' ? '' : 'display:none;' ?> text-align:center; padding:10px;">
              <div class="avatarHint">
                <div class="avatarHintTitle" style="font-weight:600; color:var(--text);">Avatar</div>
                <div class="avatarHintSub" style="font-size:12px; color:var(--muted); margin-top:4px;">Click to upload ‚Ä¢ Ctrl+V to paste</div>
              </div>
            </div>

            <input accept="image/*" class="avatarFileHidden" id="avatarFile" type="file" style="display:none"/>
          </div>

          <div class="profile-text" style="min-width:0;">
            <div class="name" id="nameDisplay" style="font-size:16px; font-weight:600;"><?= h($displayName) ?></div>
            <div class="sub" id="classLevelDisplay" style="font-size:13px; color:var(--muted); margin-top:4px;"><?= h($classLevelDisplay) ?></div>
          </div>
        </div>

        <!-- store avatar fields for API -->
        <input type="hidden" name="avatar_url" id="avatarUrlHidden" value="<?= h($avatarUrl) ?>">
        <input type="hidden" name="avatar_data" id="avatarDataHidden" value="<?= h($avatarData) ?>">

        <!-- URL block only when no avatar -->
        <div id="avatarUrlBlock" style="<?= ($avatarSrc === '') ? '' : 'display:none;' ?> margin-top:12px;">
          <label>Avatar URL / local path
            <input id="avatarUrl" placeholder="https://... –∞–±–æ /assets/avatars/flor.png" value="<?= h($avatarUrl) ?>" <?= $canEdit ? '' : 'disabled' ?>>
          </label>
          <div class="hint" style="font-size:12px; color:var(--muted);">–Ø–∫—â–æ –≤—Å—Ç–∞–≤–∏—à URL ‚Äî –≤–æ–Ω–æ –ø—ñ–¥—Ç—è–≥–Ω–µ—Ç—å—Å—è. –ù–∞–π–Ω–∞–¥—ñ–π–Ω—ñ—à–µ: –∫–ª—ñ–∫ –ø–æ –∞–≤–∞—Ç–∞—Ä—É –∞–±–æ Ctrl+V.</div>
        </div>

        <div class="hint" style="font-size:12px; color:var(--muted); margin-top:10px;">
          –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–æ–∂–Ω–∞ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ë–î —è–∫ data (base64). –ù–µ –≤–∞–Ω—Ç–∞–∂ –≥—ñ–≥–∞–Ω—Ç—Å—å–∫—ñ —Ñ–∞–π–ª–∏ üôÇ
        </div>
      </section>

      <section class="card">
        <h2>Notes</h2>
        <label>Session notes
          <textarea id="sessionNotes" name="session_notes" rows="12" <?= $canEdit ? '' : 'disabled' ?>></textarea>
        </label>
        <label>Quick notes
          <textarea id="quickNotes" name="quick_notes" placeholder="–ö–æ—Ä–æ—Ç–∫–æ: —â–æ –∑–∞—Ä–∞–∑ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è, —Ü—ñ–ª—ñ, —ñ–Ω—ñ—Ü—ñ–∞—Ç–∏–≤–∞..." rows="8" <?= $canEdit ? '' : 'disabled' ?>></textarea>
        </label>
      </section>

      <section class="card" hidden id="historyPanel">
        <h2>History</h2>
        <div class="hint" style="font-size:12px; color:var(--muted);">–ü–æ–∫–∏ —â–æ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –ø—ñ–¥ —ñ—Å—Ç–æ—Ä—ñ—é –∑–±–µ—Ä–µ–∂–µ–Ω—å.</div>
        <button class="secondary" type="button" id="btnRefreshHistory" disabled>Refresh</button>
        <div id="historyList"></div>
      </section>

    </aside>

    <!-- MAIN (reference-like) -->
    <section class="main">

      <!-- TOP GRID (Stats + Saves + Weapons) -->
      <section class="topGrid" id="topStatsBlock" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px; margin-bottom:16px;">
        <!-- STATS -->
        <section class="card compactCard" id="statsCard">
          <h2>Stats</h2>

          <div class="statsMetaRow" style="display:flex; gap:10px; margin-bottom:10px;">
            <label class="metaBox" style="margin:0;">
              <span class="metaLabel" style="display:block; font-size:12px; color:var(--muted);">PB</span>
              <input class="numSmall" id="profBonus" name="proficiency_bonus" type="number" value="<?= $pb ?>" <?= $canEdit ? '' : 'disabled' ?> />
            </label>
            <label class="metaBox" style="margin:0;">
              <span class="metaLabel" style="display:block; font-size:12px; color:var(--muted);">Inspiration</span>
              <input class="numSmall" id="inspiration" type="number" value="<?= !empty($res['inspiration']) ? 1 : 0 ?>" disabled />
            </label>
          </div>

          <h2>Base stats</h2>

          <div class="statsGridCompact">
            <?php
              $map = ['str'=>'STR','dex'=>'DEX','con'=>'CON','int'=>'INT','wis'=>'WIS','cha'=>'CHA'];
              foreach ($map as $k=>$label):
                $score = (int)($stats["{$k}_score"] ?? 10);
                $mod = stat_mod($score);
            ?>
              <div class="statCell">
                <span class="statKey"><?= $label ?></span>
                <input id="stat<?= $label ?>" name="<?= $k ?>_score" type="number" value="<?= $score ?>" <?= $canEdit ? '' : 'disabled' ?> />
                <span class="statMod" id="mod<?= $label ?>"><?= h(fmt_mod($mod)) ?></span>
              </div>
            <?php endforeach; ?>
          </div>

          <h2>Vitals</h2>
          <div class="grid2">
            <label>HP <input class="numSmall" id="hpCurrent" name="hp_current" type="number" value="<?= (int)($res['hp_current'] ?? 10) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
            <label>Max <input class="numSmall" id="hpMax" name="hp_max" type="number" value="<?= (int)($res['hp_max'] ?? 10) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
            <label>Temp <input class="numSmall" id="hpTemp" name="hp_temp" type="number" value="<?= (int)($res['hp_temp'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
            <label>AC <input class="numSmall" id="ac" name="ac" type="number" value="<?= (int)($res['ac'] ?? 10) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
          </div>

          <div class="grid2">
            <label class="ppBox">Passive Perception
              <div class="ppInner" style="display:flex; gap:10px; align-items:center; margin-top:6px;">
                <input class="numSmall" id="passivePerception" type="number" value="<?= (int)($res['passive_perception_override'] ?? 0) ?>" disabled />
                <label class="ppAuto" style="display:flex; gap:6px; align-items:center; margin:0; color:var(--muted);">
                  <input id="ppAuto" type="checkbox" disabled />
                  <span>Auto (10 + Perception)</span>
                </label>
              </div>
              <input name="passive_perception_override" value="<?= h($res['passive_perception_override'] ?? '') ?>" style="display:none;">
            </label>
          </div>

        </section>

        <!-- SAVES -->
        <section class="card compactCard" id="savesCard">
          <h2>Saves</h2>
          <div class="hint" style="font-size:12px; color:var(--muted); margin-bottom:10px;">Save = stat mod + (PB —è–∫—â–æ proficient).</div>

          <div class="savesGrid" id="savesGrid" style="display:grid; grid-template-columns: 1fr; gap:8px;">
            <?php
              foreach ($map as $k=>$label):
                $score = (int)($stats["{$k}_score"] ?? 10);
                $mod = stat_mod($score);
                $isProf = !empty($stats["save_{$k}"]);
                $total = $mod + ($isProf ? $pb : 0);
            ?>
              <div class="saveRow" style="display:flex; align-items:center; justify-content:space-between; gap:10px; background:var(--panel-soft); border:1px solid var(--border); border-radius:12px; padding:10px;">
                <div style="display:flex; align-items:center; gap:10px;">
                  <b style="min-width:44px;"><?= $label ?></b>
                  <span style="font-size:12px; color:var(--muted);">mod <?= h(fmt_mod($mod)) ?></span>
                </div>

                <div style="display:flex; align-items:center; gap:10px;">
                  <label class="row-inline" style="margin:0; color:var(--muted);">
                    <input type="checkbox" name="save_<?= $k ?>" value="1" <?= $isProf ? 'checked' : '' ?> <?= $canEdit ? '' : 'disabled' ?>>
                    proficient
                  </label>
                  <span class="badge" title="total"><?= h(fmt_mod($total)) ?></span>
                </div>
              </div>
            <?php endforeach; ?>
          </div>

          <div class="deathSaves" style="margin-top:14px; opacity:.7;">
            <div class="deathHeader" style="font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:8px;">Death Saves</div>
            <div style="font-size:12px; color:var(--muted);">–ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä (–¥–æ–¥–∞–º–æ –ø—ñ–∑–Ω—ñ—à–µ, –∫–æ–ª–∏ –∑–∞–≤–µ–¥–µ–º–æ –ø–æ–ª—è).</div>
          </div>
        </section>

        <!-- WEAPONS -->
        <section class="card compactCard" id="weaponsCard">
          <h2>Weapons</h2>
          <div class="cardBody">
            <div class="table">
              <div class="trow thead inv-head weapons-head" style="display:grid; grid-template-columns: 1.4fr .7fr .9fr .4fr; gap:10px; font-size:12px; color:var(--muted); padding:8px 0;">
                <div>–ù–∞–∑–≤–∞</div><div>–ë–æ–Ω—É—Å –ê–¢–ö</div><div>–®–∫–æ–¥–∞/—Ç–∏–ø</div><div></div>
              </div>

              <div id="weaponsTable">
                <?php foreach ($weapons as $w): ?>
                  <div class="trow" style="display:grid; grid-template-columns: 1.4fr .7fr .9fr .4fr; gap:10px; align-items:center; padding:10px 0; border-top:1px solid var(--border);">
                    <input type="hidden" name="wp_id[]" value="<?= (int)$w['id'] ?>">
                    <input name="wp_name[]" value="<?= h($w['name']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                    <input name="wp_atk[]" value="<?= h($w['atk']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                    <input name="wp_dmg[]" value="<?= h($w['dmg']) ?>" <?= $canEdit ? '' : 'disabled' ?>>

                    <label class="row-inline" style="margin:0; justify-content:flex-end;">
                      <input type="checkbox" name="wp_delete[]" value="<?= (int)$w['id'] ?>" <?= $canEdit ? '' : 'disabled' ?>>
                      <span style="font-size:12px; color:var(--muted);">Del</span>
                    </label>
                  </div>
                <?php endforeach; ?>
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <button type="button" id="addWeapon" class="secondary" <?= $canEdit ? '' : 'disabled' ?>>+ Add weapon</button>
            </div>
          </div>
        </section>
      </section>

      <!-- TWO COL GRID: Skills + Spells/Abilities -->
      <section class="twoColGrid" style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:16px;">
        <section class="card collapsible compactCard" data-collapse="skills">
          <h2>Skills</h2>
          <div class="cardBody">
            <div class="hint" style="font-size:12px; color:var(--muted);">–¢—É—Ç –±—É–¥–µ –±–ª–æ–∫ —Å–∫—ñ–ª—ñ–≤ —è–∫ —É —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ñ (–ø–æ–∫–∏ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä).</div>
            <div id="skillsList"></div>
          </div>
        </section>

        <section class="card collapsible compactCard" data-collapse="spells">
          <h2 style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <span>Spells</span>
            <span class="segToggle" id="spellsModeToggle" style="display:flex; gap:6px;">
              <button type="button" class="segBtn secondary" data-mode="spells">–ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è</button>
              <button type="button" class="segBtn secondary" data-mode="abilities">–í–º—ñ–Ω–Ω—è</button>
            </span>
          </h2>

          <div class="cardBody">
            <div id="spellsPane">
              <div class="row"><button type="button" id="addSpell" class="secondary" <?= $canEdit ? '' : 'disabled' ?>>+ Add spell</button></div>
              <div id="spellsHud"></div>

              <div class="hint" style="margin-top:10px; font-size:12px; color:var(--muted);">–†–µ–¥–∞–∫—Ç–æ—Ä –∑–∞–∫–ª–∏–Ω–∞–Ω—å (–ø–æ–∫–∏ —è–∫ —Å–ø–∏—Å–æ–∫).</div>

              <div id="spellsEditor">
                <?php foreach ($spells as $s): ?>
                  <div class="card" style="box-shadow:none; margin:10px 0; border:1px solid var(--border);">
                    <input type="hidden" name="sp_id[]" value="<?= (int)$s['id'] ?>">

                    <div class="grid2">
                      <label>UID <input name="sp_uid[]" value="<?= h($s['spell_uid']) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                      <label>Name <input name="sp_name[]" value="<?= h($s['name']) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                    </div>

                    <div class="row">
                      <label style="min-width:160px;">Kind
                        <select name="sp_kind[]" <?= $canEdit ? '' : 'disabled' ?>>
                          <option value="spell" <?= (($s['kind'] ?? 'spell')==='spell')?'selected':'' ?>>spell</option>
                          <option value="cantrip" <?= (($s['kind'] ?? '')==='cantrip')?'selected':'' ?>>cantrip</option>
                        </select>
                      </label>

                      <label>Level <input class="numSmall" name="sp_level[]" type="number" min="0" max="9" value="<?= (int)$s['level'] ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                      <label>Charges <input class="numSmall" name="sp_charges[]" type="number" value="<?= (int)$s['charges'] ?>" <?= $canEdit ? '' : 'disabled' ?>></label>

                      <label class="row-inline" style="margin:0;">
                        <input name="sp_used[]" type="checkbox" value="<?= (int)$s['id'] ?>" <?= !empty($s['used'])?'checked':'' ?> <?= $canEdit ? '' : 'disabled' ?>>
                        Used
                      </label>
                    </div>

                    <label>Description
                      <textarea name="sp_desc[]" rows="2" <?= $canEdit ? '' : 'disabled' ?>><?= h($s['description']) ?></textarea>
                    </label>

                    <label class="row-inline" style="margin:0;">
                      <input type="checkbox" name="sp_delete[]" value="<?= (int)$s['id'] ?>" <?= $canEdit ? '' : 'disabled' ?>>
                      Delete
                    </label>
                  </div>
                <?php endforeach; ?>
              </div>
            </div>

            <div id="abilitiesPane" class="isHidden" style="display:none;">
              <div class="row"><button type="button" id="addAbility" class="secondary" <?= $canEdit ? '' : 'disabled' ?>>+ Add ability</button></div>
              <div id="abilitiesHud"></div>

              <div class="hint" style="margin-top:10px; font-size:12px; color:var(--muted);">–†–µ–¥–∞–∫—Ç–æ—Ä –≤–º—ñ–Ω—å/–æ—Å–æ–±–ª–∏–≤–æ—Å—Ç–µ–π (–ø–æ–∫–∏ —è–∫ —Å–ø–∏—Å–æ–∫).</div>

              <div id="abilitiesEditor">
                <?php foreach ($abilities as $a): ?>
                  <div class="card" style="box-shadow:none; margin:10px 0; border:1px solid var(--border);">
                    <input type="hidden" name="ab_id[]" value="<?= (int)$a['id'] ?>">

                    <label>Name <input name="ab_name[]" value="<?= h($a['name']) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>

                    <div class="grid2">
                      <label>Kind <input name="ab_kind[]" value="<?= h($a['kind']) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                      <label>Source <input name="ab_source[]" value="<?= h($a['source']) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                    </div>

                    <label>Description
                      <textarea name="ab_desc[]" rows="2" <?= $canEdit ? '' : 'disabled' ?>><?= h($a['description']) ?></textarea>
                    </label>

                    <label class="row-inline" style="margin:0;">
                      <input type="checkbox" name="ab_delete[]" value="<?= (int)$a['id'] ?>" <?= $canEdit ? '' : 'disabled' ?>>
                      Delete
                    </label>
                  </div>
                <?php endforeach; ?>
              </div>
            </div>

          </div>
        </section>
      </section>

      <!-- INVENTORY (reference-like header/table) -->
      <section class="card collapsible" data-collapse="inventory">
        <h2>Inventory (simplified)</h2>
        <div class="cardBody">

          <div class="row">
            <button type="button" id="addItem" class="secondary" <?= $canEdit ? '' : 'disabled' ?>>+ Add item</button>
          </div>

          <div class="coinsPanel" style="margin-top:12px;">
            <div class="coinsGrid" style="display:flex; gap:12px; flex-wrap:wrap;">
              <label>GP <input class="numSmall" id="coinGP" name="gp" min="0" type="number" value="<?= (int)($coins['gp'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
              <label>SP <input class="numSmall" id="coinSP" name="sp" min="0" type="number" value="<?= (int)($coins['sp'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
              <label>CP <input class="numSmall" id="coinCP" name="cp" min="0" type="number" value="<?= (int)($coins['cp'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
            </div>

            <div class="hint" style="font-size:12px; color:var(--muted); margin-top:8px;">1 GP = 100 SP, 1 SP = 100 CP</div>
          </div>

          <div class="table" style="margin-top:12px;">
            <div class="trow thead inv-head" style="display:grid; grid-template-columns: 1.2fr .7fr .9fr .6fr .7fr .8fr 1.6fr .4fr; gap:10px; font-size:12px; color:var(--muted); padding:8px 0;">
              <div>Name</div><div>Equipped</div><div>Consumable</div><div>Qty</div><div>Charges</div><div>Icon</div><div>Description</div><div></div>
            </div>

            <div id="items">
              <?php foreach ($inventory as $i => $it): ?>
                <div class="trow" style="display:grid; grid-template-columns: 1.2fr .7fr .9fr .6fr .7fr .8fr 1.6fr .4fr; gap:10px; align-items:start; padding:10px 0; border-top:1px solid var(--border);">
                  <input type="hidden" name="inv_id[]" value="<?= (int)$it['id'] ?>">

                  <input name="inv_name[]" value="<?= h($it['name']) ?>" <?= $canEdit ? '' : 'disabled' ?>>

                  <label class="row-inline" style="margin:0; justify-content:center;">
                    <input type="checkbox" name="inv_equipped[<?= $i ?>]" value="1" <?= !empty($it['equipped'])?'checked':'' ?> <?= $canEdit ? '' : 'disabled' ?>>
                  </label>

                  <label class="row-inline" style="margin:0; justify-content:center;">
                    <input type="checkbox" name="inv_consumable[<?= $i ?>]" value="1" <?= !empty($it['consumable'])?'checked':'' ?> <?= $canEdit ? '' : 'disabled' ?>>
                  </label>

                  <input class="numSmall" name="inv_qty[]" type="number" value="<?= (int)$it['qty'] ?>" <?= $canEdit ? '' : 'disabled' ?>>
                  <input class="numSmall" name="inv_charges[]" type="number" value="<?= (int)$it['charges'] ?>" <?= $canEdit ? '' : 'disabled' ?>>
                  <input name="inv_icon[]" value="<?= h($it['icon']) ?>" <?= $canEdit ? '' : 'disabled' ?>>

                  <textarea name="inv_desc[]" rows="2" <?= $canEdit ? '' : 'disabled' ?>><?= h($it['description']) ?></textarea>

                  <label class="row-inline" style="margin:0; justify-content:flex-end;">
                    <input type="checkbox" name="inv_delete[]" value="<?= (int)$it['id'] ?>" <?= $canEdit ? '' : 'disabled' ?>>
                    <span style="font-size:12px; color:var(--muted);">Del</span>
                  </label>
                </div>
              <?php endforeach; ?>
            </div>
          </div>

        </div>
      </section>

      <?php if (!$canEdit): ?>
        <p style="color:#b00020;">–£ –≤–∞—Å —î –¥–æ—Å—Ç—É–ø –ª–∏—à–µ –Ω–∞ –ø–µ—Ä–µ–≥–ª—è–¥. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω–∞, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–∞–≤–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è.</p>
      <?php endif; ?>

    </section>

    <!-- RIGHT (reference-like: Identity + Proficiencies) -->
    <aside class="sidebar-right">

      <section class="card collapsible" data-collapse="identity">
        <h2>Identity</h2>
        <div class="cardBody">

          <div class="grid2">
            <label>–Ü–º º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
              <input id="charName" name="name" value="<?= h($ch['name']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
            </label>
            <label>–Ü–º º—è –≥—Ä–∞–≤—Ü—è
              <input id="playerName" name="player_name" value="<?= h($ch['player_name']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
            </label>
          </div>

          <div class="grid2">
            <label>–ö–ª–∞—Å
              <input id="class" name="class_name" value="<?= h($ch['class_name']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
            </label>
            <label>–†—ñ–≤–µ–Ω—å
              <input id="level" name="level" type="number" min="1" max="20" value="<?= (int)$ch['level'] ?>" <?= $canEdit ? '' : 'disabled' ?>>
            </label>
          </div>

          <div class="grid2">
            <label>–†–∞—Å–∞
              <input id="race" name="race" value="<?= h($ch['race']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
            </label>
            <label>–°–≤—ñ—Ç–æ–≥–ª—è–¥
              <input id="alignment" name="alignment" value="<?= h($ch['alignment']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
            </label>
          </div>

          <div class="grid2">
            <label>–ü–µ—Ä–µ–¥—ñ—Å—Ç–æ—Ä—ñ—è
              <input id="background" name="background" value="<?= h($ch['background']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
            </label>
            <label>–û—á–∫–∏ –¥–æ—Å–≤—ñ–¥—É
              <input id="xp" name="xp" value="<?= h($ch['xp']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
            </label>
          </div>

          <div class="grid2">
            <label>–†–∏—Å–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É
              <textarea id="traits" name="traits" rows="4" <?= $canEdit ? '' : 'disabled' ?>></textarea>
            </label>
            <label>–Ü–¥–µ–∞–ª–∏
              <textarea id="ideals" name="ideals" rows="4" <?= $canEdit ? '' : 'disabled' ?>></textarea>
            </label>

            <label>–ü—Ä–∏–≤'—è–∑–∞–Ω–æ—Å—Ç—ñ
              <textarea id="bonds" name="bonds" rows="4" <?= $canEdit ? '' : 'disabled' ?>></textarea>
            </label>
            <label>–°–ª–∞–±–∫—ñ—Å—Ç—å
              <textarea id="flaws" name="flaws" rows="4" <?= $canEdit ? '' : 'disabled' ?>></textarea>
            </label>
          </div>

          <label>Backstory
            <textarea id="backstory" name="backstory" rows="10" <?= $canEdit ? '' : 'disabled' ?>></textarea>
          </label>

        </div>
      </section>

      <section class="card collapsible" data-collapse="proficiencies">
        <h2>Proficiencies</h2>
        <div class="cardBody">
          <div class="hint" style="font-size:12px; color:var(--muted);">
            –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –ø—ñ–¥ proficiencies —è–∫ —É —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ñ (Weapons/Armor/Tools/Languages/Vehicles). –î–æ–¥–∞–º–æ –∫–æ–ª–∏ –±—É–¥–µ —Ç–∞–±–ª–∏—Ü—è/API.
          </div>

          <div class="profBlock" style="margin-top:10px;">
            <div class="profHead" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <span>Weapons</span>
              <button class="smallBtn secondary" type="button" id="addProfWeapon" disabled>+ Add</button>
            </div>
            <div id="profWeapons"></div>
          </div>

          <div class="profBlock">
            <div class="profHead" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <span>Armor</span>
              <button class="smallBtn secondary" type="button" id="addProfArmor" disabled>+ Add</button>
            </div>
            <div id="profArmor"></div>
          </div>

          <div class="profBlock">
            <div class="profHead" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <span>Tools</span>
              <button class="smallBtn secondary" type="button" id="addProfTools" disabled>+ Add</button>
            </div>
            <div id="profTools"></div>
          </div>

          <div class="profBlock">
            <div class="profHead" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <span>Languages</span>
              <button class="smallBtn secondary" type="button" id="addProfLang" disabled>+ Add</button>
            </div>
            <div id="profLang"></div>
          </div>

          <div class="profBlock">
            <div class="profHead" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <span>Vehicles / Transport</span>
              <button class="smallBtn secondary" type="button" id="addProfVehicle" disabled>+ Add</button>
            </div>
            <div id="profVehicle"></div>
          </div>

        </div>
      </section>

    </aside>

  </main>
</form>

<script>
(function(){
  // --- Segmented toggle: spells vs abilities (no external app.js) ---
  const toggle = document.getElementById('spellsModeToggle');
  const spellsPane = document.getElementById('spellsPane');
  const abilitiesPane = document.getElementById('abilitiesPane');
  if (toggle && spellsPane && abilitiesPane) {
    const btns = Array.from(toggle.querySelectorAll('.segBtn'));
    const setMode = (mode) => {
      const isSpells = mode === 'spells';
      spellsPane.style.display = isSpells ? '' : 'none';
      abilitiesPane.style.display = isSpells ? 'none' : '';
      btns.forEach(b => b.classList.toggle('secondary', true));
      btns.forEach(b => b.style.opacity = (b.dataset.mode === mode) ? '1' : '.75');
    };
    btns.forEach(b => b.addEventListener('click', () => setMode(b.dataset.mode)));
    setMode('spells');
  }

  // --- Avatar: click upload + Ctrl+V paste + URL load ---
  const canEdit = <?= $canEdit ? 'true' : 'false' ?>;
  const drop = document.getElementById('avatarDrop');
  const file = document.getElementById('avatarFile');
  const img  = document.getElementById('avatarImg');
  const fb   = document.getElementById('avatarFallback');
  const urlBlock = document.getElementById('avatarUrlBlock');
  const urlInput = document.getElementById('avatarUrl');
  const urlHidden = document.getElementById('avatarUrlHidden');
  const dataHidden = document.getElementById('avatarDataHidden');

  function setAvatarSrc(src){
    if (!img || !fb) return;
    if (src) {
      img.src = src;
      img.style.display = '';
      fb.style.display = 'none';
      if (urlBlock) urlBlock.style.display = 'none';
    } else {
      img.removeAttribute('src');
      img.style.display = 'none';
      fb.style.display = '';
      if (urlBlock) urlBlock.style.display = '';
    }
  }

  async function fileToDataUrl(f){
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(String(r.result || ''));
      r.onerror = reject;
      r.readAsDataURL(f);
    });
  }

  if (drop && file && canEdit) {
    drop.addEventListener('click', () => file.click());
    file.addEventListener('change', async () => {
      const f = file.files && file.files[0];
      if (!f) return;
      const dataUrl = await fileToDataUrl(f);
      setAvatarSrc(dataUrl);
      if (dataHidden) dataHidden.value = dataUrl; // store as data:...
      if (urlHidden) urlHidden.value = '';
      if (urlInput) urlInput.value = '';
    });

    window.addEventListener('paste', async (e) => {
      if (!e.clipboardData) return;
      const items = Array.from(e.clipboardData.items || []);
      const imgItem = items.find(it => it.type && it.type.startsWith('image/'));
      if (!imgItem) return;
      const f = imgItem.getAsFile();
      if (!f) return;
      const dataUrl = await fileToDataUrl(f);
      setAvatarSrc(dataUrl);
      if (dataHidden) dataHidden.value = dataUrl;
      if (urlHidden) urlHidden.value = '';
      if (urlInput) urlInput.value = '';
    });
  }

  if (urlInput && canEdit) {
    urlInput.addEventListener('change', () => {
      const v = (urlInput.value || '').trim();
      if (urlHidden) urlHidden.value = v;
      if (dataHidden) dataHidden.value = '';
      setAvatarSrc(v);
    });
  }

  // --- Minimal "Add" buttons: add empty rows client-side (safe, no backend changes) ---
  function addWeaponRow(){
    const wrap = document.getElementById('weaponsTable');
    if (!wrap) return;
    const row = document.createElement('div');
    row.className = 'trow';
    row.style.cssText = 'display:grid; grid-template-columns: 1.4fr .7fr .9fr .4fr; gap:10px; align-items:center; padding:10px 0; border-top:1px solid var(--border);';
    row.innerHTML = `
      <input type="hidden" name="wp_id[]" value="0">
      <input name="wp_name[]" value="" placeholder="Name">
      <input name="wp_atk[]" value="" placeholder="ATK">
      <input name="wp_dmg[]" value="" placeholder="DMG">
      <label class="row-inline" style="margin:0; justify-content:flex-end;">
        <input type="checkbox" name="wp_delete[]" value="0" disabled>
        <span style="font-size:12px; color:var(--muted);">Del</span>
      </label>
    `;
    wrap.appendChild(row);
  }
  function addItemRow(){
    const wrap = document.getElementById('items');
    if (!wrap) return;
    const row = document.createElement('div');
    row.className = 'trow';
    row.style.cssText = 'display:grid; grid-template-columns: 1.2fr .7fr .9fr .6fr .7fr .8fr 1.6fr .4fr; gap:10px; align-items:start; padding:10px 0; border-top:1px solid var(--border);';
    // note: new rows use index "_new_" so API can detect; if not supported, it will just ignore safely
    row.innerHTML = `
      <input type="hidden" name="inv_id[]" value="0">
      <input name="inv_name[]" value="" placeholder="Name">
      <label class="row-inline" style="margin:0; justify-content:center;"><input type="checkbox" name="inv_equipped_new[]" value="1"></label>
      <label class="row-inline" style="margin:0; justify-content:center;"><input type="checkbox" name="inv_consumable_new[]" value="1"></label>
      <input class="numSmall" name="inv_qty[]" type="number" value="1">
      <input class="numSmall" name="inv_charges[]" type="number" value="0">
      <input name="inv_icon[]" value="" placeholder="Icon">
      <textarea name="inv_desc[]" rows="2" placeholder="Description"></textarea>
      <div></div>
    `;
    wrap.appendChild(row);
  }
  function addSpellCard(){
    const wrap = document.getElementById('spellsEditor');
    if (!wrap) return;
    const card = document.createElement('div');
    card.className = 'card';
    card.style.cssText = 'box-shadow:none; margin:10px 0; border:1px solid var(--border);';
    card.innerHTML = `
      <input type="hidden" name="sp_id[]" value="0">
      <div class="grid2">
        <label>UID <input name="sp_uid[]" value=""></label>
        <label>Name <input name="sp_name[]" value=""></label>
      </div>
      <div class="row">
        <label style="min-width:160px;">Kind
          <select name="sp_kind[]">
            <option value="spell" selected>spell</option>
            <option value="cantrip">cantrip</option>
          </select>
        </label>
        <label>Level <input class="numSmall" name="sp_level[]" type="number" min="0" max="9" value="0"></label>
        <label>Charges <input class="numSmall" name="sp_charges[]" type="number" value="0"></label>
        <label class="row-inline" style="margin:0;"><input name="sp_used[]" type="checkbox" value="0"> Used</label>
      </div>
      <label>Description <textarea name="sp_desc[]" rows="2"></textarea></label>
      <div class="hint" style="font-size:12px; color:var(--muted);">–ù–æ–≤–∏–π –∑–∞–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è –ø—ñ—Å–ª—è Save (—è–∫—â–æ API –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤—Å—Ç–∞–≤–∫—É id=0).</div>
    `;
    wrap.appendChild(card);
  }
  function addAbilityCard(){
    const wrap = document.getElementById('abilitiesEditor');
    if (!wrap) return;
    const card = document.createElement('div');
    card.className = 'card';
    card.style.cssText = 'box-shadow:none; margin:10px 0; border:1px solid var(--border);';
    card.innerHTML = `
      <input type="hidden" name="ab_id[]" value="0">
      <label>Name <input name="ab_name[]" value=""></label>
      <div class="grid2">
        <label>Kind <input name="ab_kind[]" value=""></label>
        <label>Source <input name="ab_source[]" value=""></label>
      </div>
      <label>Description <textarea name="ab_desc[]" rows="2"></textarea></label>
      <div class="hint" style="font-size:12px; color:var(--muted);">–ù–æ–≤–∏–π –∑–∞–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è –ø—ñ—Å–ª—è Save (—è–∫—â–æ API –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤—Å—Ç–∞–≤–∫—É id=0).</div>
    `;
    wrap.appendChild(card);
  }

  const btnAddWeapon = document.getElementById('addWeapon');
  const btnAddItem   = document.getElementById('addItem');
  const btnAddSpell  = document.getElementById('addSpell');
  const btnAddAbility= document.getElementById('addAbility');

  if (btnAddWeapon && canEdit) btnAddWeapon.addEventListener('click', addWeaponRow);
  if (btnAddItem && canEdit) btnAddItem.addEventListener('click', addItemRow);
  if (btnAddSpell && canEdit) btnAddSpell.addEventListener('click', addSpellCard);
  if (btnAddAbility && canEdit) btnAddAbility.addEventListener('click', addAbilityCard);

})();
</script>

</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\characters.php
MODIFIED: 2026-02-14 20:53:45 | SIZE: 4836 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

require_login();
$user = current_user();
$uid = (int)($user['id'] ?? 0);
$role = (string)($user['role'] ?? 'user');

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  // create new character
  $name = trim((string)($_POST['name'] ?? ''));
  if ($name === '') $name = 'New Character';

  $pdo = db();
  $pdo->beginTransaction();
  try {
    $stmt = $pdo->prepare("INSERT INTO characters (owner_user_id, name, class_name, level, race, alignment, background, xp, player_name)
                           VALUES (?, ?, '', 1, '', '', '', '', '')");
    $stmt->execute([$uid, $name]);
    $charId = (int)$pdo->lastInsertId();

    $pdo->prepare("INSERT INTO character_stats (character_id) VALUES (?)")->execute([$charId]);
    $pdo->prepare("INSERT INTO character_resources (character_id) VALUES (?)")->execute([$charId]);
    $pdo->prepare("INSERT INTO character_coins (character_id) VALUES (?)")->execute([$charId]);

    $pdo->commit();
    header("Location: /character.php?id=" . $charId);
    exit;
  } catch (Throwable $e) {
    $pdo->rollBack();
    $err = $e->getMessage();
  }
}

if ($role === 'admin') {
  $rows = db()->query("SELECT c.*, u.username
                       FROM characters c
                       JOIN users u ON u.id = c.owner_user_id
                       ORDER BY c.updated_at DESC")->fetchAll();
} else {
    // 1) –ú–æ—ó –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ
    $stmt = db()->prepare("
      SELECT c.*
      FROM characters c
      WHERE c.owner_user_id=?
      ORDER BY c.updated_at DESC
    ");
    $stmt->execute([$uid]);
    $rows = $stmt->fetchAll();
  
    // 2) –î–æ—Å—Ç—É–ø–Ω—ñ –º–µ–Ω—ñ (shared)
    $st2 = db()->prepare("
      SELECT c.*, ca.can_edit, u.username AS owner_username
      FROM character_access ca
      JOIN characters c ON c.id = ca.character_id
      JOIN users u ON u.id = c.owner_user_id
      WHERE ca.user_id=?
      ORDER BY c.updated_at DESC
    ");
    $st2->execute([$uid]);
    $shared = $st2->fetchAll();
  }
  
  

$stmt = db()->prepare("
  SELECT c.*, ca.can_edit, u.username AS owner_username
  FROM character_access ca
  JOIN characters c ON c.id = ca.character_id
  JOIN users u ON u.id = c.owner_user_id
  WHERE ca.user_id=?
  ORDER BY c.updated_at DESC
");
$stmt->execute([$uid]);
$shared = $stmt->fetchAll();




?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Characters</title>
</head>
<body>
<?php require_once __DIR__ . '/inc/nav.php'; ?>

  <h1>Characters</h1>
  
  <form method="post" style="margin-bottom:16px;">
    <input name="name" placeholder="Character name">
    <button type="submit">Create</button>
    <?php if (!empty($err)) echo "<div style='color:red'>".htmlspecialchars($err)."</div>"; ?>
  </form>

  <ul>
    <?php foreach ($rows as $c): ?>
      <li>
        <a href="/character.php?id=<?= (int)$c['id'] ?>">
          <?= htmlspecialchars((string)$c['name']) ?>
        </a>
        ‚Äî lvl <?= (int)$c['level'] ?> <?= htmlspecialchars((string)$c['class_name']) ?>
        <?php if ($role === 'admin'): ?>
          <small>(owner: <?= htmlspecialchars((string)($c['username'] ?? '')) ?>)</small>
        <?php endif; ?>
      </li>
    <?php endforeach; ?>
  </ul>
  <ul>
    <?php foreach ($rows as $c): ?>
      <li>
        <a href="/character.php?id=<?= (int)$c['id'] ?>">
          <?= htmlspecialchars((string)$c['name']) ?>
        </a>
        ‚Äî lvl <?= (int)$c['level'] ?> <?= htmlspecialchars((string)$c['class_name']) ?>
        <?php if ($role === 'admin'): ?>
          <small>(owner: <?= htmlspecialchars((string)($c['username'] ?? '')) ?>)</small>
        <?php endif; ?>
      </li>
    <?php endforeach; ?>
  </ul>

  <!-- üîΩ –û–¢–£–¢ –î–û–î–ê–Ñ–ú–û –ë–õ–û–ö SHARED -->
  <?php if ($role !== 'admin'): ?>
    <h2>–î–æ—Å—Ç—É–ø–Ω—ñ –º–µ–Ω—ñ</h2>

    <?php if (!empty($shared)): ?>
      <ul>
        <?php foreach ($shared as $c): ?>
          <li>
            <a href="/character.php?id=<?= (int)$c['id'] ?>">
              <?= htmlspecialchars((string)$c['name']) ?>
            </a>

            <span style="opacity:.75">
              ‚Äî <?= ((int)($c['can_edit'] ?? 0) === 1) ? 'edit' : 'read-only' ?>
              ¬∑ owner: <?= htmlspecialchars((string)($c['owner_username'] ?? '')) ?>
            </span>
          </li>
        <?php endforeach; ?>
      </ul>
    <?php else: ?>
      <p style="opacity:.75">–ù–∞—Ä–∞–∑—ñ –Ω–µ–º–∞—î –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ–≤, –¥–æ —è–∫–∏—Ö –≤–∞–º –≤–∏–¥–∞–Ω–æ –¥–æ—Å—Ç—É–ø.</p>
    <?php endif; ?>
  <?php endif; ?>


</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\dashboard.php
MODIFIED: 2026-02-14 20:22:56 | SIZE: 969 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';

$user = require_login();
$isAdmin = (($user['role'] ?? '') === 'admin');
$who = $user['email'] ?? $user['username'] ?? 'user';
?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>–ö–∞–±—ñ–Ω–µ—Ç</title>
</head>
<body>

<?php require_once __DIR__ . '/inc/nav.php'; ?>

<h1>–ö–∞–±—ñ–Ω–µ—Ç</h1>
<p>–í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫: <b><?= htmlspecialchars($who) ?></b> (—Ä–æ–ª—å: <?= htmlspecialchars($user['role'] ?? '') ?>)</p>

<h2>–ì—Ä–∞–≤—Ü—é</h2>
<ul>
  <li><a href="/spells.php">–ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è</a></li>
  <li><a href="/characters.php">–ú–æ—ó –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ</a></li>
</ul>

<?php if ($isAdmin): ?>
  <h2>–ê–¥–º—ñ–Ω—É</h2>
  <ul>
    <li><a href="/admin_spells.php">–ê–¥–º—ñ–Ω–∫–∞: –ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è</a></li>
    <li><a href="/characters.php">–ü–µ—Ä—Å–æ–Ω–∞–∂—ñ –≥—Ä–∞–≤—Ü—ñ–≤</a></li>
  </ul>
<?php endif; ?>

</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\dump_site_dev.py
MODIFIED: 2026-02-14 19:24:45 | SIZE: 5415 bytes
======================================================================

import os
import sys
from datetime import datetime

# --- SKIP SETTINGS ---
SKIP_SUBSTR = "archive"
SKIP_DIRS = {"node_modules", "vendor", ".git", "__pycache__", ".idea", ".vscode"}

# --- WHAT TO DUMP (WEB CODE ONLY) ---
CODE_EXTS = {
    # backend
    ".php", ".phtml", ".java", ".py", ".rb",
    # frontend
    ".js", ".ts", ".jsx", ".tsx",
    ".css", ".scss", ".sass", ".less",
    ".html", ".htm",
    # data / config
    ".json", ".yml", ".yaml",
    ".xml", ".sql",
    ".env", ".ini", ".conf",
    ".htaccess",
    # scripts
    ".sh", ".bat"
}

MAX_BYTES = 1_048_576  # 1MB


def should_skip_dir(name: str) -> bool:
    return (
        SKIP_SUBSTR in name.lower()
        or name in SKIP_DIRS
    )


def relpath(path: str, root: str) -> str:
    r = os.path.relpath(path, root)
    return "." if r == "." else r.replace("\\", "/")


def safe_read_text(path: str) -> str:
    for enc in ("utf-8", "utf-8-sig", "cp1251"):
        try:
            with open(path, "r", encoding=enc, errors="strict") as f:
                return f.read()
        except Exception:
            pass
    with open(path, "r", encoding="utf-8", errors="replace") as f:
        return f.read()


def walk_dirs_files(root: str):
    for cur, dirs, files in os.walk(root):
        dirs[:] = [d for d in dirs if not should_skip_dir(d)]
        yield cur, dirs, files


def main():
    root = sys.argv[1] if len(sys.argv) > 1 else os.getcwd()
    root = os.path.abspath(root)

    if not os.path.isdir(root):
        print(f"ERROR: root not found: {root}")
        sys.exit(2)

    out_dir = os.path.dirname(os.path.abspath(__file__))
    tree_path = os.path.join(out_dir, "tree.txt")
    list_path = os.path.join(out_dir, "filelist.txt")
    cont_path = os.path.join(out_dir, "contents.txt")

    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    dirs_visited = 0
    files_listed = 0
    code_dumped = 0
    code_skipped_size = 0

    # --- TREE ---
    tree_lines = [
        f'ROOT: "{root}"',
        f"GENERATED: {now}",
        "",
        "====== DIRECTORY STRUCTURE ======",
        "",
        "[+] .",
    ]

    dir_paths = []
    for cur, dirs, _files in walk_dirs_files(root):
        dirs_visited += 1
        dir_paths.append(cur)

    for d in sorted(dir_paths):
        if d == root:
            continue
        rel = relpath(d, root)
        depth = rel.count("/")
        indent = "  " * depth
        name = rel.split("/")[-1]
        tree_lines.append(f"{indent}[+] {name}")

    tree_lines.append("")
    tree_lines.append("====== STATS ======")
    tree_lines.append(f"Directories visited: {dirs_visited}")

    with open(tree_path, "w", encoding="utf-8") as f:
        f.write("\n".join(tree_lines))

    # --- FILELIST + CONTENTS ---
    with open(list_path, "w", encoding="utf-8") as fl, open(cont_path, "w", encoding="utf-8") as fc:

        fl.write(f'ROOT: "{root}"\nGENERATED: {now}\n\n====== FILE LIST (per folder) ======\n')

        fc.write(
            f'ROOT: "{root}"\nGENERATED: {now}\n\n====== CODE CONTENTS ======\n'
            f"Included extensions: {' '.join(sorted(CODE_EXTS))}\n"
            f"Max file size: {MAX_BYTES} bytes\n"
        )

        for cur, _dirs, files in walk_dirs_files(root):
            rel_folder = relpath(cur, root)
            fl.write(f"\n--- {rel_folder} ---\n")

            for name in sorted(files):
                full = os.path.join(cur, name)

                try:
                    st = os.stat(full)
                except Exception:
                    continue

                files_listed += 1
                mtime = datetime.fromtimestamp(st.st_mtime).strftime("%Y-%m-%d %H:%M:%S")

                fl.write(f"{mtime} | {st.st_size} bytes | {relpath(full, root)}\n")

                ext = os.path.splitext(name)[1].lower()

                if ext in CODE_EXTS:

                    if st.st_size > MAX_BYTES:
                        code_skipped_size += 1
                        fc.write("\n" + "=" * 70 + "\n")
                        fc.write(f"FILE: {full}\n")
                        fc.write(f"(skipped: too large - {st.st_size} bytes, limit {MAX_BYTES})\n")
                        fc.write("=" * 70 + "\n")
                        continue

                    code_dumped += 1
                    fc.write("\n" + "=" * 70 + "\n")
                    fc.write(f"FILE: {full}\n")
                    fc.write(f"MODIFIED: {mtime} | SIZE: {st.st_size} bytes\n")
                    fc.write("=" * 70 + "\n\n")

                    try:
                        fc.write(safe_read_text(full))
                    except Exception as e:
                        fc.write(f"\n[ERROR reading file: {e}]\n")

                    fc.write("\n")

        fl.write("\n\n====== STATS ======\n")
        fl.write(f"Files listed: {files_listed}\n")

        fc.write("\n\n====== STATS ======\n")
        fc.write(f"Code files dumped: {code_dumped}\n")
        fc.write(f"Skipped by size: {code_skipped_size}\n")

    print("Done:")
    print(" -", tree_path)
    print(" -", list_path)
    print(" -", cont_path)
    print(f"Stats: dirs={dirs_visited} files={files_listed} dumped={code_dumped} skipped={code_skipped_size}")


if __name__ == "__main__":
    main()


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\index.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 207 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';

$u = current_user();

if ($u) {
  header('Location: /dashboard.php');
} else {
  header('Location: /login.php');
}
exit;


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\login.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 1310 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/db.php';
require_once __DIR__ . '/inc/auth.php';

start_session();
$err = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $username = trim((string)($_POST['username'] ?? ''));
  $pass     = (string)($_POST['password'] ?? '');

  $pdo = db();
  $stmt = $pdo->prepare(
    "SELECT id, username, password_hash, role FROM users WHERE username=? LIMIT 1"
  );
  $stmt->execute([$username]);
  $u = $stmt->fetch();

  if (!$u || !password_verify($pass, (string)$u['password_hash'])) {
    $err = '–ù–µ–≤—ñ—Ä–Ω–∏–π username –∞–±–æ –ø–∞—Ä–æ–ª—å.';
  } else {
    login_user((int)$u['id'], (string)$u['username'], (string)$u['role']);
    header('Location: /dashboard.php');
    exit;
  }
}
?>
<!doctype html>
<html lang="uk">
<head><meta charset="utf-8"><title>–í—Ö—ñ–¥</title></head>
<body>
<h1>–í—Ö—ñ–¥</h1>
<?php if ($err): ?><p style="color:red"><?= htmlspecialchars($err) ?></p><?php endif; ?>

<form method="post">
  <label>Username<br><input name="username" required></label><br><br>
  <label>–ü–∞—Ä–æ–ª—å<br><input name="password" type="password" required></label><br><br>
  <button type="submit">–£–≤—ñ–π—Ç–∏</button>
</form>

<p><a href="/register.php">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a></p>
</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\logout.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 132 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
logout_user();
header('Location: /login.php');
exit;


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\register.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 1735 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/db.php';
require_once __DIR__ . '/inc/auth.php';

start_session();
$err = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $username = trim((string)($_POST['username'] ?? ''));
  $pass     = (string)($_POST['password'] ?? '');

  if (!preg_match('/^[a-zA-Z0-9_]{3,32}$/', $username)) {
    $err = 'Username: 3‚Äì32 —Å–∏–º–≤–æ–ª–∏, –ª–∞—Ç–∏–Ω–∏—Ü—è, —Ü–∏—Ñ—Ä–∏, _.';
  } elseif (mb_strlen($pass) < 8) {
    $err = '–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 8 —Å–∏–º–≤–æ–ª—ñ–≤.';
  } else {
    $pdo = db();
    $stmt = $pdo->prepare("SELECT id FROM users WHERE username=? LIMIT 1");
    $stmt->execute([$username]);
    if ($stmt->fetch()) {
      $err = '–¢–∞–∫–∏–π username –≤–∂–µ —ñ—Å–Ω—É—î.';
    } else {
      $hash = password_hash($pass, PASSWORD_DEFAULT);
      $stmt = $pdo->prepare(
        "INSERT INTO users (username, password_hash, role) VALUES (?, ?, 'user')"
      );
      $stmt->execute([$username, $hash]);
      $id = (int)$pdo->lastInsertId();
      login_user($id, $username, 'user');
      header('Location: /dashboard.php');
      exit;
    }
  }
}
?>
<!doctype html>
<html lang="uk">
<head><meta charset="utf-8"><title>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</title></head>
<body>
<h1>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h1>
<?php if ($err): ?><p style="color:red"><?= htmlspecialchars($err) ?></p><?php endif; ?>

<form method="post">
  <label>Username<br><input name="username" required></label><br><br>
  <label>–ü–∞—Ä–æ–ª—å<br><input name="password" type="password" required></label><br><br>
  <button type="submit">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç</button>
</form>

<p><a href="/login.php">–í—Ö—ñ–¥</a></p>
</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\spell.php
MODIFIED: 2026-02-14 20:30:01 | SIZE: 2538 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

$user = require_login();

$slug = trim((string)($_GET['slug'] ?? ''));
if ($slug === '') { http_response_code(404); echo "Not found"; exit; }

$stmt = db()->prepare("SELECT * FROM spells WHERE slug=? AND is_published=1 LIMIT 1");
$stmt->execute([$slug]);
$s = $stmt->fetch();

if (!$s) { http_response_code(404); echo "Not found"; exit; }

function h(string $v): string { return htmlspecialchars($v, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8'); }
function br(string $v): string { return nl2br(h($v)); }

$hasOverride = trim((string)$s['override_text']) !== '';
?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title><?= h((string)$s['name']) ?></title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:1100px;margin:20px auto;padding:0 12px}
    .meta{opacity:.8;margin:6px 0 14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px}
    .card h2{margin:0 0 8px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;margin-left:6px;font-size:12px;opacity:.8}
    .warn{border-color:#f0c36d;background:#fff9e6}
    ul{margin:8px 0 0}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
<?php require_once __DIR__ . '/inc/nav.php'; ?>
<h1><?= h((string)$s['name']) ?></h1>
<div class="meta">
  <b>Level:</b> <?= (int)$s['level'] ?> |
  <b>School:</b> <?= h((string)$s['school']) ?> |
  <b>Casting:</b> <?= h((string)$s['casting_time']) ?> |
  <b>Range:</b> <?= h((string)$s['range_txt']) ?> |
  <b>Duration:</b> <?= h((string)$s['duration']) ?> |
  <b>Components:</b> <?= h((string)$s['components']) ?>
</div>

<div class="grid">
  <div class="card">
    <h2>Base <span class="pill"><?= h((string)($s['base_ref'] ?? '')) ?></span></h2>
    <div><?= br((string)$s['base_summary']) ?></div>
  </div>

  <div class="card <?= $hasOverride ? 'warn' : '' ?>">
    <h2>Campaign changes <?= $hasOverride ? '<span class="pill">changed</span>' : '<span class="pill">no changes</span>' ?></h2>
    <div><?= $hasOverride ? br((string)$s['override_text']) : '<span style="opacity:.75">–ù–µ–º–∞ –∑–º—ñ–Ω —É —Ü—ñ–π –∫–∞–º–ø–∞–Ω—ñ—ó.</span>' ?></div>
  </div>
</div>

<p style="margin-top:14px">
  <a href="/spells.php">‚Üê –Ω–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É</a> ¬∑
</p>
</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\spells.php
MODIFIED: 2026-02-14 20:30:07 | SIZE: 5132 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

$user = require_login();

$q      = trim((string)($_GET['q'] ?? ''));
$level  = trim((string)($_GET['level'] ?? ''));
$school = trim((string)($_GET['school'] ?? ''));
$sort   = trim((string)($_GET['sort'] ?? 'name')); // name|level|school
$dir    = strtolower(trim((string)($_GET['dir'] ?? 'asc'))); // asc|desc
$changedOnly = isset($_GET['changed']) && $_GET['changed'] === '1';

// –≤–∞–ª—ñ–¥–∞—Ü—ñ—è
$allowedSort = ['name', 'level', 'school'];
if (!in_array($sort, $allowedSort, true)) $sort = 'name';
if (!in_array($dir, ['asc','desc'], true)) $dir = 'asc';

// WHERE + params
$where  = "WHERE is_published=1";
$params = [];

if ($q !== '') {
  $where .= " AND name LIKE ?";
  $params[] = "%{$q}%";
}
if ($level !== '' && ctype_digit($level)) {
  $where .= " AND level = ?";
  $params[] = (int)$level;
}
if ($school !== '') {
  $where .= " AND school = ?";
  $params[] = $school;
}
if ($changedOnly) {
  $where .= " AND TRIM(COALESCE(override_text, '')) <> ''";
}

// –∫–æ–ª–µ–π—à–Ω –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –∞–ª—Ñ–∞–≤—ñ—Ç—É (—É–∫—Ä)
$collate = " COLLATE utf8mb4_unicode_ci ";

// ORDER BY
if ($sort === 'name') {
  $order = "ORDER BY name{$collate} {$dir}";
} elseif ($sort === 'school') {
  $order = "ORDER BY school{$collate} {$dir}, name{$collate} asc";
} else { // level
  $order = "ORDER BY level {$dir}, name{$collate} asc";
}

// SELECT (–±–µ—Ä–µ–º–æ override_text —ñ —Ä–∞—Ö—É—î–º–æ has_override —è–∫ –≤ –∞–¥–º—ñ–Ω—Ü—ñ)
$sql = "SELECT
          slug,
          name,
          level,
          school,
          override_text
        FROM spells
        {$where}
        {$order}";

$stmt = db()->prepare($sql);
$stmt->execute($params);
$rows = $stmt->fetchAll();

// —Å–ø–∏—Å–æ–∫ —à–∫—ñ–ª (—Ç—ñ–ª—å–∫–∏ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω—ñ)
$schools = db()->query("
  SELECT DISTINCT school
  FROM spells
  WHERE is_published=1 AND school <> ''
  ORDER BY school COLLATE utf8mb4_unicode_ci
")->fetchAll();
?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>–ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:1000px;margin:20px auto;padding:0 12px}
    input,select,button{padding:6px 8px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .muted{opacity:.75}
    .badge{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:1px 7px;font-size:12px;opacity:.85;margin-left:6px}
    .warn{border-color:#f0c36d;background:#fff9e6}
    label.chk{display:flex;gap:6px;align-items:center}
  </style>
</head>
<body>
<?php require_once __DIR__ . '/inc/nav.php'; ?>
<h1>–ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è</h1>

<form method="get" class="row">
  <input name="q" placeholder="–ø–æ—à—É–∫..." value="<?= htmlspecialchars($q) ?>">

  <select name="level">
    <option value="">–±—É–¥—å-—è–∫–∏–π —Ä—ñ–≤–µ–Ω—å</option>
    <?php for ($i=0; $i<=9; $i++): ?>
      <option value="<?= $i ?>" <?= ($level===(string)$i ? 'selected' : '') ?>><?= $i ?></option>
    <?php endfor; ?>
  </select>

  <select name="school">
    <option value="">–±—É–¥—å-—è–∫–∞ —à–∫–æ–ª–∞</option>
    <?php foreach ($schools as $s): ?>
      <option value="<?= htmlspecialchars((string)$s['school']) ?>" <?= ($school===(string)$s['school'] ? 'selected' : '') ?>>
        <?= htmlspecialchars((string)$s['school']) ?>
      </option>
    <?php endforeach; ?>
  </select>

  <label class="chk">
    <input type="checkbox" name="changed" value="1" <?= $changedOnly ? 'checked' : '' ?>>
    —Ç—ñ–ª—å–∫–∏ –∑–º—ñ–Ω–µ–Ω—ñ
  </label>

  <select name="sort">
    <option value="name"   <?= ($sort==='name'?'selected':'') ?>>—Å–æ—Ä—Ç—É–≤–∞—Ç–∏: –Ω–∞–∑–≤–∞</option>
    <option value="level"  <?= ($sort==='level'?'selected':'') ?>>—Å–æ—Ä—Ç—É–≤–∞—Ç–∏: —Ä—ñ–≤–µ–Ω—å</option>
    <option value="school" <?= ($sort==='school'?'selected':'') ?>>—Å–æ—Ä—Ç—É–≤–∞—Ç–∏: —à–∫–æ–ª–∞</option>
  </select>

  <select name="dir">
    <option value="asc"  <?= ($dir==='asc'?'selected':'') ?>>‚Üë</option>
    <option value="desc" <?= ($dir==='desc'?'selected':'') ?>>‚Üì</option>
  </select>

  <button type="submit">–ó–Ω–∞–π—Ç–∏</button>

  <?php if ($q!=='' || $level!=='' || $school!=='' || $changedOnly || $sort!=='name' || $dir!=='asc'): ?>
    <a class="muted" href="/spells.php">—Å–∫–∏–Ω—É—Ç–∏</a>
  <?php endif; ?>
</form>

<p class="muted">–ó–Ω–∞–π–¥–µ–Ω–æ: <?= count($rows) ?></p>

<ul>
<?php foreach ($rows as $r): ?>
  <?php $modified = trim((string)($r['override_text'] ?? '')) !== ''; ?>
  <li>
    <a href="/spell.php?slug=<?= urlencode((string)$r['slug']) ?>">
      <?= htmlspecialchars((string)$r['name']) ?>
    </a>

    <?php if ($modified): ?>
      <span class="badge warn">changed</span>
    <?php endif; ?>

    <span class="muted">
      ‚Äî lvl <?= (int)$r['level'] ?>, <?= htmlspecialchars((string)$r['school']) ?>
    </span>
  </li>
<?php endforeach; ?>
</ul>

</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\api\character_get.php
MODIFIED: 2026-02-14 20:45:30 | SIZE: 7161 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/../inc/auth.php';
require_once __DIR__ . '/../inc/db.php';

require_login();
header('Content-Type: application/json; charset=utf-8');

$user = current_user();
$uid = (int)($user['id'] ?? 0);
$role = (string)($user['role'] ?? 'user');

$charId = isset($_GET['id']) ? (int)$_GET['id'] : 0;
if ($charId <= 0) {
  http_response_code(400);
  echo json_encode(['ok' => false, 'error' => 'Missing id']);
  exit;
}

$stmt = db()->prepare("SELECT * FROM characters WHERE id=?");
$stmt->execute([$charId]);
$ch = $stmt->fetch();
if (!$ch) {
  http_response_code(404);
  echo json_encode(['ok' => false, 'error' => 'Not found']);
  exit;
}

// access: admin OR owner OR shared
$canEdit = false;

if ($role !== 'admin' && (int)$ch['owner_user_id'] !== $uid) {
    $accSt = $pdo->prepare("SELECT can_edit FROM character_access WHERE character_id=? AND user_id=? LIMIT 1");
    $accSt->execute([$charId, $uid]);
    $acc = $accSt->fetch();
  
    if (!$acc || (int)$acc['can_edit'] !== 1) {
      http_response_code(403);
      echo "Forbidden";
      exit;
    }
  }
  


// 1) characters -> identity —á–∞—Å—Ç–∫–æ–≤–æ
// 2) –ø—ñ–¥—Ç–∞–±–ª–∏—Ü—ñ -> state.*
$state = [];

$state['identity'] = [
  'shortName' => (string)$ch['name'],
  'className' => (string)$ch['class_name'],
  'level' => (int)$ch['level'],
  'playerName' => (string)$ch['player_name'],
  'race' => (string)$ch['race'],
  'alignment' => (string)$ch['alignment'],
  'background' => (string)$ch['background'],
  'xp' => (string)$ch['xp'],
  'avatar' => (string)($ch['avatar_data'] ?: $ch['avatar_url'] ?: ''),
];

$st = db()->prepare("SELECT * FROM character_stats WHERE character_id=?");
$st->execute([$charId]);
$row = $st->fetch() ?: [];

$state['stats'] = [
  'STR' => (int)($row['str_score'] ?? 10),
  'DEX' => (int)($row['dex_score'] ?? 10),
  'CON' => (int)($row['con_score'] ?? 10),
  'INT' => (int)($row['int_score'] ?? 10),
  'WIS' => (int)($row['wis_score'] ?? 10),
  'CHA' => (int)($row['cha_score'] ?? 10),
];

$state['saves'] = [
  'STR' => !empty($row['save_str']),
  'DEX' => !empty($row['save_dex']),
  'CON' => !empty($row['save_con']),
  'INT' => !empty($row['save_int']),
  'WIS' => !empty($row['save_wis']),
  'CHA' => !empty($row['save_cha']),
];

$rs = db()->prepare("SELECT * FROM character_resources WHERE character_id=?");
$rs->execute([$charId]);
$r = $rs->fetch() ?: [];

$state['resources'] = [
  'hp' => [
    'current' => (int)($r['hp_current'] ?? 10),
    'max' => (int)($r['hp_max'] ?? 10),
    'temp' => (int)($r['hp_temp'] ?? 0),
  ],
  'proficiencyBonus' => (int)($r['proficiency_bonus'] ?? 2),
  'defense' => [
    'ac' => (int)($r['ac'] ?? 10),
    'passivePerceptionOverride' => isset($r['passive_perception_override'])
      ? (int)$r['passive_perception_override']
      : null,
  ],
  // –Ω–æ–≤–µ:
  'inspiration' => !empty($r['inspiration']),
  'speed' => (int)($r['speed'] ?? 30),
  // custom –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ —è–∫ —Ç–∏ —Å–∫–∞–∑–∞–ª–∞
  'custom' => [],
];

$nt = db()->prepare("SELECT * FROM character_notes WHERE character_id=?");
$nt->execute([$charId]);
$n = $nt->fetch() ?: [];

$state['notes'] = [
  'session' => (string)($n['session_notes'] ?? ''),
  'quick' => (string)($n['quick_notes'] ?? ''),
  'backstory' => (string)($n['backstory'] ?? ''),
];

$cc = db()->prepare("SELECT * FROM character_coins WHERE character_id=?");
$cc->execute([$charId]);
$c = $cc->fetch() ?: [];
$state['coins'] = [
  'gp' => (int)($c['gp'] ?? 0),
  'sp' => (int)($c['sp'] ?? 0),
  'cp' => (int)($c['cp'] ?? 0),
];

// skills profs (—Ç—ñ–ª—å–∫–∏ true)
$state['skillProfs'] = [];
$sk = db()->prepare("SELECT skill_key FROM character_skill_profs WHERE character_id=?");
$sk->execute([$charId]);
foreach ($sk->fetchAll() as $srow) {
  $state['skillProfs'][(string)$srow['skill_key']] = true;
}

// proficiencies
$state['proficiencies'] = ['weapons'=>[], 'tools'=>[], 'armor'=>[], 'languages'=>[], 'transport'=>[]];
$pf = db()->prepare("SELECT prof_type, value FROM character_proficiencies WHERE character_id=? ORDER BY prof_type, sort_order, id");
$pf->execute([$charId]);
foreach ($pf->fetchAll() as $prow) {
  $t = (string)$prow['prof_type'];
  $v = (string)$prow['value'];
  if ($t === 'weapon') $state['proficiencies']['weapons'][] = $v;
  if ($t === 'tool') $state['proficiencies']['tools'][] = $v;
  if ($t === 'armor') $state['proficiencies']['armor'][] = $v;
  if ($t === 'language') $state['proficiencies']['languages'][] = $v;
  if ($t === 'transport') $state['proficiencies']['transport'][] = $v;
}

// inventory
$state['inventory'] = [];
$inv = db()->prepare("SELECT name,equipped,consumable,qty,charges,icon,description FROM character_inventory WHERE character_id=? ORDER BY sort_order, id");
$inv->execute([$charId]);
foreach ($inv->fetchAll() as $irow) {
  $state['inventory'][] = [
    'name' => (string)$irow['name'],
    'equipped' => !empty($irow['equipped']),
    'consumable' => !empty($irow['consumable']),
    'qty' => (int)$irow['qty'],
    'charges' => (int)$irow['charges'],
    'icon' => (string)$irow['icon'],
    'description' => (string)$irow['description'],
  ];
}

// weapons
$state['weapons'] = [];
$wp = db()->prepare("SELECT name,atk,dmg FROM character_weapons WHERE character_id=? ORDER BY sort_order, id");
$wp->execute([$charId]);
foreach ($wp->fetchAll() as $wrow) {
  $state['weapons'][] = [
    'name' => (string)$wrow['name'],
    'atk' => (string)$wrow['atk'],
    'dmg' => (string)$wrow['dmg'],
  ];
}

// spells
$state['spells'] = [];
$sp = db()->prepare("SELECT spell_uid,name,kind,level,charges,used,description FROM character_spells WHERE character_id=? ORDER BY sort_order, id");
$sp->execute([$charId]);
foreach ($sp->fetchAll() as $sprow) {
  $state['spells'][] = [
    'id' => (string)$sprow['spell_uid'],
    'name' => (string)$sprow['name'],
    'kind' => (string)$sprow['kind'],
    'level' => (int)$sprow['level'],
    'charges' => (int)$sprow['charges'],
    'used' => !empty($sprow['used']),
    'description' => (string)$sprow['description'],
  ];
}

// abilities
$state['abilities'] = [];
$ab = db()->prepare("SELECT name,kind,source,description FROM character_abilities WHERE character_id=? ORDER BY sort_order, id");
$ab->execute([$charId]);
foreach ($ab->fetchAll() as $arow) {
  $state['abilities'][] = [
    'name' => (string)$arow['name'],
    'kind' => (string)$arow['kind'],
    'source' => (string)$arow['source'],
    'description' => (string)$arow['description'],
  ];
}

// death saves
$ds = db()->prepare("SELECT fails,successes FROM character_death_saves WHERE character_id=?");
$ds->execute([$charId]);
$d = $ds->fetch() ?: [];
$state['deathSaves'] = [
  'fails' => (int)($d['fails'] ?? 0),
  'successes' => (int)($d['successes'] ?? 0),
];

// UI/meta –º–æ–∂–Ω–∞ –Ω–µ –≤—ñ–¥–¥–∞–≤–∞—Ç–∏ –∑ –ë–î ‚Äî —Ç–≤—ñ–π ensureDefaults() —ó—Ö –ø—ñ–¥—Å—Ç–∞–≤–∏—Ç—å
echo json_encode(['ok' => true, 'state' => $state], JSON_UNESCAPED_UNICODE);


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\api\character_save.php
MODIFIED: 2026-02-14 21:30:13 | SIZE: 11297 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/../inc/auth.php';
require_once __DIR__ . '/../inc/db.php';

require_login();
$user = current_user();
$uid = (int)($user['id'] ?? 0);
$role = (string)($user['role'] ?? 'user');

$charId = isset($_GET['id']) ? (int)$_GET['id'] : 0;
if ($charId <= 0) { http_response_code(400); echo "Missing id"; exit; }

$pdo = db();

// --- auth / access ---
$stmt = $pdo->prepare("SELECT id, owner_user_id FROM characters WHERE id=?");
$stmt->execute([$charId]);
$ch = $stmt->fetch();
if (!$ch) { http_response_code(404); echo "Not found"; exit; }

if ($role !== 'admin' && (int)$ch['owner_user_id'] !== $uid) {
  $accSt = $pdo->prepare("SELECT can_edit FROM character_access WHERE character_id=? AND user_id=? LIMIT 1");
  $accSt->execute([$charId, $uid]);
  $acc = $accSt->fetch();

  if (!$acc || (int)$acc['can_edit'] !== 1) {
    http_response_code(403);
    echo "Forbidden";
    exit;
  }
}

// --- helpers ---
function post_has(string $k): bool { return array_key_exists($k, $_POST); }
function post_str(string $k): string { return trim((string)($_POST[$k] ?? '')); }
function post_int(string $k, int $def=0): int {
  $v = $_POST[$k] ?? null;
  if ($v === null || $v === '') return $def;
  return (int)$v;
}
function post_bool(string $k): int { return isset($_POST[$k]) ? 1 : 0; }

$pdo->beginTransaction();
try {
  // fetch existing resources to avoid overwriting when field missing
  $curResSt = $pdo->prepare("SELECT * FROM character_resources WHERE character_id=?");
  $curResSt->execute([$charId]);
  $curRes = $curResSt->fetch() ?: [];

  // characters
  $pdo->prepare("UPDATE characters
                 SET name=?, class_name=?, level=?, race=?, alignment=?, background=?, xp=?, player_name=?, avatar_url=?, avatar_data=?
                 WHERE id=?")
      ->execute([
        post_str('name'),
        post_str('class_name'),
        post_int('level', (int)($ch['level'] ?? 1)),
        post_str('race'),
        post_str('alignment'),
        post_str('background'),
        post_str('xp'),
        post_str('player_name'),
        ($_POST['avatar_url'] ?? null),
        ($_POST['avatar_data'] ?? null),
        $charId
      ]);

  // resources
  $ppoRaw = ($_POST['passive_perception_override'] ?? '');
  $ppo = (trim((string)$ppoRaw) === '') ? null : (int)$ppoRaw;

  // IMPORTANT: do not overwrite inspiration/speed if those inputs are absent (disabled/not present)
  $inspiration = post_has('inspiration') ? post_bool('inspiration') : (int)($curRes['inspiration'] ?? 0);
  $speed       = post_has('speed') ? post_int('speed', 30) : (int)($curRes['speed'] ?? 30);

  $pdo->prepare("UPDATE character_resources
                 SET hp_current=?, hp_max=?, hp_temp=?, proficiency_bonus=?, ac=?, passive_perception_override=?, inspiration=?, speed=?
                 WHERE character_id=?")
      ->execute([
        post_int('hp_current', (int)($curRes['hp_current'] ?? 10)),
        post_int('hp_max', (int)($curRes['hp_max'] ?? 10)),
        post_int('hp_temp', (int)($curRes['hp_temp'] ?? 0)),
        post_int('proficiency_bonus', (int)($curRes['proficiency_bonus'] ?? 2)),
        post_int('ac', (int)($curRes['ac'] ?? 10)),
        $ppo,
        $inspiration,
        $speed,
        $charId
      ]);

  // stats + saves
  $pdo->prepare("UPDATE character_stats
                 SET str_score=?, dex_score=?, con_score=?, int_score=?, wis_score=?, cha_score=?,
                     save_str=?, save_dex=?, save_con=?, save_int=?, save_wis=?, save_cha=?
                 WHERE character_id=?")
      ->execute([
        post_int('str_score',10), post_int('dex_score',10), post_int('con_score',10),
        post_int('int_score',10), post_int('wis_score',10), post_int('cha_score',10),
        post_bool('save_str'), post_bool('save_dex'), post_bool('save_con'),
        post_bool('save_int'), post_bool('save_wis'), post_bool('save_cha'),
        $charId
      ]);

  // coins
  $pdo->prepare("UPDATE character_coins SET gp=?, sp=?, cp=? WHERE character_id=?")
      ->execute([post_int('gp',0), post_int('sp',0), post_int('cp',0), $charId]);

  // deletes
  $delInv = $_POST['inv_delete'] ?? [];
  if (is_array($delInv) && $delInv) {
    $ids = array_values(array_filter(array_map('intval', $delInv), fn($x)=>$x>0));
    if ($ids) {
      $in = implode(',', array_fill(0, count($ids), '?'));
      $args = $ids;
      $args[] = $charId;
      $pdo->prepare("DELETE FROM character_inventory WHERE id IN ($in) AND character_id=?")->execute($args);
    }
  }

  $delWp = $_POST['wp_delete'] ?? [];
  if (is_array($delWp) && $delWp) {
    $ids = array_values(array_filter(array_map('intval', $delWp), fn($x)=>$x>0));
    if ($ids) {
      $in = implode(',', array_fill(0, count($ids), '?'));
      $args = $ids;
      $args[] = $charId;
      $pdo->prepare("DELETE FROM character_weapons WHERE id IN ($in) AND character_id=?")->execute($args);
    }
  }

  $delSp = $_POST['sp_delete'] ?? [];
  if (is_array($delSp) && $delSp) {
    $ids = array_values(array_filter(array_map('intval', $delSp), fn($x)=>$x>0));
    if ($ids) {
      $in = implode(',', array_fill(0, count($ids), '?'));
      $args = $ids;
      $args[] = $charId;
      $pdo->prepare("DELETE FROM character_spells WHERE id IN ($in) AND character_id=?")->execute($args);
    }
  }

  $delAb = $_POST['ab_delete'] ?? [];
  if (is_array($delAb) && $delAb) {
    $ids = array_values(array_filter(array_map('intval', $delAb), fn($x)=>$x>0));
    if ($ids) {
      $in = implode(',', array_fill(0, count($ids), '?'));
      $args = $ids;
      $args[] = $charId;
      $pdo->prepare("DELETE FROM character_abilities WHERE id IN ($in) AND character_id=?")->execute($args);
    }
  }

  // inventory (update + insert)
  $inv_id = $_POST['inv_id'] ?? [];
  $inv_name = $_POST['inv_name'] ?? [];
  $inv_qty = $_POST['inv_qty'] ?? [];
  $inv_ch = $_POST['inv_charges'] ?? [];
  $inv_icon = $_POST['inv_icon'] ?? [];
  $inv_desc = $_POST['inv_desc'] ?? [];

  foreach ($inv_id as $i => $idRaw) {
    $id = (int)$idRaw;

    $name = (string)($inv_name[$i] ?? '');
    $qty  = (int)($inv_qty[$i] ?? 1);
    $chg  = (int)($inv_ch[$i] ?? 0);
    $icon = (string)($inv_icon[$i] ?? '');
    $desc = (string)($inv_desc[$i] ?? '');

    $equipped   = isset($_POST['inv_equipped'][$i]) ? 1 : 0;
    $consumable = isset($_POST['inv_consumable'][$i]) ? 1 : 0;

    if ($id > 0) {
      $pdo->prepare("UPDATE character_inventory
                     SET name=?, equipped=?, consumable=?, qty=?, charges=?, icon=?, description=?
                     WHERE id=? AND character_id=?")
          ->execute([$name, $equipped, $consumable, $qty, $chg, $icon, $desc, $id, $charId]);
    } else {
      // insert only if something filled
      $hasData = (trim($name) !== '' || trim($icon) !== '' || trim($desc) !== '' || $qty !== 1 || $chg !== 0 || $equipped || $consumable);
      if ($hasData) {
        $pdo->prepare("INSERT INTO character_inventory (character_id, name, equipped, consumable, qty, charges, icon, description, sort_order)
                       VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0)")
            ->execute([$charId, $name, $equipped, $consumable, $qty, $chg, $icon, $desc]);
      }
    }
  }

  // weapons (update + insert)
  $wp_id = $_POST['wp_id'] ?? [];
  $wp_name = $_POST['wp_name'] ?? [];
  $wp_atk = $_POST['wp_atk'] ?? [];
  $wp_dmg = $_POST['wp_dmg'] ?? [];

  foreach ($wp_id as $i => $idRaw) {
    $id = (int)$idRaw;

    $name = (string)($wp_name[$i] ?? '');
    $atk  = (string)($wp_atk[$i] ?? '');
    $dmg  = (string)($wp_dmg[$i] ?? '');

    if ($id > 0) {
      $pdo->prepare("UPDATE character_weapons SET name=?, atk=?, dmg=? WHERE id=? AND character_id=?")
          ->execute([$name, $atk, $dmg, $id, $charId]);
    } else {
      $hasData = (trim($name) !== '' || trim($atk) !== '' || trim($dmg) !== '');
      if ($hasData) {
        $pdo->prepare("INSERT INTO character_weapons (character_id, name, atk, dmg, sort_order)
                       VALUES (?, ?, ?, ?, 0)")
            ->execute([$charId, $name, $atk, $dmg]);
      }
    }
  }

  // spells (update + insert)
  $sp_id = $_POST['sp_id'] ?? [];
  $sp_uid = $_POST['sp_uid'] ?? [];
  $sp_name = $_POST['sp_name'] ?? [];
  $sp_kind = $_POST['sp_kind'] ?? [];
  $sp_level = $_POST['sp_level'] ?? [];
  $sp_charges = $_POST['sp_charges'] ?? [];
  $sp_desc = $_POST['sp_desc'] ?? [];
  $sp_used = $_POST['sp_used'] ?? []; // array of ids
  $usedSet = [];
  if (is_array($sp_used)) foreach ($sp_used as $sid) $usedSet[(int)$sid] = true;

  foreach ($sp_id as $i => $idRaw) {
    $id = (int)$idRaw;

    $uidStr = (string)($sp_uid[$i] ?? '');
    $name   = (string)($sp_name[$i] ?? '');
    $kind   = (($sp_kind[$i] ?? 'spell') === 'cantrip') ? 'cantrip' : 'spell';
    $lvl    = (int)($sp_level[$i] ?? 0);
    $chg    = (int)($sp_charges[$i] ?? 0);
    $desc   = (string)($sp_desc[$i] ?? '');

    if ($id > 0) {
      $pdo->prepare("UPDATE character_spells
                     SET spell_uid=?, name=?, kind=?, level=?, charges=?, used=?, description=?
                     WHERE id=? AND character_id=?")
          ->execute([
            $uidStr, $name, $kind, $lvl, $chg,
            isset($usedSet[$id]) ? 1 : 0,
            $desc, $id, $charId
          ]);
    } else {
      $hasData = (trim($uidStr) !== '' || trim($name) !== '' || trim($desc) !== '' || $lvl !== 0 || $chg !== 0);
      if ($hasData) {
        $pdo->prepare("INSERT INTO character_spells (character_id, spell_uid, name, kind, level, charges, used, description, sort_order)
                       VALUES (?, ?, ?, ?, ?, ?, 0, ?, 0)")
            ->execute([$charId, $uidStr, $name, $kind, $lvl, $chg, $desc]);
      }
    }
  }

  // abilities (update + insert)
  $ab_id = $_POST['ab_id'] ?? [];
  $ab_name = $_POST['ab_name'] ?? [];
  $ab_kind = $_POST['ab_kind'] ?? [];
  $ab_source = $_POST['ab_source'] ?? [];
  $ab_desc = $_POST['ab_desc'] ?? [];

  foreach ($ab_id as $i => $idRaw) {
    $id = (int)$idRaw;

    $name = (string)($ab_name[$i] ?? '');
    $kind = (string)($ab_kind[$i] ?? '');
    $src  = (string)($ab_source[$i] ?? '');
    $desc = (string)($ab_desc[$i] ?? '');

    if ($id > 0) {
      $pdo->prepare("UPDATE character_abilities
                     SET name=?, kind=?, source=?, description=?
                     WHERE id=? AND character_id=?")
          ->execute([$name, $kind, $src, $desc, $id, $charId]);
    } else {
      $hasData = (trim($name) !== '' || trim($kind) !== '' || trim($src) !== '' || trim($desc) !== '');
      if ($hasData) {
        $pdo->prepare("INSERT INTO character_abilities (character_id, name, kind, source, description, sort_order)
                       VALUES (?, ?, ?, ?, ?, 0)")
            ->execute([$charId, $name, $kind, $src, $desc]);
      }
    }
  }

  $pdo->commit();
  header("Location: /character.php?id=" . $charId);
  exit;

} catch (Throwable $e) {
  $pdo->rollBack();
  http_response_code(500);
  echo "Save failed: " . htmlspecialchars($e->getMessage());
}


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\api\character_share.php
MODIFIED: 2026-02-14 20:41:14 | SIZE: 1146 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/../inc/auth.php';
require_once __DIR__ . '/../inc/db.php';

$user = require_admin();
$pdo = db();

$charId = (int)($_POST['character_id'] ?? 0);
$username = trim((string)($_POST['username'] ?? ''));
$canEdit = isset($_POST['can_edit']) ? 1 : 0;

if ($charId <= 0 || $username === '') {
  http_response_code(400);
  echo "Bad request";
  exit;
}

$st = $pdo->prepare("SELECT id FROM characters WHERE id=? LIMIT 1");
$st->execute([$charId]);
if (!$st->fetch()) {
  http_response_code(404);
  echo "Character not found";
  exit;
}

$st = $pdo->prepare("SELECT id FROM users WHERE username=? LIMIT 1");
$st->execute([$username]);
$u = $st->fetch();
if (!$u) {
  http_response_code(404);
  echo "User not found";
  exit;
}
$targetUserId = (int)$u['id'];

// upsert –¥–æ—Å—Ç—É–ø
$st = $pdo->prepare("
  INSERT INTO character_access (character_id, user_id, can_edit)
  VALUES (?, ?, ?)
  ON DUPLICATE KEY UPDATE can_edit=VALUES(can_edit)
");
$st->execute([$charId, $targetUserId, $canEdit]);

header("Location: /character.php?id=" . $charId);
exit;


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\api\character_unshare.php
MODIFIED: 2026-02-14 20:41:27 | SIZE: 542 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/../inc/auth.php';
require_once __DIR__ . '/../inc/db.php';

$user = require_admin();
$pdo = db();

$charId = (int)($_POST['character_id'] ?? 0);
$userId = (int)($_POST['user_id'] ?? 0);

if ($charId <= 0 || $userId <= 0) {
  http_response_code(400);
  echo "Bad request";
  exit;
}

$st = $pdo->prepare("DELETE FROM character_access WHERE character_id=? AND user_id=?");
$st->execute([$charId, $userId]);

header("Location: /character.php?id=" . $charId);
exit;


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\inc\auth.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 1374 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/db.php';

function start_session(): void {
  if (session_status() === PHP_SESSION_ACTIVE) return;

  $cfg = require __DIR__ . '/config.php';
  session_name($cfg['app']['session_name'] ?? 'APPSESS');

  // –Ω–∞ –±—ñ–ª—å—à–æ—Å—Ç—ñ —Ö–æ—Å—Ç–∏–Ω–≥—ñ–≤ HTTPS —É–∂–µ —î ‚Äî –∞–ª–µ —Ö–∞–π –±—É–¥–µ –±–µ–∑ —Ñ–∞–Ω–∞—Ç–∏–∑–º—É
  $secure = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off');

  session_set_cookie_params([
    'lifetime' => 0,
    'path' => '/',
    'secure' => $secure,
    'httponly' => true,
    'samesite' => 'Lax',
  ]);

  session_start();
}

function current_user(): ?array {
  start_session();
  return $_SESSION['user'] ?? null;
}

function require_login(): array {
  $u = current_user();
  if (!$u) {
    header('Location: /login.php');
    exit;
  }
  return $u;
}

function require_admin(): array {
  $u = require_login();
  if (($u['role'] ?? '') !== 'admin') {
    http_response_code(403);
    echo "403 Forbidden";
    exit;
  }
  return $u;
}

function login_user(int $id, string $email, string $role): void {
  start_session();
  session_regenerate_id(true);
  $_SESSION['user'] = ['id' => $id, 'email' => $email, 'role' => $role];
}

function logout_user(): void {
  start_session();
  $_SESSION = [];
  session_destroy();
}


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\inc\char.css
MODIFIED: 2026-02-14 21:07:35 | SIZE: 4949 bytes
======================================================================

/* ================================
   BASE
================================ */

:root {
    --bg: #141418;
    --panel: #1d1e24;
    --panel-soft: #24252d;
    --border: #2f313a;
    --accent: #7c5cff;
    --accent-soft: #9d85ff;
    --text: #e6e6f0;
    --muted: #9a9aa8;
    --danger: #c94848;
    --radius: 14px;
  }
  
  * {
    box-sizing: border-box;
  }
  
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    line-height: 1.4;
  }
  
  h1,h2,h3 {
    margin: 0 0 12px 0;
    font-weight: 600;
  }
  
  h2 {
    font-size: 16px;
    letter-spacing: .5px;
    text-transform: uppercase;
    color: var(--muted);
  }
  
  a {
    color: var(--accent-soft);
    text-decoration: none;
  }
  
  a:hover {
    text-decoration: underline;
  }
  
  /* ================================
     TOPBAR
  ================================ */
  
  .topbar {
    position: sticky;
    top: 0;
    z-index: 20;
    background: linear-gradient(180deg, #1c1d23 0%, #181920 100%);
    border-bottom: 1px solid var(--border);
    padding: 14px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .topbar .brand {
    font-size: 18px;
    font-weight: 600;
  }
  
  .topbar .actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  .badge {
    background: #2b2c36;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    color: var(--muted);
  }
  
  /* ================================
     LAYOUT
  ================================ */
  
  .shell {
    display: grid;
    grid-template-columns: 280px 1fr 320px;
    gap: 20px;
    padding: 20px 24px 40px 24px;
  }
  
  @media (max-width: 1100px) {
    .shell {
      grid-template-columns: 1fr;
    }
  }
  
  /* ================================
     CARD
  ================================ */
  
  .card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
  }
  
  .cardBody {
    margin-top: 12px;
  }
  
  .collapsible h2 {
    cursor: pointer;
  }
  
  .collapsible.collapsed .cardBody {
    display: none;
  }
  
  /* ================================
     FORM ELEMENTS
  ================================ */
  
  label {
    display: block;
    margin-bottom: 10px;
    font-size: 13px;
    color: var(--muted);
  }
  
  input,
  select,
  textarea {
    width: 100%;
    background: var(--panel-soft);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 10px;
    color: var(--text);
    margin-top: 4px;
    font-size: 14px;
  }
  
  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--accent);
  }
  
  textarea {
    resize: vertical;
  }
  
  .numSmall {
    width: 80px;
  }
  
  button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
  }
  
  button.secondary {
    background: #2b2c36;
  }
  
  button:hover {
    opacity: .9;
  }
  
  /* ================================
     GRID HELPERS
  ================================ */
  
  .grid2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  
  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .row-inline {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  
  /* ================================
     STATS
  ================================ */
  
  .statsGridCompact {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }
  
  .statCell {
    background: var(--panel-soft);
    border-radius: 12px;
    padding: 10px;
    text-align: center;
  }
  
  .statKey {
    font-size: 12px;
    color: var(--muted);
    display: block;
    margin-bottom: 6px;
  }
  
  .statCell input {
    text-align: center;
  }
  
  .statMod {
    display: block;
    font-size: 11px;
    margin-top: 4px;
    color: var(--muted);
  }
  
  /* ================================
     COINS
  ================================ */
  
  .coinsPanel {
    background: var(--panel-soft);
    border-radius: 12px;
    padding: 12px;
  }
  
  .coinsGrid {
    display: flex;
    gap: 12px;
  }
  
  /* ================================
     READ ONLY MODE
  ================================ */
  
  form[aria-disabled="true"] {
    opacity: .8;
  }
  
  form[aria-disabled="true"] input,
  form[aria-disabled="true"] select,
  form[aria-disabled="true"] textarea {
    background: #1a1b21;
    color: #777;
    cursor: not-allowed;
  }
  

======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\inc\config.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 288 bytes
======================================================================

<?php
declare(strict_types=1);

return [
  'db' => [
    'host' => 'localhost',
    'name' => 'u341552863_tabletop',
    'user' => 'u341552863_neruer',
    'pass' => '1trv|4NrX;',
    'charset' => 'utf8mb4',
  ],
  'app' => [
    'session_name' => 'CHARAPPSESS',
  ],
];



======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\inc\db.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 485 bytes
======================================================================

<?php
declare(strict_types=1);

function db(): PDO {
  static $pdo = null;
  if ($pdo) return $pdo;

  $cfg = require __DIR__ . '/config.php';
  $db = $cfg['db'];

  $dsn = "mysql:host={$db['host']};dbname={$db['name']};charset={$db['charset']}";
  $pdo = new PDO($dsn, $db['user'], $db['pass'], [
    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    PDO::ATTR_EMULATE_PREPARES => false,
  ]);

  return $pdo;
}


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\inc\nav.php
MODIFIED: 2026-02-14 20:49:29 | SIZE: 1001 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/auth.php';

// —è–∫—â–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∞ $user ‚Äî –≤—ñ–∑—å–º–µ–º–æ –∑ —Å–µ—Å—ñ—ó –∞–±–æ –ø—Ä–æ–∂–µ–Ω–µ–º–æ —á–µ—Ä–µ–∑ require_login()
if (!isset($user) || !is_array($user)) {
  $user = current_user();
  if (!$user) $user = require_login();
}

$isAdmin = (($user['role'] ?? '') === 'admin');
?>
<nav style="display:flex; gap:12px; align-items:center; margin:12px 0;">
  <a href="/dashboard.php">–ö–∞–±—ñ–Ω–µ—Ç</a>
  <a href="/characters.php"><?= $isAdmin ? '–ü–µ—Ä—Å–æ–Ω–∞–∂—ñ –≥—Ä–∞–≤—Ü—ñ–≤' : '–ú–æ—ó –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ' ?></a>
  <a href="/spells.php">–ó–∞–∫–ª–∏–Ω–∞–Ω–Ω—è</a>

  <?php if ($isAdmin): ?>
    <a href="/admin_spells.php">–ê–¥–º—ñ–Ω–∫–∞: –∑–∞–∫–ª–∏–Ω–∞–Ω–Ω—è</a>
  <?php endif; ?>

  <span style="margin-left:auto; opacity:.75;">
    <?= htmlspecialchars((string)($user['email'] ?? $user['username'] ?? 'user')) ?>
  </span>
  <a href="/logout.php">–í–∏–π—Ç–∏</a>
</nav>
<hr>




====== STATS ======
Code files dumped: 22
Skipped by size: 0
