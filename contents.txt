ROOT: "D:\Projects\games\site-fondry\tabletops_3"
GENERATED: 2026-02-15 10:11:23

====== CODE CONTENTS ======
Included extensions: .bat .conf .css .env .htaccess .htm .html .ini .java .js .json .jsx .less .php .phtml .py .rb .sass .scss .sh .sql .ts .tsx .xml .yaml .yml
Max file size: 1048576 bytes

======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\admin_spell_edit.php
MODIFIED: 2026-02-14 20:28:38 | SIZE: 7142 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

$user = require_admin();
$pdo = db();

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;

$spell = [
  'slug' => '',
  'name' => '',
  'level' => 0,
  'school' => '',
  'casting_time' => '',
  'range_txt' => '',
  'duration' => '',
  'components' => '',
  'base_ref' => 'PHB',
  'base_summary' => '',
  'override_text' => '',
  'is_published' => 1,
];

if ($id > 0) {
  $st = $pdo->prepare("SELECT * FROM spells WHERE id=? LIMIT 1");
  $st->execute([$id]);
  $row = $st->fetch();
  if (!$row) { http_response_code(404); echo "Not found"; exit; }
  $spell = array_merge($spell, $row);
}

$err = '';

function slugify(string $s): string {
  $s = strtolower(trim($s));
  $s = preg_replace('/[^a-z0-9]+/', '-', $s) ?? '';
  $s = trim($s, '-');
  return $s;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $action = (string)($_POST['action'] ?? 'save');

  if ($action === 'delete' && $id > 0) {
    $st = $pdo->prepare("DELETE FROM spells WHERE id=?");
    $st->execute([$id]);
    header('Location: /admin_spells.php');
    exit;
  }

  $name = trim((string)($_POST['name'] ?? ''));
  $slug = trim((string)($_POST['slug'] ?? ''));
  $slug = $slug !== '' ? $slug : slugify($name);

  $level = (int)($_POST['level'] ?? 0);

  if ($slug === '' || !preg_match('/^[a-z0-9-]{2,190}$/', $slug)) {
    $err = 'Slug: тільки a-z, 0-9, дефіс. (мін 2 символи)';
  } elseif ($name === '') {
    $err = 'Name обовʼязкове.';
  } elseif ($level < 0 || $level > 9) {
    $err = 'Level має бути 0..9.';
  } else {
    $data = [
      'slug' => $slug,
      'name' => $name,
      'level' => $level,
      'school' => trim((string)($_POST['school'] ?? '')),
      'casting_time' => trim((string)($_POST['casting_time'] ?? '')),
      'range_txt' => trim((string)($_POST['range_txt'] ?? '')),
      'duration' => trim((string)($_POST['duration'] ?? '')),
      'components' => trim((string)($_POST['components'] ?? '')),
      'base_ref' => trim((string)($_POST['base_ref'] ?? '')),
      'base_summary' => (string)($_POST['base_summary'] ?? ''),
      'override_text' => (string)($_POST['override_text'] ?? ''),
      'is_published' => isset($_POST['is_published']) ? 1 : 0,
    ];

    try {
      if ($id > 0) {
        $st = $pdo->prepare("
          UPDATE spells SET
            slug=:slug, name=:name, level=:level, school=:school,
            casting_time=:casting_time, range_txt=:range_txt, duration=:duration, components=:components,
            base_ref=:base_ref, base_summary=:base_summary, override_text=:override_text,
            is_published=:is_published
          WHERE id=:id
        ");
        $data['id'] = $id;
        $st->execute($data);
      } else {
        $st = $pdo->prepare("
          INSERT INTO spells
            (slug,name,level,school,casting_time,range_txt,duration,components,base_ref,base_summary,override_text,is_published)
          VALUES
            (:slug,:name,:level,:school,:casting_time,:range_txt,:duration,:components,:base_ref,:base_summary,:override_text,:is_published)
        ");
        $st->execute($data);
        $id = (int)$pdo->lastInsertId();
      }

      header('Location: /admin_spells.php');
      exit;

    } catch (PDOException $e) {
      // найчастіше: дубль slug
      $err = 'DB error: ' . $e->getCode();
    }

    $spell = array_merge($spell, $data);
  }
}
?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>Admin Spell</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:1100px;margin:20px auto;padding:0 12px}
    input,textarea,select,button{padding:6px 8px;width:100%;box-sizing:border-box}
    textarea{font-family:ui-monospace,Consolas,monospace}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px}
    .row{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center;margin:8px 0}
    .err{color:#b00020}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .actions button{width:auto}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} .row{grid-template-columns:1fr} }
  </style>
</head>
<body>
<?php require_once __DIR__ . '/inc/nav.php'; ?>

<h1>Admin: Spell <?= $id>0 ? "#$id" : "NEW" ?></h1>
<?php if ($err): ?><p class="err"><?= htmlspecialchars($err) ?></p><?php endif; ?>

<form method="post">
  <div class="card">
    <div class="grid">
      <div>
        <div class="row"><label>Name</label><input name="name" value="<?= htmlspecialchars((string)$spell['name']) ?>" required></div>
        <div class="row"><label>Slug</label><input name="slug" value="<?= htmlspecialchars((string)$spell['slug']) ?>" placeholder="auto from name"></div>
        <div class="row"><label>Level</label><input name="level" type="number" min="0" max="9" value="<?= (int)$spell['level'] ?>"></div>
        <div class="row"><label>School</label><input name="school" value="<?= htmlspecialchars((string)$spell['school']) ?>"></div>
      </div>
      <div>
        <div class="row"><label>Casting</label><input name="casting_time" value="<?= htmlspecialchars((string)$spell['casting_time']) ?>"></div>
        <div class="row"><label>Range</label><input name="range_txt" value="<?= htmlspecialchars((string)$spell['range_txt']) ?>"></div>
        <div class="row"><label>Duration</label><input name="duration" value="<?= htmlspecialchars((string)$spell['duration']) ?>"></div>
        <div class="row"><label>Components</label><input name="components" value="<?= htmlspecialchars((string)$spell['components']) ?>"></div>
      </div>
    </div>

    <div class="row"><label>Base ref</label><input name="base_ref" value="<?= htmlspecialchars((string)$spell['base_ref']) ?>" placeholder="PHB p.241"></div>

    <div class="grid">
      <div class="card">
        <h2>Base summary (your words)</h2>
        <textarea name="base_summary" rows="10"><?= htmlspecialchars((string)$spell['base_summary']) ?></textarea>
      </div>
      <div class="card">
        <h2>Campaign changes</h2>
        <textarea name="override_text" rows="10"><?= htmlspecialchars((string)$spell['override_text']) ?></textarea>
      </div>
    </div>

    <div style="margin-top:10px">
      <label>
        <input type="checkbox" name="is_published" <?= ((int)$spell['is_published'] === 1 ? 'checked' : '') ?>>
        Published (visible for players)
      </label>
    </div>

    <div class="actions">
      <button type="submit" name="action" value="save">Save</button>
      <?php if ($id>0): ?>
        <button type="submit" name="action" value="delete" onclick="return confirm('Delete this spell?')">Delete</button>
      <?php endif; ?>
      <a href="/admin_spells.php">Back to list</a>
      <a href="/dashboard.php">Dashboard</a>
    </div>
  </div>
</form>
</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\admin_spell_import.php
MODIFIED: 2026-02-14 20:28:49 | SIZE: 7721 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

$user = require_admin();

function slugify(string $s): string {
  $s = mb_strtolower(trim($s), 'UTF-8');
  // транслітерація укр → лат (простий варіант)
  $map = [
    'а'=>'a','б'=>'b','в'=>'v','г'=>'h','ґ'=>'g','д'=>'d','е'=>'e','є'=>'ie','ж'=>'zh','з'=>'z','и'=>'y','і'=>'i','ї'=>'i','й'=>'i',
    'к'=>'k','л'=>'l','м'=>'m','н'=>'n','о'=>'o','п'=>'p','р'=>'r','с'=>'s','т'=>'t','у'=>'u','ф'=>'f','х'=>'kh','ц'=>'ts','ч'=>'ch',
    'ш'=>'sh','щ'=>'shch','ь'=>'','ю'=>'iu','я'=>'ia','\''=>'','’'=>'','"'=>'',
  ];
  $out = '';
  $chars = preg_split('//u', $s, -1, PREG_SPLIT_NO_EMPTY);
  foreach ($chars as $ch) {
    $out .= $map[$ch] ?? $ch;
  }
  $out = preg_replace('~[^a-z0-9]+~', '-', $out) ?? '';
  $out = trim($out, '-');
  if ($out === '') $out = 'spell';
  return substr($out, 0, 190);
}

function h(string $s): string {
  return htmlspecialchars($s, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8');
}

$pdo = db();
$mode = (string)($_POST['mode'] ?? '');
$msg = '';
$err = '';
$preview = [];
$stats = ['total'=>0,'ok'=>0,'skipped'=>0];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  if (!isset($_FILES['json']) || $_FILES['json']['error'] !== UPLOAD_ERR_OK) {
    $err = 'Файл не завантажився. Спробуй ще раз.';
  } else {
    $raw = file_get_contents($_FILES['json']['tmp_name']);
    $data = json_decode($raw ?: '', true);

    if (!is_array($data)) {
      $err = 'JSON не схожий на масив.';
    } else {
      // preview беремо перші 20
      $preview = array_slice($data, 0, 20);
      $stats['total'] = count($data);

      if ($mode === 'import') {
        $pdo->beginTransaction();
        try {
          $ins = $pdo->prepare("
            INSERT INTO spells
              (slug, name, level, school, casting_time, range_txt, duration, components, base_ref, base_summary, override_text, is_published)
            VALUES
              (:slug, :name, :level, :school, :casting_time, :range_txt, :duration, :components, :base_ref, :base_summary, :override_text, :is_published)
            ON DUPLICATE KEY UPDATE
              name=VALUES(name),
              level=VALUES(level),
              school=VALUES(school),
              casting_time=VALUES(casting_time),
              range_txt=VALUES(range_txt),
              duration=VALUES(duration),
              components=VALUES(components),
              base_ref=VALUES(base_ref),
              base_summary=VALUES(base_summary),
              is_published=VALUES(is_published)
          ");

          foreach ($data as $row) {
            if (!is_array($row)) { $stats['skipped']++; continue; }

            $name = trim((string)($row['name'] ?? ''));
            if ($name === '') { $stats['skipped']++; continue; }

            // slug: або з JSON, або генеруємо з name
            $slug = trim((string)($row['slug'] ?? ''));
            if ($slug === '') $slug = slugify($name);

            $level = (int)($row['level'] ?? 0);
            $school = trim((string)($row['school'] ?? ''));
            $casting = trim((string)($row['casting_time'] ?? ''));
            $range = trim((string)($row['range'] ?? ''));
            $duration = trim((string)($row['duration'] ?? ''));
            $components = trim((string)($row['components'] ?? ''));

            // твоє “base vs changes”:
            $base_ref = 'PHB';
            if (!empty($row['source'])) {
              $base_ref = 'PHB (' . trim((string)$row['source']) . ')';
            }
            // description кладемо в base_summary (потім ти можеш скорочувати вручну)
            $base_summary = (string)($row['description'] ?? '');
            $override_text = ''; // ребаланс заповниш в адмінці
            $is_published = 1;

            $ins->execute([
              ':slug' => $slug,
              ':name' => $name,
              ':level' => max(0, min(9, $level)),
              ':school' => $school,
              ':casting_time' => $casting,
              ':range_txt' => $range,
              ':duration' => $duration,
              ':components' => $components,
              ':base_ref' => $base_ref,
              ':base_summary' => $base_summary,
              ':override_text' => $override_text,
              ':is_published' => $is_published,
            ]);

            $stats['ok']++;
          }

          $pdo->commit();
          $msg = "Імпорт завершено: {$stats['ok']} / {$stats['total']} (skipped {$stats['skipped']}).";
        } catch (Throwable $e) {
          $pdo->rollBack();
          $err = "Помилка імпорту: " . $e->getMessage();
        }
      } else {
        $msg = "Preview: показано перші " . count($preview) . " з {$stats['total']}. Натисни Import, щоб залити/оновити.";
      }
    }
  }
}
?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>Адмін: Імпорт заклинань (JSON)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:1100px;margin:20px auto;padding:0 12px}
    input,button{padding:8px 10px}
    .ok{color:#0a7a0a}
    .err{color:#b00020}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    th,td{border:1px solid #ddd;padding:6px;vertical-align:top}
    th{background:#f6f6f6;text-align:left}
    .muted{opacity:.75}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
<?php require_once __DIR__ . '/inc/nav.php'; ?>

<h1>Адмін: Імпорт заклинань (JSON)</h1>
<p class="muted">Доступ тільки адміну. Рекомендовано видалити цей файл після імпорту.</p>

<?php if ($msg): ?><p class="ok"><?= h($msg) ?></p><?php endif; ?>
<?php if ($err): ?><p class="err"><?= h($err) ?></p><?php endif; ?>

<form method="post" enctype="multipart/form-data" class="row">
  <input type="file" name="json" accept=".json,application/json" required>
  <button type="submit" name="mode" value="preview">Preview</button>
  <button type="submit" name="mode" value="import" onclick="return confirm('Імпортувати/оновити всі записи з цього JSON?')">Import/Update</button>
  <a href="/dashboard.php">Dashboard</a>
</form>

<?php if ($preview): ?>
  <h2>Preview (перші <?= (int)count($preview) ?>)</h2>
  <table>
    <tr>
      <th>Name</th><th>Level</th><th>School</th><th>Casting</th><th>Range</th><th>Duration</th><th>Components</th>
      <th class="muted">Desc (початок)</th>
    </tr>
    <?php foreach ($preview as $r): ?>
      <?php
        $name = (string)($r['name'] ?? '');
        $desc = (string)($r['description'] ?? '');
      ?>
      <tr>
        <td><?= h($name) ?></td>
        <td><?= (int)($r['level'] ?? 0) ?></td>
        <td><?= h((string)($r['school'] ?? '')) ?></td>
        <td><?= h((string)($r['casting_time'] ?? '')) ?></td>
        <td><?= h((string)($r['range'] ?? '')) ?></td>
        <td><?= h((string)($r['duration'] ?? '')) ?></td>
        <td><?= h((string)($r['components'] ?? '')) ?></td>
        <td class="muted"><?= h(mb_substr($desc, 0, 120, 'UTF-8')) ?><?= mb_strlen($desc, 'UTF-8')>120 ? '…' : '' ?></td>
      </tr>
    <?php endforeach; ?>
  </table>
<?php endif; ?>

</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\admin_spells.php
MODIFIED: 2026-02-14 20:29:09 | SIZE: 5868 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

$user = require_admin();


$q      = trim((string)($_GET['q'] ?? ''));
$level  = trim((string)($_GET['level'] ?? ''));
$school = trim((string)($_GET['school'] ?? ''));
$pub    = trim((string)($_GET['pub'] ?? 'all')); // all|pub|hidden
$sort   = trim((string)($_GET['sort'] ?? 'name'));
$dir    = strtolower(trim((string)($_GET['dir'] ?? 'asc')));

$allowedSort = ['name', 'level', 'school', 'updated_at'];
if (!in_array($sort, $allowedSort, true)) $sort = 'name';
if (!in_array($dir, ['asc','desc'], true)) $dir = 'asc';
if (!in_array($pub, ['all','pub','hidden'], true)) $pub = 'all';

$where = "WHERE 1=1";
$params = [];

if ($q !== '') {
  $where .= " AND name LIKE ?";
  $params[] = "%{$q}%";
}
if ($level !== '' && ctype_digit($level)) {
  $where .= " AND level = ?";
  $params[] = (int)$level;
}
if ($school !== '') {
  $where .= " AND school = ?";
  $params[] = $school;
}
if ($pub === 'pub') {
  $where .= " AND is_published=1";
} elseif ($pub === 'hidden') {
  $where .= " AND is_published=0";
}

$collate = " COLLATE utf8mb4_unicode_ci ";

if ($sort === 'name') {
  $order = "ORDER BY name{$collate} {$dir}";
} elseif ($sort === 'school') {
  $order = "ORDER BY school{$collate} {$dir}, name{$collate} asc";
} elseif ($sort === 'level') {
  $order = "ORDER BY level {$dir}, name{$collate} asc";
} else { // updated_at
  $order = "ORDER BY updated_at {$dir}";
}

$sql = "SELECT id, slug, name, level, school, is_published, override_text, updated_at
        FROM spells {$where} {$order}";
$stmt = db()->prepare($sql);
$stmt->execute($params);
$rows = $stmt->fetchAll();

$schools = db()->query("SELECT DISTINCT school FROM spells WHERE school<>'' ORDER BY school COLLATE utf8mb4_unicode_ci")->fetchAll();
?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>Адмін: Заклинання</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:1100px;margin:20px auto;padding:0 12px}
    input,select,button{padding:6px 8px}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    th,td{border:1px solid #ddd;padding:6px;vertical-align:top}
    th{background:#f6f6f6;text-align:left}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .muted{opacity:.75}
    .badge{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:1px 7px;font-size:12px;opacity:.85}
    .warn{border-color:#f0c36d;background:#fff9e6}
  </style>
</head>
<body>
<?php require_once __DIR__ . '/inc/nav.php'; ?>

<h1>Адмін: Заклинання</h1>

<p>
  <a href="/admin_spell_edit.php">+ Додати</a> ·
  <a href="/admin_spell_import.php">Імпорт JSON</a> ·
  <a href="/dashboard.php">Кабінет</a>
</p>

<form method="get" class="row">
  <input name="q" placeholder="пошук..." value="<?= htmlspecialchars($q) ?>">

  <select name="level">
    <option value="">будь-який рівень</option>
    <?php for ($i=0; $i<=9; $i++): ?>
      <option value="<?= $i ?>" <?= ($level===(string)$i ? 'selected' : '') ?>><?= $i ?></option>
    <?php endfor; ?>
  </select>

  <select name="school">
    <option value="">будь-яка школа</option>
    <?php foreach ($schools as $s): ?>
      <option value="<?= htmlspecialchars((string)$s['school']) ?>" <?= ($school===(string)$s['school'] ? 'selected' : '') ?>>
        <?= htmlspecialchars((string)$s['school']) ?>
      </option>
    <?php endforeach; ?>
  </select>

  <select name="pub">
    <option value="all"    <?= ($pub==='all'?'selected':'') ?>>всі</option>
    <option value="pub"    <?= ($pub==='pub'?'selected':'') ?>>тільки published</option>
    <option value="hidden" <?= ($pub==='hidden'?'selected':'') ?>>тільки hidden</option>
  </select>

  <select name="sort">
    <option value="name"       <?= ($sort==='name'?'selected':'') ?>>сортувати: назва</option>
    <option value="level"      <?= ($sort==='level'?'selected':'') ?>>сортувати: рівень</option>
    <option value="school"     <?= ($sort==='school'?'selected':'') ?>>сортувати: школа</option>
    <option value="updated_at" <?= ($sort==='updated_at'?'selected':'') ?>>сортувати: оновлено</option>
  </select>

  <select name="dir">
    <option value="asc"  <?= ($dir==='asc'?'selected':'') ?>>↑</option>
    <option value="desc" <?= ($dir==='desc'?'selected':'') ?>>↓</option>
  </select>

  <button type="submit">Застосувати</button>

  <?php if ($q!=='' || $level!=='' || $school!=='' || $pub!=='all' || $sort!=='name' || $dir!=='asc'): ?>
    <a class="muted" href="/admin_spells.php">скинути</a>
  <?php endif; ?>
</form>

<p class="muted">Знайдено: <?= count($rows) ?></p>

<table>
  <tr>
    <th>Name</th><th>Lvl</th><th>School</th><th>Slug</th><th>Status</th><th>Updated</th><th>Actions</th>
  </tr>
  <?php foreach ($rows as $r): ?>
    <?php $modified = trim((string)$r['override_text']) !== ''; ?>
    <tr>
      <td>
        <?= htmlspecialchars((string)$r['name']) ?>
        <?php if ($modified): ?><span class="badge warn">modified</span><?php endif; ?>
      </td>
      <td><?= (int)$r['level'] ?></td>
      <td><?= htmlspecialchars((string)$r['school']) ?></td>
      <td><?= htmlspecialchars((string)$r['slug']) ?></td>
      <td><?= ((int)$r['is_published']===1) ? 'published' : 'hidden' ?></td>
      <td class="muted"><?= htmlspecialchars((string)$r['updated_at']) ?></td>
      <td><a href="/admin_spell_edit.php?id=<?= (int)$r['id'] ?>">edit</a></td>
    </tr>
  <?php endforeach; ?>
</table>

</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\character.php
MODIFIED: 2026-02-15 10:06:57 | SIZE: 47064 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

require_login();
$user = current_user();
$uid  = (int)($user['id'] ?? 0);
$role = (string)($user['role'] ?? 'user');

$charId = isset($_GET['id']) ? (int)$_GET['id'] : 0;
if ($charId <= 0) { http_response_code(400); echo "Missing id"; exit; }

$stmt = db()->prepare("SELECT * FROM characters WHERE id=?");
$stmt->execute([$charId]);
$ch = $stmt->fetch();
if (!$ch) { http_response_code(404); echo "Not found"; exit; }
$ch['avatar_url'] = $ch['avatar_url'] ?? null;
$ch['avatar_data'] = $ch['avatar_data'] ?? null;

// access: admin OR owner OR shared
$canEdit = false;

if ($role === 'admin' || (int)$ch['owner_user_id'] === $uid) {
  $canEdit = true;
} else {
  $accSt = db()->prepare("
    SELECT can_edit
    FROM character_access
    WHERE character_id=? AND user_id=?
    LIMIT 1
  ");
  $accSt->execute([$charId, $uid]);
  $acc = $accSt->fetch();

  if (!$acc) {
    http_response_code(403);
    echo "Forbidden";
    exit;
  }

  $canEdit = ((int)$acc['can_edit'] === 1);
}

$st = db()->prepare("SELECT * FROM character_stats WHERE character_id=?");
$st->execute([$charId]);
$stats = $st->fetch() ?: [];

$rs = db()->prepare("SELECT * FROM character_resources WHERE character_id=?");
$rs->execute([$charId]);
$res = $rs->fetch() ?: [];



// Skills
$skillsSt = db()->prepare("SELECT skill_code, proficiency_level, bonus_override
                           FROM character_skills
                           WHERE character_id=?");
$skillsSt->execute([$charId]);
$skillsRows = $skillsSt->fetchAll() ?: [];
$skillsMap = [];
foreach ($skillsRows as $r) {
  $skillsMap[(string)$r['skill_code']] = [
    'proficiency_level' => (int)($r['proficiency_level'] ?? 0),
    'bonus_override' => ($r['bonus_override'] === null ? null : (int)$r['bonus_override']),
  ];
}

// Proficiencies
$profsSt = db()->prepare("SELECT prof_type, name
                          FROM character_proficiencies
                          WHERE character_id=?
                          ORDER BY prof_type, name");
$profsSt->execute([$charId]);
$profsRows = $profsSt->fetchAll() ?: [];
$profs = [
  'weapons' => [],
  'armor' => [],
  'tools' => [],
  'languages' => [],
  'vehicles' => [],
];
foreach ($profsRows as $r) {
  $type = (string)($r['prof_type'] ?? '');
  $name = trim((string)($r['name'] ?? ''));
  if ($name === '' || !isset($profs[$type])) continue;
  $profs[$type][] = $name;
}
$cc = db()->prepare("SELECT * FROM character_coins WHERE character_id=?");
$cc->execute([$charId]);
$coins = $cc->fetch() ?: [];

$inv = db()->prepare("SELECT * FROM character_inventory WHERE character_id=? ORDER BY sort_order,id");
$inv->execute([$charId]);
$inventory = $inv->fetchAll();

$wp = db()->prepare("SELECT * FROM character_weapons WHERE character_id=? ORDER BY sort_order,id");
$wp->execute([$charId]);
$weapons = $wp->fetchAll();

$sp = db()->prepare("SELECT * FROM character_spells WHERE character_id=? ORDER BY sort_order,id");
$sp->execute([$charId]);
$spells = $sp->fetchAll();

$ab = db()->prepare("SELECT * FROM character_abilities WHERE character_id=? ORDER BY sort_order,id");
$ab->execute([$charId]);
$abilities = $ab->fetchAll();

$shared = [];
if ($role === 'admin') {
  $st2 = db()->prepare("
    SELECT a.user_id, a.can_edit, u.username
    FROM character_access a
    JOIN users u ON u.id = a.user_id
    WHERE a.character_id=?
    ORDER BY u.username
  ");
  $st2->execute([$charId]);
  $shared = $st2->fetchAll();
}

// notes / personality (optional table)
$notes = [
  'session_notes' => '',
  'quick_notes'   => '',
  'traits'        => '',
  'ideals'        => '',
  'bonds'         => '',
  'flaws'         => '',
  'backstory'     => '',
];
try {
  $nt = db()->prepare("
    SELECT session_notes, quick_notes, traits, ideals, bonds, flaws, backstory
    FROM character_notes
    WHERE character_id=?
    LIMIT 1
  ");
  $nt->execute([$charId]);
  $row = $nt->fetch();
  if ($row) {
    foreach ($notes as $k => $_) {
      if (array_key_exists($k, $row) && $row[$k] !== null) $notes[$k] = (string)$row[$k];
    }
  }
} catch (Throwable $e) {
  // Якщо таблиці/колонок ще нема — просто не роняємо сторінку.
}

function h($v): string { return htmlspecialchars((string)$v, ENT_QUOTES, 'UTF-8'); }
function stat_mod(int $score): int { return (int)floor(($score - 10) / 2); }
function fmt_mod(int $m): string { return ($m >= 0 ? '+' : '') . (string)$m; }

$pb = (int)($res['proficiency_bonus'] ?? 2);

// avatar src
$avatarSrc = '';
if (!empty($ch['avatar_data'])) {
  $avatarSrc = (string)$ch['avatar_data'];
} elseif (!empty($ch['avatar_url'])) {
  $avatarSrc = (string)$ch['avatar_url'];
}

?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title><?= h($ch['name'] ?? 'Character') ?></title>
  <link rel="stylesheet" href="/inc/char.css?v=1">
  <style>
    /* Extra styles for character.php on top of /inc/char.css */
    /* Keep 3 columns; DO NOT HIDE the right column (char.css stacks at <1100px; that's fine). */
    .shell{ grid-template-columns: 280px 1fr 320px; }

    /* Legacy .btn support (file uses .btn classes) */
    .btn{
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn.secondary{ background: #2b2c36; }
    .btn.danger{ background: var(--danger); }
    .btn[disabled]{ opacity:.65; cursor:not-allowed; }

    /* Avatar preview */
    .avatarPreview{
      width: 96px;
      height: 96px;
      border-radius: 14px;
      border: 1px solid var(--border);
      overflow: hidden;
      background: var(--panel-soft);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .avatarPreview img{ width:100%; height:100%; object-fit:cover; display:block; }
    .avatarBox{ display:flex; gap: 12px; align-items:flex-start; }

    /* Tabs */
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 12px; }
    .tabs button{
      background: #2b2c36;
      color: var(--text);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    .tabs button.active{
      background: rgba(124, 92, 255, .25);
      border-color: rgba(124, 92, 255, .45);
    }
/* Small UI helpers used by the file */
    .muted{ color: var(--muted); }
    .hint{ font-size: 12px; color: var(--muted); margin-top: 8px; }
    .pill{ background: #2b2c36; padding: 6px 10px; border-radius: 999px; font-size: 12px; color: var(--muted); display:inline-block; }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{ background: var(--panel-soft); border:1px solid var(--border); border-radius: 12px; padding: 10px; }
    .itemHead{ display:flex; justify-content:space-between; align-items:center; gap:10px; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(20,20,24,.92);
      border: 1px solid var(--border);
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      z-index: 9999;
      display:none;
    }
    .toast.show{ display:block; }
  </style>
</head>
<body>

<header class="topbar">
<div class="brand">
      <a class="btn secondary" href="/characters.php">← Назад</a>
      <div>
        <div style="font-size:18px; font-weight:700; line-height:1.1;"><?= h($ch['name']) ?></div>
        <div class="muted small">
          <span class="pill"><?= h($ch['race'] ?? '') ?></span>
          <span class="pill"><?= h($ch['class_name'] ?? '') ?> <?= (int)($ch['level'] ?? 1) ?></span>
          <?php if ($canEdit): ?>
            <span class="pill">Можна редагувати</span>
          <?php else: ?>
            <span class="pill">Лише перегляд</span>
          <?php endif; ?>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnSave" <?= $canEdit ? '' : 'disabled' ?>>Save</button>
      <button class="btn secondary" id="btnExport">Export JSON</button>
    </div>
</header>

<form id="charForm" method="post" action="/api/character_save.php">
  <input type="hidden" name="id" value="<?= (int)$charId ?>">

  <main class="shell">

    <aside class="sidebar-left">
      <section class="card">
  <h2>Avatar</h2>
  <div class="avatarBox" style="margin-bottom:10px; display:flex; align-items:center;">
  <div style="margin-right:16px;">
  <div id="avatarContainer" class="avatarContainer">
  <img
    id="avatarPreview"
    src="<?= $avatarSrc ? h($avatarSrc) : 'https://via.placeholder.com/128?text=No+avatar' ?>"
    alt="avatar"
    style="display:block;max-width: 100%;"
    tabindex="0"
    <?= $canEdit ? '' : 'aria-disabled="true"' ?>
    title="<?= $canEdit ? 'Click or paste image to change avatar' : 'Editing disabled' ?>"
  >
  </div>
  <input type="file" id="avatarFile" accept="image/*" hidden <?= $canEdit ? '' : 'disabled' ?>>
  <input type="hidden" id="avatarData" name="avatar_data" value="<?= h($ch['avatar_data'] ?? '') ?>">


</section>

      <section class="card" style="margin-top: 12px;">
            <h2>Notes</h2>
            <label>Session notes
              <textarea id="sessionNotes" name="session_notes" rows="12" <?= $canEdit ? '' : 'disabled' ?>><?= h($notes["session_notes"] ?? "") ?></textarea>
            </label>
            <label>Quick notes
              <textarea id="quickNotes" name="quick_notes" placeholder="Коротко: що зараз відбувається, цілі, ініціатива..." rows="8" <?= $canEdit ? '' : 'disabled' ?>><?= h($notes["quick_notes"] ?? "") ?></textarea>
            </label>
          </section>

      <section class="card" hidden id="historyPanel">
            <h2>History</h2>
            <div class="hint" style="font-size:12px; color:var(--muted);">Поки що плейсхолдер під історію збережень.</div>
            <button class="secondary" type="button" id="btnRefreshHistory" disabled>Refresh</button>
            <div id="historyList"></div>
          </section>
    </aside>

    <section class="main">
      <section class="card">
<div class="tabs">
          <button type="button" class="active" data-tab="sheet">Sheet</button>
          <button type="button" data-tab="weapons">Weapons</button>
          <button type="button" data-tab="inventory">Inventory</button>
          <button type="button" data-tab="spells">Spells</button>
          <button type="button" data-tab="abilities">Abilities</button>
        </div>

        <!-- TAB: SHEET -->
        <section data-panel="sheet">

          <div class="grid2">

            <section class="card" style="padding:12px;">
              <h2>Stats</h2>
              <div class="grid2">
                <?php
                  $statKeys = ['str'=>'STR','dex'=>'DEX','con'=>'CON','int'=>'INT','wis'=>'WIS','cha'=>'CHA'];
                  foreach ($statKeys as $k => $label):
                    $score = (int)($stats[$k] ?? 10);
                    $mod = stat_mod($score);
                ?>
                  <div class="item">
                    <div class="itemHead">
                      <div><b><?= $label ?></b></div>
                      <div class="pill"><?= fmt_mod($mod) ?></div>
                    </div>
                    <label>Score
                      <input type="number" min="1" max="30" name="stat_<?= $k ?>" value="<?= $score ?>" <?= $canEdit ? '' : 'disabled' ?>>
                    </label>
                  </div>
                <?php endforeach; ?>
              </div>
            </section>

            <section class="card" style="padding:12px;">
              <h2>Resources</h2>

              <div class="grid2">
                <label>HP max
                  <input type="number" min="0" name="hp_max" value="<?= (int)($res['hp_max'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                </label>
                <label>HP current
                  <input type="number" min="0" name="hp_current" value="<?= (int)($res['hp_current'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                </label>

                <label>Temp HP
                  <input type="number" min="0" name="temp_hp" value="<?= (int)($res['temp_hp'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                </label>
                <label>AC
                  <input type="number" min="0" name="ac" value="<?= (int)($res['ac'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                </label>

                <label>Speed
                  <input type="number" min="0" name="speed" value="<?= (int)($res['speed'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                </label>
                <label>Initiative
                  <input type="number" name="initiative" value="<?= (int)($res['initiative'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                </label>

                <label>Passive Perception (override)
                  <input type="number" id="passivePerception" value="<?= (int)($res['passive_perception'] ?? 10) ?>" disabled>
                  <input type="hidden" name="passive_perception" value="<?= (int)($res['passive_perception'] ?? 10) ?>">
                </label>

                <label>Auto passive perception
                  <input type="checkbox" id="autoPassivePerception" checked disabled>
                </label>
              </div>

              <hr style="border:0;border-top:1px solid rgba(255,255,255,.10); margin: 12px 0;">

              <h2>Coins</h2>
              <div class="grid2">
                <label>CP <input type="number" min="0" name="coin_cp" value="<?= (int)($coins['cp'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                <label>SP <input type="number" min="0" name="coin_sp" value="<?= (int)($coins['sp'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                <label>EP <input type="number" min="0" name="coin_ep" value="<?= (int)($coins['ep'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                <label>GP <input type="number" min="0" name="coin_gp" value="<?= (int)($coins['gp'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                <label>PP <input type="number" min="0" name="coin_pp" value="<?= (int)($coins['pp'] ?? 0) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
              </div>

            </section>
            <section class="card collapsible open" data-collapse="skills">
                <div class="collapseToggle">
                <h2 style="margin:0;">Skills</h2>
                <span class="muted">toggle</span>
                </div>
                <div class="cardBody">
                <div class="hint">Total = stat mod + PB (якщо proficient).</div>
                <div id="skillsList"></div>
                </div>
            </section>
          </div>
</section>

<!-- TAB: WEAPONS -->
        <section data-panel="weapons" hidden>
          <div class="grid2">
            <section class="card">
              <h2>Weapons</h2>
              <div class="sectionTitle">
                <div class="muted small"><?= count($weapons) ?> items</div>
                <button class="btn secondary" type="button" id="btnAddWeapon" <?= $canEdit ? '' : 'disabled' ?>>+ Add</button>
              </div>
              <div id="weaponList" class="list">
                <?php foreach ($weapons as $w): ?>
                  <div class="item weaponItem" data-id="<?= (int)$w['id'] ?>">
                    <div class="itemHead">
                      <div><b><?= h($w['name'] ?? 'Weapon') ?></b></div>
                      <button type="button" class="btn danger btnRemoveWeapon" <?= $canEdit ? '' : 'disabled' ?>>Remove</button>
                    </div>
                    <div class="grid2">
                      <label>Name <input name="weapon_name[]" value="<?= h($w['name'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                      <label>Attack bonus <input name="weapon_attack_bonus[]" value="<?= h($w['attack_bonus'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                      <label>Damage <input name="weapon_damage[]" value="<?= h($w['damage'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                      <label>Type <input name="weapon_type[]" value="<?= h($w['type'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                      <label>Notes <input name="weapon_notes[]" value="<?= h($w['notes'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                      <input type="hidden" name="weapon_id[]" value="<?= (int)$w['id'] ?>">
                      <input type="hidden" name="weapon_sort[]" value="<?= (int)$w['sort_order'] ?>">
                    </div>
                  </div>
                <?php endforeach; ?>
              </div>
            </section>
          </div>
        </section>
          </div>
        </section>

        <!-- TAB: INVENTORY -->

        <section data-panel="inventory" hidden>
          <section class="card">
            <div class="sectionTitle">
              <h2 style="margin:0;">Inventory</h2>
              <button class="btn secondary" type="button" id="btnAddItem" <?= $canEdit ? '' : 'disabled' ?>>+ Add</button>
            </div>
            <div id="invList" class="list">
              <?php foreach ($inventory as $it): ?>
                <div class="item invItem" data-id="<?= (int)$it['id'] ?>">
                  <div class="itemHead">
                    <div><b><?= h($it['name'] ?? 'Item') ?></b></div>
                    <button type="button" class="btn danger btnRemoveItem" <?= $canEdit ? '' : 'disabled' ?>>Remove</button>
                  </div>
                  <div class="grid2">
                    <label>Name <input name="item_name[]" value="<?= h($it['name'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                    <label>Qty <input type="number" min="0" name="item_qty[]" value="<?= (int)($it['qty'] ?? 1) ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                    <label>Weight <input name="item_weight[]" value="<?= h($it['weight'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                    <label>Notes <input name="item_notes[]" value="<?= h($it['notes'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>

                    <input type="hidden" name="item_id[]" value="<?= (int)$it['id'] ?>">
                    <input type="hidden" name="item_sort[]" value="<?= (int)$it['sort_order'] ?>">
                  </div>
                </div>
              <?php endforeach; ?>
            </div>
          </section>
        </section>

        <!-- TAB: SPELLS -->
        <section data-panel="spells" hidden>
          <section class="card">
            <div class="sectionTitle">
              <h2 style="margin:0;">Spells</h2>
              <button class="btn secondary" type="button" id="btnAddSpell" <?= $canEdit ? '' : 'disabled' ?>>+ Add</button>
            </div>
            <div id="spellList" class="list">
              <?php foreach ($spells as $s): ?>
                <div class="item spellItem" data-id="<?= (int)$s['id'] ?>">
                  <div class="itemHead">
                    <div><b><?= h($s['name'] ?? 'Spell') ?></b></div>
                    <button type="button" class="btn danger btnRemoveSpell" <?= $canEdit ? '' : 'disabled' ?>>Remove</button>
                  </div>
                  <div class="grid2">
                    <label>Name <input name="spell_name[]" value="<?= h($s['name'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                    <label>Level <input name="spell_level[]" value="<?= h($s['level'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                    <label>School <input name="spell_school[]" value="<?= h($s['school'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                    <label>Prepared <input type="checkbox" name="spell_prepared[]" value="1" <?= ((int)($s['is_prepared'] ?? 0) === 1 ? 'checked' : '') ?> <?= $canEdit ? '' : 'disabled' ?>></label>
                    <label>Notes <input name="spell_notes[]" value="<?= h($s['notes'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>

                    <input type="hidden" name="spell_id[]" value="<?= (int)$s['id'] ?>">
                    <input type="hidden" name="spell_sort[]" value="<?= (int)$s['sort_order'] ?>">
                    <input type="hidden" name="spell_prepared_present[]" value="1">
                  </div>
                </div>
              <?php endforeach; ?>
            </div>
          </section>
        </section>

        <!-- TAB: ABILITIES -->
        <section data-panel="abilities" hidden>
          <section class="card">
            <div class="sectionTitle">
              <h2 style="margin:0;">Abilities</h2>
              <button class="btn secondary" type="button" id="btnAddAbility" <?= $canEdit ? '' : 'disabled' ?>>+ Add</button>
            </div>
            <div id="abilityList" class="list">
              <?php foreach ($abilities as $a): ?>
                <div class="item abilityItem" data-id="<?= (int)$a['id'] ?>">
                  <div class="itemHead">
                    <div><b><?= h($a['name'] ?? 'Ability') ?></b></div>
                    <button type="button" class="btn danger btnRemoveAbility" <?= $canEdit ? '' : 'disabled' ?>>Remove</button>
                  </div>
                  <div class="grid2">
                    <label>Name <input name="ability_name[]" value="<?= h($a['name'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                    <label>Kind <input name="ability_kind[]" value="<?= h($a['kind'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                    <label>Source <input name="ability_source[]" value="<?= h($a['source'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>
                    <label>Description <input name="ability_description[]" value="<?= h($a['description'] ?? '') ?>" <?= $canEdit ? '' : 'disabled' ?>></label>

                    <input type="hidden" name="ability_id[]" value="<?= (int)$a['id'] ?>">
                    <input type="hidden" name="ability_sort[]" value="<?= (int)$a['sort_order'] ?>">
                  </div>
                </div>
              <?php endforeach; ?>
            </div>
          </section>
        </section>
</section>
 </section>

    <aside class="sidebar-right">
<section class="card collapsible open" data-collapse="identity" style="margin-top: 12px;">
            <div class="collapseToggle">
              <h2 style="margin:0;">Identity</h2>
              <span class="muted">toggle</span>
            </div>
            <div class="cardBody">

              <div class="grid2">
                <div>
                  <label>Ім'я гравця
                    <input id="playerName" name="player_name" value="<?= h($ch['player_name']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                  </label>
                  <label>Раса
                    <input id="race" name="race" value="<?= h($ch['race']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                  </label>
                  <label>Клас
                    <input id="className" name="class_name" value="<?= h($ch['class_name']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                  </label>
                  <label>Рівень
                    <input id="level" type="number" min="1" max="20" name="level" value="<?= (int)($ch['level'] ?? 1) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                  </label>
                </div>

                <div>
                  <label>Світогляд
                    <input id="alignment" name="alignment" value="<?= h($ch['alignment']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                  </label>
                  <div class="grid2">
                    <label>Передісторія
                      <input id="background" name="background" value="<?= h($ch['background']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                    </label>
                    <label>Очки досвіду
                      <input id="xp" name="xp" value="<?= h($ch['xp']) ?>" <?= $canEdit ? '' : 'disabled' ?>>
                    </label>
                  </div>

                  <div class="grid2">
                    <label>Риси характеру
                      <textarea id="traits" name="traits" rows="4" <?= $canEdit ? '' : 'disabled' ?>><?= h($notes["traits"] ?? "") ?></textarea>
                    </label>
                    <label>Ідеали
                      <textarea id="ideals" name="ideals" rows="4" <?= $canEdit ? '' : 'disabled' ?>><?= h($notes["ideals"] ?? "") ?></textarea>
                    </label>

                    <label>Прив'язаності
                      <textarea id="bonds" name="bonds" rows="4" <?= $canEdit ? '' : 'disabled' ?>><?= h($notes["bonds"] ?? "") ?></textarea>
                    </label>
                    <label>Слабкість
                      <textarea id="flaws" name="flaws" rows="4" <?= $canEdit ? '' : 'disabled' ?>><?= h($notes["flaws"] ?? "") ?></textarea>
                    </label>
                  </div>

                  <label>Backstory
                    <textarea id="backstory" name="backstory" rows="10" <?= $canEdit ? '' : 'disabled' ?>><?= h($notes["backstory"] ?? "") ?></textarea>
                  </label>

                </div>
              </div>

            </div>
          </section>

<section class="card collapsible open" data-collapse="profs" style="margin-top: 12px;">
  <div class="collapseToggle">
    <h2 style="margin:0;">Proficiencies</h2>
    <span class="muted">toggle</span>
  </div>

  <div class="cardBody">

    <div class="profBlock">
      <div class="profHead">
        <span>Weapons</span>
        <button class="smallBtn" type="button" id="addProfWeapon" <?= $canEdit ? '' : 'disabled' ?>>+ Add</button>
      </div>
      <div id="profWeapons"></div>
    </div>

    <div class="profBlock">
      <div class="profHead">
        <span>Armor</span>
        <button class="smallBtn" type="button" id="addProfArmor" <?= $canEdit ? '' : 'disabled' ?>>+ Add</button>
      </div>
      <div id="profArmor"></div>
    </div>

    <div class="profBlock">
      <div class="profHead">
        <span>Tools</span>
        <button class="smallBtn" type="button" id="addProfTools" <?= $canEdit ? '' : 'disabled' ?>>+ Add</button>
      </div>
      <div id="profTools"></div>
    </div>

    <div class="profBlock">
      <div class="profHead">
        <span>Languages</span>
        <button class="smallBtn" type="button" id="addProfLang" <?= $canEdit ? '' : 'disabled' ?>>+ Add</button>
      </div>
      <div id="profLang"></div>
    </div>

    <div class="profBlock">
      <div class="profHead">
        <span>Vehicles</span>
        <button class="smallBtn" type="button" id="addProfVehicle" <?= $canEdit ? '' : 'disabled' ?>>+ Add</button>
      </div>
      <div id="profVehicle"></div>
    </div>

  </div>
</section>
</aside>
</main>
</form>

<div class="toast" id="toast"></div>


<script>
(() => {
  const canEdit = <?= $canEdit ? 'true' : 'false' ?>;
  const charId = <?= (int)$charId ?>;
  const initialSkills = <?= json_encode($skillsMap, JSON_UNESCAPED_UNICODE) ?>;
  const initialProfs = <?= json_encode($profs, JSON_UNESCAPED_UNICODE) ?>;

  const toast = (msg) => {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2200);
  };

  // Tabs
  const tabBtns = Array.from(document.querySelectorAll('[data-tab]'));
  const panels = Array.from(document.querySelectorAll('[data-panel]'));
  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      tabBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const key = btn.getAttribute('data-tab');
      panels.forEach(p => p.hidden = (p.getAttribute('data-panel') !== key));
    });
  });

  // Collapsibles
  document.querySelectorAll('.collapsible').forEach(card => {
    const t = card.querySelector('.collapseToggle');
    if (!t) return;
    t.addEventListener('click', () => card.classList.toggle('open'));
  });

// ========================
// AVATAR SYSTEM
// ========================

const avatarContainer = document.getElementById('avatarContainer');
const avatarImg = document.getElementById('avatarPreview');
const avatarFile = document.getElementById('avatarFile');
const avatarData = document.getElementById('avatarData');

if (canEdit && avatarContainer && avatarFile && avatarImg) {

  // --- helper: convert file to base64
  const fileToBase64 = (file) => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result || ''));
      reader.readAsDataURL(file);
    });
  };




  avatarImg.addEventListener('load', adjustContainer);
  if (avatarImg.complete) adjustContainer();

  // --- click → open file dialog
  avatarContainer.addEventListener('click', () => {
    avatarFile.click();
  });

  // --- file selected
  avatarFile.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      toast('Only images allowed');
      return;
    }

    const base64 = await fileToBase64(file);
    avatarData.value = base64;
    avatarImg.src = base64;
  });

  // --- paste from clipboard
  document.addEventListener('paste', async (e) => {
    if (!document.activeElement || !avatarContainer.contains(document.activeElement)) return;

    const items = e.clipboardData?.items;
    if (!items) return;

    for (const item of items) {
      if (item.type.startsWith('image/')) {
        const file = item.getAsFile();
        if (!file) continue;

        const base64 = await fileToBase64(file);
        avatarData.value = base64;
        avatarImg.src = base64;
        toast('Image pasted');
        break;
      }
    }
  });

}


  // Dynamic lists helpers
  const q = (sel) => document.querySelector(sel);

  // Inventory add/remove
  const invList = q('#invList');
  const btnAddItem = q('#btnAddItem');
  const addInvItem = () => {
    const el = document.createElement('div');
    el.className = 'item invItem';
    el.innerHTML = `
      <div class="itemHead">
        <div><b>New Item</b></div>
        <button type="button" class="btn danger btnRemoveItem">Remove</button>
      </div>
      <div class="grid2">
        <label>Name <input name="item_name[]" value=""></label>
        <label>Qty <input type="number" min="0" name="item_qty[]" value="1"></label>
        <label>Weight <input name="item_weight[]" value=""></label>
        <label>Notes <input name="item_notes[]" value=""></label>

        <input type="hidden" name="item_id[]" value="0">
        <input type="hidden" name="item_sort[]" value="0">
      </div>
    `;
    invList.appendChild(el);
  };
  invList?.addEventListener('click', (e) => {
    const btn = e.target.closest('.btnRemoveItem');
    if (!btn) return;
    btn.closest('.invItem')?.remove();
  });
  if (btnAddItem && canEdit) btnAddItem.addEventListener('click', addInvItem);

  // Weapons add/remove
  const weaponList = q('#weaponList');
  const btnAddWeapon = q('#btnAddWeapon');
  const addWeaponItem = () => {
    const el = document.createElement('div');
    el.className = 'item weaponItem';
    el.innerHTML = `
      <div class="itemHead">
        <div><b>New Weapon</b></div>
        <button type="button" class="btn danger btnRemoveWeapon">Remove</button>
      </div>
      <div class="grid2">
        <label>Name <input name="weapon_name[]" value=""></label>
        <label>Attack bonus <input name="weapon_attack_bonus[]" value=""></label>
        <label>Damage <input name="weapon_damage[]" value=""></label>
        <label>Type <input name="weapon_type[]" value=""></label>
        <label>Notes <input name="weapon_notes[]" value=""></label>

        <input type="hidden" name="weapon_id[]" value="0">
        <input type="hidden" name="weapon_sort[]" value="0">
      </div>
    `;
    weaponList.appendChild(el);
  };
  weaponList?.addEventListener('click', (e) => {
    const btn = e.target.closest('.btnRemoveWeapon');
    if (!btn) return;
    btn.closest('.weaponItem')?.remove();
  });
  if (btnAddWeapon && canEdit) btnAddWeapon.addEventListener('click', addWeaponItem);

  // Spells add/remove
  const spellList = q('#spellList');
  const btnAddSpell = q('#btnAddSpell');
  const addSpellCard = () => {
    const el = document.createElement('div');
    el.className = 'item spellItem';
    el.innerHTML = `
      <div class="itemHead">
        <div><b>New Spell</b></div>
        <button type="button" class="btn danger btnRemoveSpell">Remove</button>
      </div>
      <div class="grid2">
        <label>Name <input name="spell_name[]" value=""></label>
        <label>Level <input name="spell_level[]" value=""></label>
        <label>School <input name="spell_school[]" value=""></label>
        <label>Prepared <input type="checkbox" name="spell_prepared[]" value="1"></label>
        <label>Notes <input name="spell_notes[]" value=""></label>

        <input type="hidden" name="spell_id[]" value="0">
        <input type="hidden" name="spell_sort[]" value="0">
        <input type="hidden" name="spell_prepared_present[]" value="1">
      </div>
    `;
    spellList.appendChild(el);
  };
  spellList?.addEventListener('click', (e) => {
    const btn = e.target.closest('.btnRemoveSpell');
    if (!btn) return;
    btn.closest('.spellItem')?.remove();
  });
  if (btnAddSpell && canEdit) btnAddSpell.addEventListener('click', addSpellCard);

  // Abilities add/remove
  const abilityList = q('#abilityList');
  const btnAddAbility = q('#btnAddAbility');
  const addAbilityCard = () => {
    const el = document.createElement('div');
    el.className = 'item abilityItem';
    el.innerHTML = `
      <div class="itemHead">
        <div><b>New Ability</b></div>
        <button type="button" class="btn danger btnRemoveAbility">Remove</button>
      </div>
      <div class="grid2">
        <label>Name <input name="ability_name[]" value=""></label>
        <label>Kind <input name="ability_kind[]" value=""></label>
        <label>Source <input name="ability_source[]" value=""></label>
        <label>Description <input name="ability_description[]" value=""></label>

        <input type="hidden" name="ability_id[]" value="0">
        <input type="hidden" name="ability_sort[]" value="0">
      </div>
    `;
    abilityList.appendChild(el);
  };
  abilityList?.addEventListener('click', (e) => {
    const btn = e.target.closest('.btnRemoveAbility');
    if (!btn) return;
    btn.closest('.abilityItem')?.remove();
  });
  if (btnAddAbility && canEdit) btnAddAbility.addEventListener('click', addAbilityCard);

  // ===== Skills + Proficiencies =====
  const SKILLS = [
    {code:'acrobatics',   name:'Acrobatics',      ability:'dex'},
    {code:'animal',       name:'Animal Handling', ability:'wis'},
    {code:'arcana',       name:'Arcana',          ability:'int'},
    {code:'athletics',    name:'Athletics',       ability:'str'},
    {code:'deception',    name:'Deception',       ability:'cha'},
    {code:'history',      name:'History',         ability:'int'},
    {code:'insight',      name:'Insight',         ability:'wis'},
    {code:'intimidation', name:'Intimidation',    ability:'cha'},
    {code:'investigation',name:'Investigation',   ability:'int'},
    {code:'medicine',     name:'Medicine',        ability:'wis'},
    {code:'nature',       name:'Nature',          ability:'int'},
    {code:'perception',   name:'Perception',      ability:'wis'},
    {code:'performance',  name:'Performance',     ability:'cha'},
    {code:'persuasion',   name:'Persuasion',      ability:'cha'},
    {code:'religion',     name:'Religion',        ability:'int'},
    {code:'sleight',      name:'Sleight of Hand', ability:'dex'},
    {code:'stealth',      name:'Stealth',         ability:'dex'},
    {code:'survival',     name:'Survival',        ability:'wis'},
  ];

  const state = {
    skills: JSON.parse(JSON.stringify(initialSkills || {})),
    profs:  JSON.parse(JSON.stringify(initialProfs || {weapons:[],armor:[],tools:[],languages:[],vehicles:[]})),
  };

  const getLevel = () => {
    const el = document.querySelector('input[name="level"]');
    const v = el ? parseInt(el.value || '1', 10) : 1;
    return Number.isFinite(v) ? Math.min(20, Math.max(1, v)) : 1;
  };
  const getPB = () => 2 + Math.floor((getLevel() - 1) / 4);

  const getStatScore = (k) => {
    const el = document.querySelector(`input[name="stat_${k}"]`);
    const v = el ? parseInt(el.value || '10', 10) : 10;
    return Number.isFinite(v) ? v : 10;
  };
  const statMod = (score) => Math.floor((score - 10) / 2);
  const fmtMod = (n) => (n >= 0 ? `+${n}` : `${n}`);

  const computeSkillTotal = (skillCode) => {
    const def = SKILLS.find(s => s.code === skillCode);
    if (!def) return 0;

    const mod = statMod(getStatScore(def.ability));
    const row = state.skills[skillCode] || {proficiency_level:0, bonus_override:null};

    const override = row.bonus_override;
    if (override !== null && override !== undefined && override !== '') {
      const ov = parseInt(override, 10);
      if (Number.isFinite(ov)) return ov;
    }

    const prof = parseInt(row.proficiency_level || 0, 10);
    const pb = getPB();
    const pbPart = prof === 2 ? (2 * pb) : (prof === 1 ? pb : 0);
    return mod + pbPart;
  };

  const renderSkills = () => {
    const root = document.getElementById('skillsList');
    if (!root) return;
    root.innerHTML = '';

    SKILLS.forEach(s => {
      const row = state.skills[s.code] || {proficiency_level:0, bonus_override:null};
      const total = computeSkillTotal(s.code);

      const wrap = document.createElement('div');
      wrap.className = 'skillRow';

      const left = document.createElement('div');
      left.innerHTML = `<div class="skillName"><b>${s.name}</b> <span class="skillMeta">(${s.ability.toUpperCase()})</span></div>`;

      const right = document.createElement('div');
      right.className = 'row-inline';

      if (canEdit) {
        const sel = document.createElement('select');
        sel.innerHTML = `
          <option value="0">—</option>
          <option value="1">Prof</option>
          <option value="2">Exp</option>
        `;
        sel.value = String(row.proficiency_level ?? 0);
        sel.addEventListener('change', () => {
          state.skills[s.code] = state.skills[s.code] || {};
          state.skills[s.code].proficiency_level = parseInt(sel.value, 10) || 0;
          renderSkills();
        });

        const ov = document.createElement('input');
        ov.type = 'number';
        ov.style.width = '76px';
        ov.placeholder = 'auto';
        ov.value = (row.bonus_override === null || row.bonus_override === undefined) ? '' : String(row.bonus_override);
        ov.addEventListener('input', () => {
          state.skills[s.code] = state.skills[s.code] || {};
          const v = ov.value.trim();
          state.skills[s.code].bonus_override = (v === '' ? null : parseInt(v, 10));
          renderSkills();
        });

        right.appendChild(sel);
        right.appendChild(ov);
      }

      const pill = document.createElement('span');
      pill.className = 'pill';
      pill.textContent = fmtMod(total);

      right.appendChild(pill);

      wrap.appendChild(left);
      wrap.appendChild(right);
      root.appendChild(wrap);
    });
  };

  const renderProfType = (type, containerId) => {
    const root = document.getElementById(containerId);
    if (!root) return;

    const list = state.profs[type] || [];
    root.innerHTML = '';
    const tagList = document.createElement('div');
    tagList.className = 'tagList';

    list.forEach((name, idx) => {
      const tag = document.createElement('span');
      tag.className = 'tag';
      tag.appendChild(document.createTextNode(name));

      if (canEdit) {
        const x = document.createElement('button');
        x.type = 'button';
        x.textContent = '×';
        x.title = 'Remove';
        x.addEventListener('click', () => {
          state.profs[type].splice(idx, 1);
          renderProfs();
        });
        tag.appendChild(x);
      }

      tagList.appendChild(tag);
    });

    root.appendChild(tagList);
  };

  const renderProfs = () => {
    renderProfType('weapons','profWeapons');
    renderProfType('armor','profArmor');
    renderProfType('tools','profTools');
    renderProfType('languages','profLang');
    renderProfType('vehicles','profVehicle');
  };

  const addProf = (type) => {
    if (!canEdit) return;
    const name = prompt('Add proficiency:');
    if (!name) return;
    const clean = name.trim();
    if (!clean) return;
    state.profs[type] = state.profs[type] || [];
    if (!state.profs[type].includes(clean)) state.profs[type].push(clean);
    state.profs[type].sort((a,b)=>a.localeCompare(b));
    renderProfs();
  };

  const bindProfButtons = () => {
    const map = [
      ['addProfWeapon','weapons'],
      ['addProfArmor','armor'],
      ['addProfTools','tools'],
      ['addProfLang','languages'],
      ['addProfVehicle','vehicles'],
    ];
    map.forEach(([id,type]) => {
      const btn = document.getElementById(id);
      if (!btn) return;
      btn.addEventListener('click', () => addProf(type));
    });
  };

  const saveExtras = async () => {
    const fd = new FormData();
    fd.append('id', String(charId));
    fd.append('skills_json', JSON.stringify(state.skills || {}));
    fd.append('profs_json', JSON.stringify(state.profs || {}));

    const res = await fetch('/api/character_save.php', { method:'POST', body: fd });
    const data = await res.json().catch(() => ({}));
    if (!res.ok || data.ok === false) throw new Error(data.error || 'Extras save failed');
  };

  // Recompute totals when stats/level change
  ['str','dex','con','int','wis','cha'].forEach(k => {
    document.querySelector(`input[name="stat_${k}"]`)?.addEventListener('input', renderSkills);
  });
  document.querySelector('input[name="level"]')?.addEventListener('input', renderSkills);

  renderSkills();
  renderProfs();
  bindProfButtons();

// Save
  const btnSave = q('#btnSave');
  const form = q('#charForm');

  if (btnSave && form) {
    btnSave.addEventListener('click', async () => {
      if (!canEdit) return;
      btnSave.disabled = true;

      try {
        const fd = new FormData(form);
        const res = await fetch(form.action, { method: 'POST', body: fd });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          toast(data.error || 'Save failed');
        } else {
          try { await saveExtras(); } catch(e){ toast(e.message || 'Extras save failed'); }
          toast('Saved');
        }
      } catch (e) {
        toast('Network error');
      } finally {
        btnSave.disabled = false;
      }
    });
  }

  // Export
  const btnExport = q('#btnExport');
  if (btnExport) {
    btnExport.addEventListener('click', () => {
      const obj = {};
      const fd = new FormData(document.getElementById('charForm'));
      fd.forEach((v,k) => {
        if (obj[k] === undefined) obj[k] = v;
        else if (Array.isArray(obj[k])) obj[k].push(v);
        else obj[k] = [obj[k], v];
      });
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type:'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'character_export.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  }

})();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {

  // -----------------------
  // TABS
  // -----------------------
  const tabButtons = document.querySelectorAll('.tabs button');
  const panels = document.querySelectorAll('[data-panel]');

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.tab;

      // активна кнопка
      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // показати потрібну панель
      panels.forEach(panel => {
        if (panel.dataset.panel === target) {
          panel.hidden = false;
        } else {
          panel.hidden = true;
        }
      });
    });
  });

});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {

  const collapsibles = document.querySelectorAll('.collapsible');

  collapsibles.forEach(card => {
    const toggle = card.querySelector('.collapseToggle');
    const body = card.querySelector('.cardBody');

    if (!toggle || !body) return;

    const key = 'collapse_' + card.dataset.collapse;

    // відновити стан
    const saved = localStorage.getItem(key);
    if (saved === 'closed') {
      body.style.display = 'none';
      card.classList.remove('open');
    }

    toggle.addEventListener('click', () => {
      const isOpen = body.style.display !== 'none';

      if (isOpen) {
        body.style.display = 'none';
        card.classList.remove('open');
        localStorage.setItem(key, 'closed');
      } else {
        body.style.display = '';
        card.classList.add('open');
        localStorage.setItem(key, 'open');
      }
    });
  });

});
</script>

</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\characters.php
MODIFIED: 2026-02-14 20:53:45 | SIZE: 4836 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

require_login();
$user = current_user();
$uid = (int)($user['id'] ?? 0);
$role = (string)($user['role'] ?? 'user');

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  // create new character
  $name = trim((string)($_POST['name'] ?? ''));
  if ($name === '') $name = 'New Character';

  $pdo = db();
  $pdo->beginTransaction();
  try {
    $stmt = $pdo->prepare("INSERT INTO characters (owner_user_id, name, class_name, level, race, alignment, background, xp, player_name)
                           VALUES (?, ?, '', 1, '', '', '', '', '')");
    $stmt->execute([$uid, $name]);
    $charId = (int)$pdo->lastInsertId();

    $pdo->prepare("INSERT INTO character_stats (character_id) VALUES (?)")->execute([$charId]);
    $pdo->prepare("INSERT INTO character_resources (character_id) VALUES (?)")->execute([$charId]);
    $pdo->prepare("INSERT INTO character_coins (character_id) VALUES (?)")->execute([$charId]);

    $pdo->commit();
    header("Location: /character.php?id=" . $charId);
    exit;
  } catch (Throwable $e) {
    $pdo->rollBack();
    $err = $e->getMessage();
  }
}

if ($role === 'admin') {
  $rows = db()->query("SELECT c.*, u.username
                       FROM characters c
                       JOIN users u ON u.id = c.owner_user_id
                       ORDER BY c.updated_at DESC")->fetchAll();
} else {
    // 1) Мої персонажі
    $stmt = db()->prepare("
      SELECT c.*
      FROM characters c
      WHERE c.owner_user_id=?
      ORDER BY c.updated_at DESC
    ");
    $stmt->execute([$uid]);
    $rows = $stmt->fetchAll();
  
    // 2) Доступні мені (shared)
    $st2 = db()->prepare("
      SELECT c.*, ca.can_edit, u.username AS owner_username
      FROM character_access ca
      JOIN characters c ON c.id = ca.character_id
      JOIN users u ON u.id = c.owner_user_id
      WHERE ca.user_id=?
      ORDER BY c.updated_at DESC
    ");
    $st2->execute([$uid]);
    $shared = $st2->fetchAll();
  }
  
  

$stmt = db()->prepare("
  SELECT c.*, ca.can_edit, u.username AS owner_username
  FROM character_access ca
  JOIN characters c ON c.id = ca.character_id
  JOIN users u ON u.id = c.owner_user_id
  WHERE ca.user_id=?
  ORDER BY c.updated_at DESC
");
$stmt->execute([$uid]);
$shared = $stmt->fetchAll();




?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Characters</title>
</head>
<body>
<?php require_once __DIR__ . '/inc/nav.php'; ?>

  <h1>Characters</h1>
  
  <form method="post" style="margin-bottom:16px;">
    <input name="name" placeholder="Character name">
    <button type="submit">Create</button>
    <?php if (!empty($err)) echo "<div style='color:red'>".htmlspecialchars($err)."</div>"; ?>
  </form>

  <ul>
    <?php foreach ($rows as $c): ?>
      <li>
        <a href="/character.php?id=<?= (int)$c['id'] ?>">
          <?= htmlspecialchars((string)$c['name']) ?>
        </a>
        — lvl <?= (int)$c['level'] ?> <?= htmlspecialchars((string)$c['class_name']) ?>
        <?php if ($role === 'admin'): ?>
          <small>(owner: <?= htmlspecialchars((string)($c['username'] ?? '')) ?>)</small>
        <?php endif; ?>
      </li>
    <?php endforeach; ?>
  </ul>
  <ul>
    <?php foreach ($rows as $c): ?>
      <li>
        <a href="/character.php?id=<?= (int)$c['id'] ?>">
          <?= htmlspecialchars((string)$c['name']) ?>
        </a>
        — lvl <?= (int)$c['level'] ?> <?= htmlspecialchars((string)$c['class_name']) ?>
        <?php if ($role === 'admin'): ?>
          <small>(owner: <?= htmlspecialchars((string)($c['username'] ?? '')) ?>)</small>
        <?php endif; ?>
      </li>
    <?php endforeach; ?>
  </ul>

  <!-- 🔽 ОТУТ ДОДАЄМО БЛОК SHARED -->
  <?php if ($role !== 'admin'): ?>
    <h2>Доступні мені</h2>

    <?php if (!empty($shared)): ?>
      <ul>
        <?php foreach ($shared as $c): ?>
          <li>
            <a href="/character.php?id=<?= (int)$c['id'] ?>">
              <?= htmlspecialchars((string)$c['name']) ?>
            </a>

            <span style="opacity:.75">
              — <?= ((int)($c['can_edit'] ?? 0) === 1) ? 'edit' : 'read-only' ?>
              · owner: <?= htmlspecialchars((string)($c['owner_username'] ?? '')) ?>
            </span>
          </li>
        <?php endforeach; ?>
      </ul>
    <?php else: ?>
      <p style="opacity:.75">Наразі немає персонажів, до яких вам видано доступ.</p>
    <?php endif; ?>
  <?php endif; ?>


</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\dashboard.php
MODIFIED: 2026-02-14 20:22:56 | SIZE: 969 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';

$user = require_login();
$isAdmin = (($user['role'] ?? '') === 'admin');
$who = $user['email'] ?? $user['username'] ?? 'user';
?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>Кабінет</title>
</head>
<body>

<?php require_once __DIR__ . '/inc/nav.php'; ?>

<h1>Кабінет</h1>
<p>Ви увійшли як: <b><?= htmlspecialchars($who) ?></b> (роль: <?= htmlspecialchars($user['role'] ?? '') ?>)</p>

<h2>Гравцю</h2>
<ul>
  <li><a href="/spells.php">Заклинання</a></li>
  <li><a href="/characters.php">Мої персонажі</a></li>
</ul>

<?php if ($isAdmin): ?>
  <h2>Адміну</h2>
  <ul>
    <li><a href="/admin_spells.php">Адмінка: Заклинання</a></li>
    <li><a href="/characters.php">Персонажі гравців</a></li>
  </ul>
<?php endif; ?>

</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\dump_site_dev.py
MODIFIED: 2026-02-14 19:24:45 | SIZE: 5415 bytes
======================================================================

import os
import sys
from datetime import datetime

# --- SKIP SETTINGS ---
SKIP_SUBSTR = "archive"
SKIP_DIRS = {"node_modules", "vendor", ".git", "__pycache__", ".idea", ".vscode"}

# --- WHAT TO DUMP (WEB CODE ONLY) ---
CODE_EXTS = {
    # backend
    ".php", ".phtml", ".java", ".py", ".rb",
    # frontend
    ".js", ".ts", ".jsx", ".tsx",
    ".css", ".scss", ".sass", ".less",
    ".html", ".htm",
    # data / config
    ".json", ".yml", ".yaml",
    ".xml", ".sql",
    ".env", ".ini", ".conf",
    ".htaccess",
    # scripts
    ".sh", ".bat"
}

MAX_BYTES = 1_048_576  # 1MB


def should_skip_dir(name: str) -> bool:
    return (
        SKIP_SUBSTR in name.lower()
        or name in SKIP_DIRS
    )


def relpath(path: str, root: str) -> str:
    r = os.path.relpath(path, root)
    return "." if r == "." else r.replace("\\", "/")


def safe_read_text(path: str) -> str:
    for enc in ("utf-8", "utf-8-sig", "cp1251"):
        try:
            with open(path, "r", encoding=enc, errors="strict") as f:
                return f.read()
        except Exception:
            pass
    with open(path, "r", encoding="utf-8", errors="replace") as f:
        return f.read()


def walk_dirs_files(root: str):
    for cur, dirs, files in os.walk(root):
        dirs[:] = [d for d in dirs if not should_skip_dir(d)]
        yield cur, dirs, files


def main():
    root = sys.argv[1] if len(sys.argv) > 1 else os.getcwd()
    root = os.path.abspath(root)

    if not os.path.isdir(root):
        print(f"ERROR: root not found: {root}")
        sys.exit(2)

    out_dir = os.path.dirname(os.path.abspath(__file__))
    tree_path = os.path.join(out_dir, "tree.txt")
    list_path = os.path.join(out_dir, "filelist.txt")
    cont_path = os.path.join(out_dir, "contents.txt")

    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    dirs_visited = 0
    files_listed = 0
    code_dumped = 0
    code_skipped_size = 0

    # --- TREE ---
    tree_lines = [
        f'ROOT: "{root}"',
        f"GENERATED: {now}",
        "",
        "====== DIRECTORY STRUCTURE ======",
        "",
        "[+] .",
    ]

    dir_paths = []
    for cur, dirs, _files in walk_dirs_files(root):
        dirs_visited += 1
        dir_paths.append(cur)

    for d in sorted(dir_paths):
        if d == root:
            continue
        rel = relpath(d, root)
        depth = rel.count("/")
        indent = "  " * depth
        name = rel.split("/")[-1]
        tree_lines.append(f"{indent}[+] {name}")

    tree_lines.append("")
    tree_lines.append("====== STATS ======")
    tree_lines.append(f"Directories visited: {dirs_visited}")

    with open(tree_path, "w", encoding="utf-8") as f:
        f.write("\n".join(tree_lines))

    # --- FILELIST + CONTENTS ---
    with open(list_path, "w", encoding="utf-8") as fl, open(cont_path, "w", encoding="utf-8") as fc:

        fl.write(f'ROOT: "{root}"\nGENERATED: {now}\n\n====== FILE LIST (per folder) ======\n')

        fc.write(
            f'ROOT: "{root}"\nGENERATED: {now}\n\n====== CODE CONTENTS ======\n'
            f"Included extensions: {' '.join(sorted(CODE_EXTS))}\n"
            f"Max file size: {MAX_BYTES} bytes\n"
        )

        for cur, _dirs, files in walk_dirs_files(root):
            rel_folder = relpath(cur, root)
            fl.write(f"\n--- {rel_folder} ---\n")

            for name in sorted(files):
                full = os.path.join(cur, name)

                try:
                    st = os.stat(full)
                except Exception:
                    continue

                files_listed += 1
                mtime = datetime.fromtimestamp(st.st_mtime).strftime("%Y-%m-%d %H:%M:%S")

                fl.write(f"{mtime} | {st.st_size} bytes | {relpath(full, root)}\n")

                ext = os.path.splitext(name)[1].lower()

                if ext in CODE_EXTS:

                    if st.st_size > MAX_BYTES:
                        code_skipped_size += 1
                        fc.write("\n" + "=" * 70 + "\n")
                        fc.write(f"FILE: {full}\n")
                        fc.write(f"(skipped: too large - {st.st_size} bytes, limit {MAX_BYTES})\n")
                        fc.write("=" * 70 + "\n")
                        continue

                    code_dumped += 1
                    fc.write("\n" + "=" * 70 + "\n")
                    fc.write(f"FILE: {full}\n")
                    fc.write(f"MODIFIED: {mtime} | SIZE: {st.st_size} bytes\n")
                    fc.write("=" * 70 + "\n\n")

                    try:
                        fc.write(safe_read_text(full))
                    except Exception as e:
                        fc.write(f"\n[ERROR reading file: {e}]\n")

                    fc.write("\n")

        fl.write("\n\n====== STATS ======\n")
        fl.write(f"Files listed: {files_listed}\n")

        fc.write("\n\n====== STATS ======\n")
        fc.write(f"Code files dumped: {code_dumped}\n")
        fc.write(f"Skipped by size: {code_skipped_size}\n")

    print("Done:")
    print(" -", tree_path)
    print(" -", list_path)
    print(" -", cont_path)
    print(f"Stats: dirs={dirs_visited} files={files_listed} dumped={code_dumped} skipped={code_skipped_size}")


if __name__ == "__main__":
    main()


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\index.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 207 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';

$u = current_user();

if ($u) {
  header('Location: /dashboard.php');
} else {
  header('Location: /login.php');
}
exit;


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\login.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 1310 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/db.php';
require_once __DIR__ . '/inc/auth.php';

start_session();
$err = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $username = trim((string)($_POST['username'] ?? ''));
  $pass     = (string)($_POST['password'] ?? '');

  $pdo = db();
  $stmt = $pdo->prepare(
    "SELECT id, username, password_hash, role FROM users WHERE username=? LIMIT 1"
  );
  $stmt->execute([$username]);
  $u = $stmt->fetch();

  if (!$u || !password_verify($pass, (string)$u['password_hash'])) {
    $err = 'Невірний username або пароль.';
  } else {
    login_user((int)$u['id'], (string)$u['username'], (string)$u['role']);
    header('Location: /dashboard.php');
    exit;
  }
}
?>
<!doctype html>
<html lang="uk">
<head><meta charset="utf-8"><title>Вхід</title></head>
<body>
<h1>Вхід</h1>
<?php if ($err): ?><p style="color:red"><?= htmlspecialchars($err) ?></p><?php endif; ?>

<form method="post">
  <label>Username<br><input name="username" required></label><br><br>
  <label>Пароль<br><input name="password" type="password" required></label><br><br>
  <button type="submit">Увійти</button>
</form>

<p><a href="/register.php">Реєстрація</a></p>
</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\logout.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 132 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
logout_user();
header('Location: /login.php');
exit;


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\register.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 1735 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/db.php';
require_once __DIR__ . '/inc/auth.php';

start_session();
$err = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $username = trim((string)($_POST['username'] ?? ''));
  $pass     = (string)($_POST['password'] ?? '');

  if (!preg_match('/^[a-zA-Z0-9_]{3,32}$/', $username)) {
    $err = 'Username: 3–32 символи, латиниця, цифри, _.';
  } elseif (mb_strlen($pass) < 8) {
    $err = 'Пароль має бути мінімум 8 символів.';
  } else {
    $pdo = db();
    $stmt = $pdo->prepare("SELECT id FROM users WHERE username=? LIMIT 1");
    $stmt->execute([$username]);
    if ($stmt->fetch()) {
      $err = 'Такий username вже існує.';
    } else {
      $hash = password_hash($pass, PASSWORD_DEFAULT);
      $stmt = $pdo->prepare(
        "INSERT INTO users (username, password_hash, role) VALUES (?, ?, 'user')"
      );
      $stmt->execute([$username, $hash]);
      $id = (int)$pdo->lastInsertId();
      login_user($id, $username, 'user');
      header('Location: /dashboard.php');
      exit;
    }
  }
}
?>
<!doctype html>
<html lang="uk">
<head><meta charset="utf-8"><title>Реєстрація</title></head>
<body>
<h1>Реєстрація</h1>
<?php if ($err): ?><p style="color:red"><?= htmlspecialchars($err) ?></p><?php endif; ?>

<form method="post">
  <label>Username<br><input name="username" required></label><br><br>
  <label>Пароль<br><input name="password" type="password" required></label><br><br>
  <button type="submit">Створити акаунт</button>
</form>

<p><a href="/login.php">Вхід</a></p>
</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\spell.php
MODIFIED: 2026-02-14 20:30:01 | SIZE: 2538 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

$user = require_login();

$slug = trim((string)($_GET['slug'] ?? ''));
if ($slug === '') { http_response_code(404); echo "Not found"; exit; }

$stmt = db()->prepare("SELECT * FROM spells WHERE slug=? AND is_published=1 LIMIT 1");
$stmt->execute([$slug]);
$s = $stmt->fetch();

if (!$s) { http_response_code(404); echo "Not found"; exit; }

function h(string $v): string { return htmlspecialchars($v, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8'); }
function br(string $v): string { return nl2br(h($v)); }

$hasOverride = trim((string)$s['override_text']) !== '';
?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title><?= h((string)$s['name']) ?></title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:1100px;margin:20px auto;padding:0 12px}
    .meta{opacity:.8;margin:6px 0 14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px}
    .card h2{margin:0 0 8px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;margin-left:6px;font-size:12px;opacity:.8}
    .warn{border-color:#f0c36d;background:#fff9e6}
    ul{margin:8px 0 0}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
<?php require_once __DIR__ . '/inc/nav.php'; ?>
<h1><?= h((string)$s['name']) ?></h1>
<div class="meta">
  <b>Level:</b> <?= (int)$s['level'] ?> |
  <b>School:</b> <?= h((string)$s['school']) ?> |
  <b>Casting:</b> <?= h((string)$s['casting_time']) ?> |
  <b>Range:</b> <?= h((string)$s['range_txt']) ?> |
  <b>Duration:</b> <?= h((string)$s['duration']) ?> |
  <b>Components:</b> <?= h((string)$s['components']) ?>
</div>

<div class="grid">
  <div class="card">
    <h2>Base <span class="pill"><?= h((string)($s['base_ref'] ?? '')) ?></span></h2>
    <div><?= br((string)$s['base_summary']) ?></div>
  </div>

  <div class="card <?= $hasOverride ? 'warn' : '' ?>">
    <h2>Campaign changes <?= $hasOverride ? '<span class="pill">changed</span>' : '<span class="pill">no changes</span>' ?></h2>
    <div><?= $hasOverride ? br((string)$s['override_text']) : '<span style="opacity:.75">Нема змін у цій кампанії.</span>' ?></div>
  </div>
</div>

<p style="margin-top:14px">
  <a href="/spells.php">← назад до списку</a> ·
</p>
</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\spells.php
MODIFIED: 2026-02-14 20:30:07 | SIZE: 5132 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/inc/auth.php';
require_once __DIR__ . '/inc/db.php';

$user = require_login();

$q      = trim((string)($_GET['q'] ?? ''));
$level  = trim((string)($_GET['level'] ?? ''));
$school = trim((string)($_GET['school'] ?? ''));
$sort   = trim((string)($_GET['sort'] ?? 'name')); // name|level|school
$dir    = strtolower(trim((string)($_GET['dir'] ?? 'asc'))); // asc|desc
$changedOnly = isset($_GET['changed']) && $_GET['changed'] === '1';

// валідація
$allowedSort = ['name', 'level', 'school'];
if (!in_array($sort, $allowedSort, true)) $sort = 'name';
if (!in_array($dir, ['asc','desc'], true)) $dir = 'asc';

// WHERE + params
$where  = "WHERE is_published=1";
$params = [];

if ($q !== '') {
  $where .= " AND name LIKE ?";
  $params[] = "%{$q}%";
}
if ($level !== '' && ctype_digit($level)) {
  $where .= " AND level = ?";
  $params[] = (int)$level;
}
if ($school !== '') {
  $where .= " AND school = ?";
  $params[] = $school;
}
if ($changedOnly) {
  $where .= " AND TRIM(COALESCE(override_text, '')) <> ''";
}

// колейшн для нормального алфавіту (укр)
$collate = " COLLATE utf8mb4_unicode_ci ";

// ORDER BY
if ($sort === 'name') {
  $order = "ORDER BY name{$collate} {$dir}";
} elseif ($sort === 'school') {
  $order = "ORDER BY school{$collate} {$dir}, name{$collate} asc";
} else { // level
  $order = "ORDER BY level {$dir}, name{$collate} asc";
}

// SELECT (беремо override_text і рахуємо has_override як в адмінці)
$sql = "SELECT
          slug,
          name,
          level,
          school,
          override_text
        FROM spells
        {$where}
        {$order}";

$stmt = db()->prepare($sql);
$stmt->execute($params);
$rows = $stmt->fetchAll();

// список шкіл (тільки опубліковані)
$schools = db()->query("
  SELECT DISTINCT school
  FROM spells
  WHERE is_published=1 AND school <> ''
  ORDER BY school COLLATE utf8mb4_unicode_ci
")->fetchAll();
?>
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>Заклинання</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:1000px;margin:20px auto;padding:0 12px}
    input,select,button{padding:6px 8px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .muted{opacity:.75}
    .badge{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:1px 7px;font-size:12px;opacity:.85;margin-left:6px}
    .warn{border-color:#f0c36d;background:#fff9e6}
    label.chk{display:flex;gap:6px;align-items:center}
  </style>
</head>
<body>
<?php require_once __DIR__ . '/inc/nav.php'; ?>
<h1>Заклинання</h1>

<form method="get" class="row">
  <input name="q" placeholder="пошук..." value="<?= htmlspecialchars($q) ?>">

  <select name="level">
    <option value="">будь-який рівень</option>
    <?php for ($i=0; $i<=9; $i++): ?>
      <option value="<?= $i ?>" <?= ($level===(string)$i ? 'selected' : '') ?>><?= $i ?></option>
    <?php endfor; ?>
  </select>

  <select name="school">
    <option value="">будь-яка школа</option>
    <?php foreach ($schools as $s): ?>
      <option value="<?= htmlspecialchars((string)$s['school']) ?>" <?= ($school===(string)$s['school'] ? 'selected' : '') ?>>
        <?= htmlspecialchars((string)$s['school']) ?>
      </option>
    <?php endforeach; ?>
  </select>

  <label class="chk">
    <input type="checkbox" name="changed" value="1" <?= $changedOnly ? 'checked' : '' ?>>
    тільки змінені
  </label>

  <select name="sort">
    <option value="name"   <?= ($sort==='name'?'selected':'') ?>>сортувати: назва</option>
    <option value="level"  <?= ($sort==='level'?'selected':'') ?>>сортувати: рівень</option>
    <option value="school" <?= ($sort==='school'?'selected':'') ?>>сортувати: школа</option>
  </select>

  <select name="dir">
    <option value="asc"  <?= ($dir==='asc'?'selected':'') ?>>↑</option>
    <option value="desc" <?= ($dir==='desc'?'selected':'') ?>>↓</option>
  </select>

  <button type="submit">Знайти</button>

  <?php if ($q!=='' || $level!=='' || $school!=='' || $changedOnly || $sort!=='name' || $dir!=='asc'): ?>
    <a class="muted" href="/spells.php">скинути</a>
  <?php endif; ?>
</form>

<p class="muted">Знайдено: <?= count($rows) ?></p>

<ul>
<?php foreach ($rows as $r): ?>
  <?php $modified = trim((string)($r['override_text'] ?? '')) !== ''; ?>
  <li>
    <a href="/spell.php?slug=<?= urlencode((string)$r['slug']) ?>">
      <?= htmlspecialchars((string)$r['name']) ?>
    </a>

    <?php if ($modified): ?>
      <span class="badge warn">changed</span>
    <?php endif; ?>

    <span class="muted">
      — lvl <?= (int)$r['level'] ?>, <?= htmlspecialchars((string)$r['school']) ?>
    </span>
  </li>
<?php endforeach; ?>
</ul>

</body>
</html>


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\api\character_get.php
MODIFIED: 2026-02-14 21:45:32 | SIZE: 5026 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/../inc/auth.php';
require_once __DIR__ . '/../inc/db.php';

require_login();
$user = current_user();
$uid  = (int)($user['id'] ?? 0);
$role = (string)($user['role'] ?? 'user');

header('Content-Type: application/json; charset=utf-8');

function json_fail(string $msg, int $code = 400): void {
  http_response_code($code);
  echo json_encode(['ok' => false, 'error' => $msg], JSON_UNESCAPED_UNICODE);
  exit;
}
function json_ok(array $payload): void {
  echo json_encode(array_merge(['ok' => true], $payload), JSON_UNESCAPED_UNICODE);
  exit;
}

$pdo = db();

$charId = 0;
if (isset($_GET['id']) && $_GET['id'] !== '') $charId = (int)$_GET['id'];
elseif (isset($_POST['id']) && $_POST['id'] !== '') $charId = (int)$_POST['id'];

if ($charId <= 0) json_fail('Missing id', 400);

// --- load character ---
$st = $pdo->prepare("SELECT * FROM characters WHERE id=?");
$st->execute([$charId]);
$ch = $st->fetch();
if (!$ch) json_fail('Not found', 404);

// --- access check ---
$canView = false;
$canEdit = false;

if ($role === 'admin') {
  $canView = true;
  $canEdit = true;
} elseif ((int)$ch['owner_user_id'] === $uid) {
  $canView = true;
  $canEdit = true;
} else {
  $accSt = $pdo->prepare("
    SELECT can_edit
    FROM character_access
    WHERE character_id=? AND user_id=?
    LIMIT 1
  ");
  $accSt->execute([$charId, $uid]);
  $acc = $accSt->fetch();
  if (!$acc) json_fail('Forbidden', 403);
  $canView = true;
  $canEdit = ((int)$acc['can_edit'] === 1);
}

// --- stats/resources/coins ---
$st2 = $pdo->prepare("SELECT * FROM character_stats WHERE character_id=?");
$st2->execute([$charId]);
$stats = $st2->fetch() ?: [];

$st3 = $pdo->prepare("SELECT * FROM character_resources WHERE character_id=?");
$st3->execute([$charId]);
$res = $st3->fetch() ?: [];

$st4 = $pdo->prepare("SELECT * FROM character_coins WHERE character_id=?");
$st4->execute([$charId]);
$coins = $st4->fetch() ?: [];

// --- lists ---
$invSt = $pdo->prepare("SELECT * FROM character_inventory WHERE character_id=? ORDER BY sort_order,id");
$invSt->execute([$charId]);
$inventory = $invSt->fetchAll();

$wpSt = $pdo->prepare("SELECT * FROM character_weapons WHERE character_id=? ORDER BY sort_order,id");
$wpSt->execute([$charId]);
$weapons = $wpSt->fetchAll();

$spSt = $pdo->prepare("SELECT * FROM character_spells WHERE character_id=? ORDER BY sort_order,id");
$spSt->execute([$charId]);
$spells = $spSt->fetchAll();

$abSt = $pdo->prepare("SELECT * FROM character_abilities WHERE character_id=? ORDER BY sort_order,id");
$abSt->execute([$charId]);
$abilities = $abSt->fetchAll();

// --- notes (optional table) ---
$notes = [
  'session_notes' => '',
  'quick_notes'   => '',
  'traits'        => '',
  'ideals'        => '',
  'bonds'         => '',
  'flaws'         => '',
  'backstory'     => '',
];

try {
  $ntSt = $pdo->prepare("
    SELECT session_notes, quick_notes, traits, ideals, bonds, flaws, backstory
    FROM character_notes
    WHERE character_id=?
    LIMIT 1
  ");
  $ntSt->execute([$charId]);
  $row = $ntSt->fetch();
  if ($row) {
    foreach ($notes as $k => $_) {
      if (array_key_exists($k, $row) && $row[$k] !== null) {
        $notes[$k] = (string)$row[$k];
      }
    }
  }
} catch (Throwable $e) {
  // якщо таблиці ще нема — ок
}

// --- shared access list for admin ---
$shared = [];
if ($role === 'admin') {
  $sSt = $pdo->prepare("
    SELECT a.user_id, a.can_edit, u.username
    FROM character_access a
    LEFT JOIN users u ON u.id=a.user_id
    WHERE a.character_id=?
    ORDER BY u.username
  ");
  $sSt->execute([$charId]);
  $shared = $sSt->fetchAll();
}

// --- normalize a few fields for front-end convenience ---
$out = [
  'id' => $charId,
  'access' => [
    'can_view' => $canView,
    'can_edit' => $canEdit,
    'role'     => $role,
  ],
  'character' => [
    'id'            => (int)($ch['id'] ?? 0),
    'owner_user_id' => (int)($ch['owner_user_id'] ?? 0),
    'name'          => (string)($ch['name'] ?? ''),
    'class_name'    => (string)($ch['class_name'] ?? ''),
    'level'         => (int)($ch['level'] ?? 1),
    'race'          => (string)($ch['race'] ?? ''),
    'alignment'     => (string)($ch['alignment'] ?? ''),
    'background'    => (string)($ch['background'] ?? ''),
    'xp'            => (string)($ch['xp'] ?? ''),
    'player_name'   => (string)($ch['player_name'] ?? ''),
    'avatar_url'    => $ch['avatar_url'],
    'avatar_data'   => $ch['avatar_data'],
    'created_at'    => $ch['created_at'] ?? null,
    'updated_at'    => $ch['updated_at'] ?? null,
  ],
  'resources' => $res,
  'stats'     => $stats,
  'coins'     => $coins,
  'inventory' => $inventory,
  'weapons'   => $weapons,
  'spells'    => $spells,
  'abilities' => $abilities,
  'notes'     => $notes,
  'shared'    => $shared,
];

json_ok($out);


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\api\character_save.php
MODIFIED: 2026-02-14 22:31:13 | SIZE: 3534 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/../inc/auth.php';
require_once __DIR__ . '/../inc/db.php';

header('Content-Type: application/json; charset=utf-8');

require_login();
$user = current_user();
$uid  = (int)($user['id'] ?? 0);
$role = (string)($user['role'] ?? 'user');

$charId = (int)($_POST['id'] ?? 0);
if ($charId <= 0) {
  http_response_code(400);
  echo json_encode(['ok'=>false,'error'=>'Missing id']);
  exit;
}

$st = db()->prepare("SELECT id, owner_user_id FROM characters WHERE id=?");
$st->execute([$charId]);
$ch = $st->fetch();
if (!$ch) {
  http_response_code(404);
  echo json_encode(['ok'=>false,'error'=>'Character not found']);
  exit;
}

$canEdit = false;
if ($role === 'admin' || (int)$ch['owner_user_id'] === $uid) {
  $canEdit = true;
} else {
  $acc = db()->prepare("SELECT can_edit FROM character_access WHERE character_id=? AND user_id=? LIMIT 1");
  $acc->execute([$charId, $uid]);
  $r = $acc->fetch();
  $canEdit = (bool)($r && (int)($r['can_edit'] ?? 0) === 1);
}

if (!$canEdit) {
  http_response_code(403);
  echo json_encode(['ok'=>false,'error'=>'Forbidden']);
  exit;
}

$skillsJson = (string)($_POST['skills_json'] ?? '{}');
$profsJson  = (string)($_POST['profs_json'] ?? '{}');

$skills = json_decode($skillsJson, true);
$profs  = json_decode($profsJson, true);

if (!is_array($skills)) $skills = [];
if (!is_array($profs))  $profs  = [];

$allowedSkillCodes = [
  'acrobatics','animal','arcana','athletics','deception','history','insight','intimidation','investigation',
  'medicine','nature','perception','performance','persuasion','religion','sleight','stealth','survival'
];

$allowedProfTypes = ['weapons','armor','tools','languages','vehicles'];

$db = db();
$db->beginTransaction();

try {
  // Skills: replace-all for character
  $db->prepare("DELETE FROM character_skills WHERE character_id=?")->execute([$charId]);

  $insSkill = $db->prepare("INSERT INTO character_skills (character_id, skill_code, proficiency_level, bonus_override)
                            VALUES (?,?,?,?)");
  foreach ($skills as $code => $row) {
    $code = trim((string)$code);
    if ($code === '' || !in_array($code, $allowedSkillCodes, true)) continue;

    $prof = 0;
    $ov = null;

    if (is_array($row)) {
      $prof = (int)($row['proficiency_level'] ?? 0);
      if ($prof < 0) $prof = 0;
      if ($prof > 2) $prof = 2;

      if (array_key_exists('bonus_override', $row) && $row['bonus_override'] !== null && $row['bonus_override'] !== '') {
        $ov = (int)$row['bonus_override'];
      }
    }

    $insSkill->execute([$charId, $code, $prof, $ov]);
  }

  // Profs: replace-all for character
  $db->prepare("DELETE FROM character_proficiencies WHERE character_id=?")->execute([$charId]);

  $insProf = $db->prepare("INSERT INTO character_proficiencies (character_id, prof_type, name)
                           VALUES (?,?,?)");

  foreach ($allowedProfTypes as $type) {
    if (!isset($profs[$type]) || !is_array($profs[$type])) continue;
    foreach ($profs[$type] as $name) {
      $name = trim((string)$name);
      if ($name === '') continue;
      if (mb_strlen($name) > 120) $name = mb_substr($name, 0, 120);
      $insProf->execute([$charId, $type, $name]);
    }
  }

  $db->commit();
  echo json_encode(['ok'=>true]);
} catch (Throwable $e) {
  $db->rollBack();
  http_response_code(500);
  echo json_encode(['ok'=>false,'error'=>'DB error']);
}


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\api\character_share.php
MODIFIED: 2026-02-14 20:41:14 | SIZE: 1146 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/../inc/auth.php';
require_once __DIR__ . '/../inc/db.php';

$user = require_admin();
$pdo = db();

$charId = (int)($_POST['character_id'] ?? 0);
$username = trim((string)($_POST['username'] ?? ''));
$canEdit = isset($_POST['can_edit']) ? 1 : 0;

if ($charId <= 0 || $username === '') {
  http_response_code(400);
  echo "Bad request";
  exit;
}

$st = $pdo->prepare("SELECT id FROM characters WHERE id=? LIMIT 1");
$st->execute([$charId]);
if (!$st->fetch()) {
  http_response_code(404);
  echo "Character not found";
  exit;
}

$st = $pdo->prepare("SELECT id FROM users WHERE username=? LIMIT 1");
$st->execute([$username]);
$u = $st->fetch();
if (!$u) {
  http_response_code(404);
  echo "User not found";
  exit;
}
$targetUserId = (int)$u['id'];

// upsert доступ
$st = $pdo->prepare("
  INSERT INTO character_access (character_id, user_id, can_edit)
  VALUES (?, ?, ?)
  ON DUPLICATE KEY UPDATE can_edit=VALUES(can_edit)
");
$st->execute([$charId, $targetUserId, $canEdit]);

header("Location: /character.php?id=" . $charId);
exit;


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\api\character_unshare.php
MODIFIED: 2026-02-14 20:41:27 | SIZE: 542 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/../inc/auth.php';
require_once __DIR__ . '/../inc/db.php';

$user = require_admin();
$pdo = db();

$charId = (int)($_POST['character_id'] ?? 0);
$userId = (int)($_POST['user_id'] ?? 0);

if ($charId <= 0 || $userId <= 0) {
  http_response_code(400);
  echo "Bad request";
  exit;
}

$st = $pdo->prepare("DELETE FROM character_access WHERE character_id=? AND user_id=?");
$st->execute([$charId, $userId]);

header("Location: /character.php?id=" . $charId);
exit;


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\inc\auth.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 1374 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/db.php';

function start_session(): void {
  if (session_status() === PHP_SESSION_ACTIVE) return;

  $cfg = require __DIR__ . '/config.php';
  session_name($cfg['app']['session_name'] ?? 'APPSESS');

  // на більшості хостингів HTTPS уже є — але хай буде без фанатизму
  $secure = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off');

  session_set_cookie_params([
    'lifetime' => 0,
    'path' => '/',
    'secure' => $secure,
    'httponly' => true,
    'samesite' => 'Lax',
  ]);

  session_start();
}

function current_user(): ?array {
  start_session();
  return $_SESSION['user'] ?? null;
}

function require_login(): array {
  $u = current_user();
  if (!$u) {
    header('Location: /login.php');
    exit;
  }
  return $u;
}

function require_admin(): array {
  $u = require_login();
  if (($u['role'] ?? '') !== 'admin') {
    http_response_code(403);
    echo "403 Forbidden";
    exit;
  }
  return $u;
}

function login_user(int $id, string $email, string $role): void {
  start_session();
  session_regenerate_id(true);
  $_SESSION['user'] = ['id' => $id, 'email' => $email, 'role' => $role];
}

function logout_user(): void {
  start_session();
  $_SESSION = [];
  session_destroy();
}


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\inc\char.css
MODIFIED: 2026-02-15 10:05:12 | SIZE: 9380 bytes
======================================================================

/* ================================
   BASE
================================ */

:root {
    --bg: #141418;
    --panel: #1d1e24;
    --panel-soft: #24252d;
    --border: #2f313a;
    --accent: #7c5cff;
    --accent-soft: #9d85ff;
    --text: #e6e6f0;
    --muted: #9a9aa8;
    --danger: #c94848;
    --radius: 14px;
  }
  
  * {
    box-sizing: border-box;
  }
  
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    line-height: 1.4;
  }
  
  h1,h2,h3 {
    margin: 0 0 12px 0;
    font-weight: 600;
  }
  
  h2 {
    font-size: 16px;
    letter-spacing: .5px;
    text-transform: uppercase;
    color: var(--muted);
  }
  
  a {
    color: var(--accent-soft);
    text-decoration: none;
  }
  
  a:hover {
    text-decoration: underline;
  }
  
  /* ================================
     TOPBAR
  ================================ */
  
  .topbar {
    position: sticky;
    top: 0;
    z-index: 20;
    background: linear-gradient(180deg, #1c1d23 0%, #181920 100%);
    border-bottom: 1px solid var(--border);
    padding: 14px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .topbar .brand {
    font-size: 18px;
    font-weight: 600;
  }
  
  .topbar .actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  .badge {
    background: #2b2c36;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    color: var(--muted);
  }
  
  /* ================================
     LAYOUT
  ================================ */
  
  .shell {
    display: grid;
    grid-template-columns: 280px 1fr 320px;
    gap: 20px;
    padding: 20px 24px 40px 24px;
  }
  
  @media (max-width: 1100px) {
    .shell {
      grid-template-columns: 1fr;
    }
  }
  
  /* ================================
     CARD
  ================================ */
  
  .card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
  }
  
  .cardBody {
    margin-top: 12px;
  }
  
  .collapsible h2 {
    cursor: pointer;
  }
  
  .collapsible.collapsed .cardBody {
    display: none;
  }
  
  /* ================================
     FORM ELEMENTS
  ================================ */
  
  label {
    display: block;
    margin-bottom: 10px;
    font-size: 13px;
    color: var(--muted);
  }
  
  input,
  select,
  textarea {
    width: 100%;
    background: var(--panel-soft);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 10px;
    color: var(--text);
    margin-top: 4px;
    font-size: 14px;
  }
  
  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--accent);
  }
  
  textarea {
    resize: vertical;
  }
  
  .numSmall {
    width: 80px;
  }
  
  button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
  }
  
  button.secondary {
    background: #2b2c36;
  }
  
  button:hover {
    opacity: .9;
  }
  
  /* ================================
     GRID HELPERS
  ================================ */
  
  .grid2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  
  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .row-inline {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  
  /* ================================
     STATS
  ================================ */
  
  .statsGridCompact {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }
  
  .statCell {
    background: var(--panel-soft);
    border-radius: 12px;
    padding: 10px;
    text-align: center;
  }
  
  .statKey {
    font-size: 12px;
    color: var(--muted);
    display: block;
    margin-bottom: 6px;
  }
  
  .statCell input {
    text-align: center;
  }
  
  .statMod {
    display: block;
    font-size: 11px;
    margin-top: 4px;
    color: var(--muted);
  }
  
  /* ================================
     COINS
  ================================ */
  
  .coinsPanel {
    background: var(--panel-soft);
    border-radius: 12px;
    padding: 12px;
  }
  
  .coinsGrid {
    display: flex;
    gap: 12px;
  }
  
  /* ================================
     READ ONLY MODE
  ================================ */
  
  form[aria-disabled="true"] {
    opacity: .8;
  }
  
  form[aria-disabled="true"] input,
  form[aria-disabled="true"] select,
  form[aria-disabled="true"] textarea {
    background: #1a1b21;
    color: #777;
    cursor: not-allowed;
  }

/* ================================
   SKILLS + PROFICIENCIES
================================ */

.smallBtn {
  background: #2b2c36;
  color: var(--text);
  border: 1px solid var(--border);
  padding: 6px 10px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 13px;
}

.smallBtn:hover { opacity: .9; }

.profBlock {
  background: var(--panel-soft);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px;
  margin-bottom: 10px;
}

.profHead {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
  color: var(--muted);
  font-size: 13px;
}

.tagList {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.tag {
  background: #2b2c36;
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 13px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.tag button {
  background: transparent;
  border: none;
  color: var(--muted);
  cursor: pointer;
  padding: 0;
}

.tag button:hover { color: var(--text); }

.skillRow {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  background: var(--panel-soft);
  border: 1px solid var(--border);
  border-radius: 12px;
  margin-bottom: 8px;
}

.skillName { color: var(--text); font-size: 14px; }
.skillMeta { color: var(--muted); font-size: 12px; }

/* ================================
   MISSING UI STYLES (used in character.php)
================================ */

.muted { color: var(--muted); }
.small { font-size: 12px; }

.hint {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 10px;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  border-radius: 10px;
  padding: 8px 14px;
  font-size: 14px;
  cursor: pointer;
  border: 1px solid transparent;
}

.btn.primary { background: var(--accent); color: #fff; }
.btn.secondary { background: #2b2c36; color: var(--text); border-color: var(--border); }
.btn.danger { background: var(--danger); color: #fff; }

.btn:disabled,
.smallBtn:disabled {
  opacity: .55;
  cursor: not-allowed;
}

.pill {
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  background: #2b2c36;
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 12px;
}

.tabs {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.tabs button {
  background: #2b2c36;
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 13px;
}

.tabs button.active {
  background: var(--accent);
  border-color: transparent;
  color: #fff;
}

.sectionTitle {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.avatarBox {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

.avatarPreview {
  width: 92px;
  height: 92px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: var(--panel-soft);
  display: grid;
  place-items: center;
  overflow: hidden;
}

.avatarPreview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.toast {
  position: fixed;
  right: 16px;
  bottom: 16px;
  background: #2b2c36;
  border: 1px solid var(--border);
  color: var(--text);
  padding: 10px 12px;
  border-radius: 12px;
  z-index: 999;
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
}
.collapsible .collapseToggle{
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.collapsible .collapseToggle::after{
  content:"▼";
  font-size:12px;
  opacity:.6;
  transition:.2s;
}

.collapsible.open .collapseToggle::after{
  transform:rotate(-180deg);
}
.collapsible .cardBody {
  display: none;
}

.collapsible.open .cardBody {
  display: block;
}

.collapseToggle {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}
.avatarContainer {
  width: 100%;
  max-width: 280px;      /* обмеження по ширині */
  border: 1px solid #ccc;
  cursor: pointer;
}

.avatarContainer img {
  width: 100%;
  height: auto;          /* ключове */
  display: block;
}


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\inc\config.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 288 bytes
======================================================================

<?php
declare(strict_types=1);

return [
  'db' => [
    'host' => 'localhost',
    'name' => 'u341552863_tabletop',
    'user' => 'u341552863_neruer',
    'pass' => '1trv|4NrX;',
    'charset' => 'utf8mb4',
  ],
  'app' => [
    'session_name' => 'CHARAPPSESS',
  ],
];



======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\inc\db.php
MODIFIED: 2026-02-07 19:26:50 | SIZE: 485 bytes
======================================================================

<?php
declare(strict_types=1);

function db(): PDO {
  static $pdo = null;
  if ($pdo) return $pdo;

  $cfg = require __DIR__ . '/config.php';
  $db = $cfg['db'];

  $dsn = "mysql:host={$db['host']};dbname={$db['name']};charset={$db['charset']}";
  $pdo = new PDO($dsn, $db['user'], $db['pass'], [
    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    PDO::ATTR_EMULATE_PREPARES => false,
  ]);

  return $pdo;
}


======================================================================
FILE: D:\Projects\games\site-fondry\tabletops_3\inc\nav.php
MODIFIED: 2026-02-14 20:49:29 | SIZE: 1001 bytes
======================================================================

<?php
declare(strict_types=1);

require_once __DIR__ . '/auth.php';

// якщо сторінка не передала $user — візьмемо з сесії або проженемо через require_login()
if (!isset($user) || !is_array($user)) {
  $user = current_user();
  if (!$user) $user = require_login();
}

$isAdmin = (($user['role'] ?? '') === 'admin');
?>
<nav style="display:flex; gap:12px; align-items:center; margin:12px 0;">
  <a href="/dashboard.php">Кабінет</a>
  <a href="/characters.php"><?= $isAdmin ? 'Персонажі гравців' : 'Мої персонажі' ?></a>
  <a href="/spells.php">Заклинання</a>

  <?php if ($isAdmin): ?>
    <a href="/admin_spells.php">Адмінка: заклинання</a>
  <?php endif; ?>

  <span style="margin-left:auto; opacity:.75;">
    <?= htmlspecialchars((string)($user['email'] ?? $user['username'] ?? 'user')) ?>
  </span>
  <a href="/logout.php">Вийти</a>
</nav>
<hr>




====== STATS ======
Code files dumped: 22
Skipped by size: 0
